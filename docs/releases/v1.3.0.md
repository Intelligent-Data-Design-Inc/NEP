# NEP v1.3.0 - CDF Support

> Adds NASA CDF file format support through a User Defined Format (UDF) handler, enabling transparent access to CDF files via the standard NetCDF API.

---

## Highlights

- **CDF UDF Handler**: Complete implementation of CDF file format support via NetCDF UDF mechanism
- **NASA CDF Integration**: Full integration with NASA CDF library v3.9.x for reading CDF files
- **Transparent API Access**: Open and read CDF files using standard NetCDF API calls (nc_open, nc_inq, nc_get_var)
- **Attribute Name Mapping**: Automatic conversion of CDF FILLVAL attributes to NetCDF _FillValue convention
- **Build System Support**: Optional CDF support in both CMake and Autotools with clear enable/disable options
- **CI Validation**: Comprehensive CI testing with NASA IMAP MAG L1B calibration data

---

## Features

### CDF UDF Handler (`src/cdffile.c`, `src/cdfdispatch.c`)

- **File Operations**: Complete NC_CDF_open() and NC_CDF_close() implementation with proper resource management
- **Metadata Mapping**: Full mapping of CDF structures to NetCDF internal metadata:
  - CDF zVariables mapped to NetCDF variables with record dimensions
  - CDF attributes mapped to NetCDF attributes (global and variable-scoped)
  - CDF data types converted to NetCDF types (CDF_INT4→NC_INT, CDF_REAL8→NC_DOUBLE, CDF_TIME_TT2000→NC_INT64, etc.)
- **Attribute Conventions**: FILLVAL attributes automatically renamed to _FillValue for NetCDF compatibility
- **Data Reading**: Basic data access via NC_CDF_get_vara() supporting scalars and multi-dimensional arrays
- **Error Handling**: CDF error codes mapped to appropriate NetCDF error codes without message printing

### Type System (`src/cdffile.c`)

- **Type Mapping Function**: cdf_type_info() maps all common CDF types to NetCDF equivalents
- **Endianness Detection**: Automatic detection and handling of CDF data endianness
- **Type Size Calculation**: Correct type sizes for all mapped CDF types
- **TT2000 Support**: CDF_TIME_TT2000 epoch values mapped to NC_INT64 for time variables

### Test Coverage (`test/tst_cdf_udf.c`, `test/tst_imap_mag.c`)

- **Basic CDF Test**: tst_cdf_udf validates simple CDF file access via NetCDF API
- **IMAP MAG Test**: Comprehensive validation using NASA IMAP MAG L1B calibration data
  - 6 variables (2 TT2000 time, 4 double arrays)
  - 24 global attributes
  - 9 variable attributes per variable
  - Data reading and validation for all variables
  - Attribute value verification

---

## API Changes

### New UDF Handler

- **CDF Dispatch Table**: NC_Dispatch structure for CDF files registered via nc_def_user_format()
- **Magic Number Detection**: CDF files identified by magic bytes (0xCDF30001 or 0xCDF26002)
- **Initialization**: NC_CDF_initialize() function for UDF handler registration

### NetCDF API Extensions

No changes to public NetCDF API. CDF files accessed through existing NetCDF functions:
- `nc_open()` - Opens CDF files when UDF handler registered
- `nc_inq()` - Queries CDF file metadata
- `nc_get_var()` - Reads CDF variable data
- `nc_get_att()` - Reads CDF attributes

---

## Build System

### CMake

- **CDF Option**: `-DENABLE_CDF=ON/OFF` (default: OFF)
- **Library Detection**: find_library() locates NASA CDF library and headers
- **UDF Library**: libnccdf.so built when CDF enabled
- **Dependencies**: Links against HDF5, NetCDF-C, and NASA CDF library
- **Configuration**: HAVE_CDF macro defined in config.h when enabled

### Autotools

- **CDF Option**: `--enable-cdf/--disable-cdf` (default: disabled)
- **Library Detection**: AC_CHECK_HEADERS([cdf.h]) + AC_SEARCH_LIBS([CDFopen], [cdf])
- **UDF Library**: libnccdf.la built when CDF enabled
- **Dependencies**: Links via $(HDF5_LIBS) $(NETCDF_LIBS) $(CDF_LIBS)
- **Configuration**: HAVE_CDF conditional and macro

### CI Integration

- **NASA CDF Build**: CDF library v3.9.x built from source in CI with caching
- **Installation Path**: $GITHUB_WORKSPACE/cdf-install
- **Environment Setup**: LD_LIBRARY_PATH, CPPFLAGS, LDFLAGS, CMAKE_PREFIX_PATH configured
- **Test Execution**: Both tst_cdf_udf and tst_imap_mag run in CDF-enabled builds

---

## Testing

### Test Programs

- **tst_cdf_udf**: Basic CDF file open/close and metadata validation
- **tst_imap_mag**: Comprehensive test with NASA IMAP MAG L1B calibration data
  - Validates 12 dimensions, 6 variables, 24 global attributes
  - Verifies attribute name mapping (FILLVAL → _FillValue)
  - Reads and validates data from all variables
  - Tests TT2000 time variables and double arrays

### Test Data

- **Simple CDF**: test/data/tst_cdf_simple.cdf for basic validation
- **IMAP MAG**: test/data/imap_mag_l1b-calibration_20240229_v001.cdf for comprehensive testing
- **Data Copying**: Test files copied to build directory for both CMake and Autotools

### Coverage

- File open/close operations
- Metadata reading (dimensions, variables, attributes)
- Type mapping (all common CDF types)
- Data reading (scalars and arrays)
- Attribute name conventions (_FillValue mapping)
- Error handling and resource cleanup

---

## Documentation

- **Doxygen Comments**: All CDF UDF functions documented with parameter descriptions and return values
- **Build Options**: CDF configuration options documented in README.md
- **Code Attribution**: All source files updated with consistent author (Edward Hartnett), date (2025-11-23), and copyright (Intelligent Data Design, Inc.)
- **Implementation Notes**: Sprint plans document detailed implementation approach and technical decisions

---

## Dependencies Added

- **NASA CDF Library v3.9.x**: Required when ENABLE_CDF=ON
  - Source: https://spdf.gsfc.nasa.gov/pub/software/cdf/dist/latest/
  - Purpose: Reading CDF file format
  - License: NASA Open Source Agreement

---

## Known Limitations

- **Read-Only Access**: CDF files can only be opened in read-only mode (NC_NOWRITE)
- **zVariables Only**: Only CDF zVariables are supported; rVariables are not implemented
- **Record Dimensions**: All CDF variables mapped with implicit record dimension as first dimension
- **Basic Data Access**: Advanced features like variable subsetting and striding use basic implementation
- **No Write Support**: Creating or modifying CDF files not supported

---

## Breaking Changes

None. NEP v1.3.0 introduces no breaking changes to existing APIs or build configurations. CDF support is optional and disabled by default.

---

## Release Summary

- **Released**: TBD
- **Scope**: v1.3.0 CDF Support (Sprints 1-4: CI integration, test program, UDF library, file operations)
- **Team Notes**: This release adds complete CDF file format support through the NetCDF UDF mechanism, enabling transparent access to NASA CDF files. The implementation follows established patterns from GRIB2 and provides a solid foundation for additional format handlers in future releases.
