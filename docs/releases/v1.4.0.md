# NEP v1.4.0 - Spack Support

> Adds Spack package manager support for NEP and NASA CDF library, enabling simplified installation and dependency management in HPC environments.

---

## Highlights

- **Spack Package for NEP**: Complete Spack package recipe with CMake build system, Fortran variant, and compression options
- **Spack Package for CDF**: New Spack package for NASA CDF library v3.9.1 with custom Makefile build system
- **Dedicated CI Workflows**: Separate GitHub Actions workflows for testing both NEP and CDF Spack packages
- **Repository Submissions**: Both packages submitted to spack/spack-packages repository for community access
- **HPC-Ready Installation**: One-command installation with automatic dependency resolution for HPC environments

---

## Features

### NEP Spack Package (`spack/NEP/package.py`)

- **CMake-Only Build**: Simplified package inheriting from CMakePackage (Autotools removed from Spack recipe)
- **Fortran Variant**: `+fortran/-fortran` variant for optional NetCDF-Fortran wrapper support (default: enabled)
- **Compression Variants**: `+lz4/-lz4` and `+bzip2/-bzip2` for compression filter selection
- **Documentation Variant**: `+docs/-docs` for optional Doxygen documentation generation
- **Dependency Management**: Automatic resolution of NetCDF-C, HDF5, LZ4, BZIP2, and NetCDF-Fortran dependencies
- **Version Support**: Package supports develop branch and future tagged releases

### CDF Spack Package (`spack/cdf/package.py`)

- **MakefilePackage Implementation**: Custom build system handling CDF's non-standard Makefile
- **Version 3.9.1**: SHA256-verified tarball from NASA SPDF distribution site
- **Build System Override**: Custom `build()` and `install()` methods with `OS=linux ENV=gnu` parameters
- **Explicit URL**: Version-specific URL to pass Spack CI verification for non-standard naming scheme
- **No Dependencies**: Standalone package requiring only system compiler
- **License**: NASA-1.3 license identifier

### Spack CI Workflows

#### NEP Workflow (`.github/workflows/spack.yml`)

- **Lint Job**: Style checks with `spack style` (isort, black) and `spack audit packages`
- **Spec Job**: Package concretization validation with dependency tree display
- **Install Job**: Full installation test with verbose output on pushes to main
- **Local Repository**: Creates temporary Spack repository for testing NEP package
- **System Compilers**: Uses Ubuntu system GCC/Gfortran for faster CI execution

#### CDF Workflow (`.github/workflows/spack-cdf.yml`)

- **Lint Job**: Style and audit validation for CDF package
- **Spec Job**: Concretization check for CDF package
- **Install Job**: Installation test with detailed logging
- **Independent Testing**: Separate workflow allows isolated CDF package validation
- **Build Verification**: Validates custom Makefile build system integration

---

## Build System

### Spack Package Structure

- **NEP Package Location**: `spack/NEP/package.py`
- **CDF Package Location**: `spack/cdf/package.py`
- **Repository Format**: Follows Spack v2.0 API with `spack_repo.builtin.build_systems` imports
- **Maintainer**: edhartnett listed as package maintainer

### Installation Commands

```bash
# Install NEP with all features
spack install nep

# Install NEP with minimal features
spack install nep~docs~fortran

# Install CDF library
spack install cdf

# Load packages
spack load nep
spack load cdf
```

---

## Testing

### CI Testing Strategy

- **Two-Tier Approach**: Lint checks on all PRs, full installation on main branch pushes
- **Style Validation**: F405 warnings (star imports) expected and acceptable for Spack packages
- **Audit Checks**: `spack audit packages` validates package metadata and dependencies
- **Concretization**: `spack spec` verifies dependency resolution before installation
- **Installation**: `spack install -v` performs full build with verbose logging

### Test Coverage

- NEP package builds successfully with system compilers on Ubuntu
- CDF package builds with custom Makefile parameters
- Dependency resolution works for all variant combinations
- Package metadata passes Spack audit requirements
- Style checks pass for both packages (with expected F405 warnings)

---

## Documentation

- **Spack Guide**: `docs/spack.md` updated with installation instructions for both packages
- **Package Status**: Documentation includes PR submission status for both packages
- **Development Section**: Added package locations and CI workflow information
- **CDF Integration**: Documented CDF as separate package with future NEP integration plans
- **Roadmap Updates**: Sprint 2 marked complete with all deliverables checked off

---

## Dependencies Added

None. This release adds Spack package recipes but does not change NEP's runtime dependencies. The Spack packages manage existing dependencies (NetCDF-C, HDF5, etc.) automatically.

---

## Known Limitations

- **CDF Variant Removed**: NEP's `+cdf` variant temporarily removed until CDF package accepted into Spack
- **CMake Only**: Spack package supports only CMake build system (Autotools users build from source)
- **Linux Only**: CDF package currently targets Linux (OS=linux parameter hardcoded)
- **Pending Approval**: Both packages submitted to spack/spack-packages but awaiting maintainer review

---

## Breaking Changes

None. NEP v1.4.0 introduces no breaking changes to NEP's APIs or build systems. Spack support is an additional installation method that does not affect existing build workflows.

---

## Release Summary

- **Released**: 2025-12-16
- **Scope**: v1.4.0 Spack Support (Sprint 1: NEP Spack CI and integration, Sprint 2: CDF Spack package)
- **Team Notes**: This release enables HPC-friendly installation through Spack package manager. Both NEP and CDF packages submitted to spack/spack-packages repository with comprehensive CI testing. Once packages are accepted, users can install NEP and its dependencies with a single command.
