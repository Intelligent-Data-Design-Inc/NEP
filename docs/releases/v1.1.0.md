# NEP v1.1.0 Release Notes

**Release Date**: TBD  
**Focus**: Fortran Wrappers for Compression Filters

---

## Overview

NEP v1.1.0 adds Fortran 90 wrappers for the existing compression filters introduced in v1.0.0, enabling Fortran applications to use BZIP2 and LZ4 compression transparently through the NetCDF Fortran API. Both CMake and Autotools build systems have been extended so Fortran support can be cleanly enabled or disabled without impacting C-only workflows.

---

## Highlights

- **Fortran Compression Wrappers**: New `nf90_*` Fortran interfaces for BZIP2 and LZ4 compression and inquiry.
- **Dual Build System Integration**: Fortran wrappers fully integrated into both CMake and Autotools builds.
- **Configurable Fortran Support**: Simple on/off switches (`ENABLE_FORTRAN` / `--enable-fortran`) for all Fortran code and tests.
- **CI Matrix Coverage**: GitHub Actions CI updated to exercise C and Fortran builds under multiple compression configurations.
- **Consistent Feature Flags**: Unified `BUILD_LZ4` and `BUILD_BZIP2` flags passed through to both C and Fortran compilation.

---

## Features

### Fortran Compression Wrappers

- **BZIP2 Fortran API** (module `ncsqueeze` in `fsrc/ncsqueeze.F90`):
  - `nf90_def_var_bzip2(ncid, varid, level)` to enable BZIP2 compression on a variable.
  - `nf90_inq_var_bzip2(ncid, varid, bzip2p, levelp)` to query whether BZIP2 is in use and its level.
  - Fortran interfaces call directly into the existing C functions `nc_def_var_bzip2` and `nc_inq_var_bzip2`.
  - Available only when `BUILD_BZIP2` is enabled (guarded with `#if BUILD_BZIP2`).

- **LZ4 Fortran API** (module `ncsqueeze` in `fsrc/ncsqueeze.F90`):
  - `nf90_def_var_lz4(ncid, varid, level)` to enable LZ4 compression with acceleration parameter.
  - `nf90_inq_var_lz4(ncid, varid, lz4p, levelp)` to query LZ4 usage and acceleration.
  - Interfaces call the existing C functions `nc_def_var_lz4` and `nc_inq_var_lz4`.
  - Available only when `BUILD_LZ4` is enabled (guarded with `#if BUILD_LZ4`).

### Fortran Test Suite

- **New Fortran tests in `ftest/`:**
  - `ftst_ncsqueeze_bzip2.F90` validates the Fortran BZIP2 wrappers for definition and inquiry.
  - `ftst_ncsqueeze_lz4.F90` validates the Fortran LZ4 wrappers.
- **Test runner scripts:**
  - `ftest/run_tests.sh.in` runs the Fortran tests conditionally based on `@BUILD_BZIP2@` and `@BUILD_LZ4@`, and configures `HDF5_PLUGIN_PATH` for the filter plugins.

---

## API Changes

- **New Fortran interfaces** (module `ncsqueeze`):
  - `nf90_def_var_bzip2`, `nf90_inq_var_bzip2` (BZIP2)
  - `nf90_def_var_lz4`, `nf90_inq_var_lz4` (LZ4)
- **Behavior:**
  - These wrappers are thin layers over the existing C compression APIs and do not change the C API behavior.
  - When the corresponding compression feature is disabled (`BUILD_BZIP2=0` or `BUILD_LZ4=0`), the Fortran interfaces are not compiled, avoiding undefined references in builds without those filters.

---

## Build System

### CMake

- **Fortran enable/disable:**
  - Option `ENABLE_FORTRAN` (default: ON) controls whether the Fortran library and tests are built.
  - When `ENABLE_FORTRAN=ON`, the Fortran language is enabled and `fsrc/` is added as a subdirectory.

- **Compression feature flags:**
  - New options:
    - `BUILD_LZ4` (default: ON)
    - `BUILD_BZIP2` (default: ON)
  - These are passed to the Fortran target `ncsqueezef` via `target_compile_definitions` as numeric macros:
    - `BUILD_LZ4=1/0`, `BUILD_BZIP2=1/0`.

### Autotools

- **Fortran enable/disable:**
  - `configure` option `--enable-fortran/--disable-fortran` controls Fortran wrappers and tests.
  - When disabled, Fortran libraries (`fsrc/`) and tests (`ftest/`) are not built or installed.

- **Compression feature flags:**
  - Existing options `--enable-bzip2/--disable-bzip2` and `--enable-lz4/--disable-lz4` continue to control filter support.
  - New numeric flags exported from `configure.ac`:
    - `BUILD_BZIP2_DEF` and `BUILD_LZ4_DEF` are set to `1` or `0` based on the configure options.
  - These are passed into Fortran compilation via `AM_FCFLAGS`:

    - `fsrc/Makefile.am` and `ftest/Makefile.am` add:
      - `-DBUILD_LZ4=$(BUILD_LZ4_DEF)`
      - `-DBUILD_BZIP2=$(BUILD_BZIP2_DEF)`

- **Conditional Fortran test builds:**
  - `ftest/Makefile.am` now only builds:
    - `ftst_ncsqueeze_bzip2` when `BUILD_BZIP2` is true.
    - `ftst_ncsqueeze_lz4` when `BUILD_LZ4` is true.
  - This prevents compilation of bzip2 tests in `--disable-bzip2` configurations and lz4 tests in `--disable-lz4` configurations.

---

## Testing

- **Fortran tests:**
  - Autotools `make check` in `ftest/` runs `ftest/run_tests.sh`, which:
    - Executes BZIP2 Fortran tests only when `@BUILD_BZIP2@ = "yes"`.
    - Executes LZ4 Fortran tests only when `@BUILD_LZ4@ = "yes"`.
  - Tests validate both definition and inquiry paths for each compression filter.

- **CI integration:**
  - GitHub Actions matrix updated to include Fortran on/off and compression combinations (`all`, `no-bzip2`, `no-lz4`).
  - Autotools and CMake paths use the same HDF5 and NetCDF installations to run C and Fortran tests consistently.

---

## Documentation

- **Developer documentation:**
  - Internal design notes updated to describe the Fortran wrapper module layout (`fsrc/`) and test layout (`ftest/`).
  - Build options for Fortran wrappers are documented alongside existing compression options.

- **API references:**
  - Doxygen comments for new C and Fortran functions ensure they appear in generated documentation.

---

## Dependencies Added

No new external dependencies compared to v1.0.0. This release reuses the existing stack:

- NetCDF-C (v4.9+)
- NetCDF-Fortran (v4.5.4+)
- HDF5 (v1.14.6 used in CI)
- LZ4, BZIP2, and LZF libraries

---

## Known Limitations

- Fortran wrappers currently target the compression filters only (BZIP2 and LZ4); future releases may extend wrappers to other filters or UDF handlers.
- Fortran tests rely on the same HDF5 plugin paths and environment configuration as the C tests; misconfigured `HDF5_PLUGIN_PATH` will impact both.

---

## Breaking Changes

- None. All changes are additive and backward compatible with existing v1.0.0 C APIs and workflows.

---

## Release Summary

- **Released**: TBD  
- **Scope**: v1.1.0 Fortran Wrappers sprint (compression functions)  
- **Team Notes**: This release makes NEP compression filters directly usable from Fortran codes while preserving the stability of the v1.0.0 C API and build pipeline, and prepares the project for future UDF handler enhancements in v2.0.0 and beyond.
