# v1.3.0 Sprint 1 Implementation Plan

## Overview
- **Goal**: Add NASA CDF library detection to both CMake and Autotools build systems
- **Sprint**: v1.3.0, Sprint 1
- **Primary Deliverables**:
  - NASA CDF library v3.9.x integrated into CI with caching
  - CMake and Autotools build system support for optional CDF library detection (default OFF)
  - Configuration file updates with HAVE_CDF macro
  - CI validates CDF detection in both CMake and Autotools builds
  - No UDF implementation - only library detection in this sprint

## Prerequisites
- v1.2.0 documentation improvements complete
- CI workflow functional with existing dependencies (HDF5, NetCDF-C, NetCDF-Fortran)
- Build systems support optional dependencies (pattern established with GRIB2, Fortran)

## Phase 1: NASA CDF Library CI Integration

### Task 1.1: Add CDF Build Step to CI Workflow
- **File paths**:
  - `.github/workflows/ci.yml`
- **Requirements**:
  - Add cache step for CDF build artifacts (key: `cdf-3.9.x-${{ runner.os }}`)
  - Add build step to download and build NASA CDF library from https://spdf.gsfc.nasa.gov/pub/software/cdf/dist/latest/
  - Install to `$GITHUB_WORKSPACE/cdf-install`
  - Build with shared libraries enabled
  - Mirror HDF5/NetCDF-C build pattern for consistency
- **Acceptance criteria**:
  - CDF library builds successfully in CI
  - Build artifacts cached for subsequent runs
  - Installation directory contains headers and libraries

### Task 1.2: Configure CDF Environment Variables
- **File paths**:
  - `.github/workflows/ci.yml`
- **Requirements**:
  - Add CDF paths to global LD_LIBRARY_PATH: `$GITHUB_WORKSPACE/cdf-install/lib`
  - Add CDF include path to CPPFLAGS: `-I$GITHUB_WORKSPACE/cdf-install/include`
  - Add CDF library path to LDFLAGS: `-L$GITHUB_WORKSPACE/cdf-install/lib`
  - Add CDF installation to CMAKE_PREFIX_PATH
  - Apply to all build steps that use CDF
- **Acceptance criteria**:
  - Environment variables set correctly in CI
  - CDF headers and libraries discoverable by build systems

### Task 1.3: Add CDF-Enabled Build Configurations
- **File paths**:
  - `.github/workflows/ci.yml`
- **Requirements**:
  - Add CDF-enabled builds for both CMake and Autotools
  - CMake: Add configuration with `-DENABLE_CDF=ON` (e.g., fortran=on, compression=all)
  - Autotools: Add configuration with `--enable-cdf` (e.g., fortran=on, compression=all)
  - Keep other matrix configurations with CDF disabled (default OFF)
  - CDF build step runs for all configurations (library available for testing)
- **Acceptance criteria**:
  - CMake build with CDF enabled passes and detects library
  - Autotools build with CDF enabled passes and detects library
  - Builds with CDF disabled succeed without attempting detection
  - CI execution time increase is minimal (<5 minutes)

## Phase 2: CMake Build System Integration

### Task 2.1: Add CDF Option to CMakeLists.txt
- **File paths**:
  - `CMakeLists.txt`
- **Requirements**:
  - Add `option(ENABLE_CDF "Enable CDF support" OFF)` (default OFF for v1.3.0)
  - Add conditional CDF dependency checking when ENABLE_CDF=ON
  - Use find_library to locate CDF library
  - Check for cdf.h header file
  - Set HAVE_CDF variable when found
  - Error with clear message if enabled but not found
- **Acceptance criteria**:
  - CMake configure succeeds with `-DENABLE_CDF=ON` when CDF installed
  - CMake configure succeeds with `-DENABLE_CDF=OFF` (default)
  - Clear error message when enabled but CDF not found

### Task 2.2: Update CMake Configuration Files
- **File paths**:
  - `config.h.cmake.in`
  - `NEPConfig.cmake.in`
- **Requirements**:
  - Add `#cmakedefine HAVE_CDF` to config.h.cmake.in
  - Add CDF component to NEPConfig.cmake.in when enabled
  - Set NEP_HAVE_CDF variable in config
  - Document CDF as optional dependency
- **Acceptance criteria**:
  - HAVE_CDF macro defined when CDF enabled and found
  - NEPConfig.cmake.in exports CDF status correctly

## Phase 3: Autotools Build System Integration

### Task 3.1: Add CDF Configure Option
- **File paths**:
  - `configure.ac`
- **Requirements**:
  - Add `AC_ARG_ENABLE([cdf], ...)` with default disabled for v1.3.0
  - Add conditional CDF dependency checking when enabled
  - Use AC_CHECK_HEADERS([cdf.h]) to find header
  - Use AC_SEARCH_LIBS([CDFopen], [cdf]) to find library
  - Set HAVE_CDF=yes when both found
  - Error with clear message if enabled but not found
  - Add AM_CONDITIONAL([HAVE_CDF], [test "x$HAVE_CDF" = "xyes"])
- **Acceptance criteria**:
  - `./configure --enable-cdf` succeeds when CDF installed
  - `./configure --disable-cdf` succeeds (default)
  - Clear error message when enabled but CDF not found

### Task 3.2: Update Autotools Configuration Files
- **File paths**:
  - `config.h.in`
  - `nep_config.h.in`
- **Requirements**:
  - Add `#undef HAVE_CDF` to config.h.in
  - Add HAVE_CDF macro to nep_config.h.in
  - Ensure macro defined when CDF enabled and found
- **Acceptance criteria**:
  - HAVE_CDF macro available in source code when enabled
  - Macro undefined when disabled

## Phase 4: Documentation

### Task 4.1: Update Build Documentation
- **File paths**:
  - `README.md`
  - `docs/build-options.md` (if exists)
- **Requirements**:
  - Document `-DENABLE_CDF=ON/OFF` CMake option (default OFF)
  - Document `--enable-cdf/--disable-cdf` Autotools option (default disabled)
  - Note that v1.3.0 Sprint 1 only adds library detection, no UDF yet
  - List CDF as optional dependency
  - Provide NASA CDF library download URL
- **Acceptance criteria**:
  - Build options documented clearly
  - Users understand CDF is detection-only in Sprint 1

## Phase 5: Validation

### Task 5.1: Validate Both Build Systems
- **Requirements**:
  - Test CMake build with CDF enabled and disabled
  - Test Autotools build with CDF enabled and disabled
  - Verify HAVE_CDF macro set correctly in both cases
  - Confirm no build errors in either configuration
  - Validate CI passes with both CDF-enabled configurations
- **Acceptance criteria**:
  - All four configurations build successfully (2 systems × 2 CDF states)
  - CI passes with both CMake and Autotools CDF-enabled builds
  - HAVE_CDF macro correctly defined when enabled
  - No warnings or errors related to CDF

## Definition of Done
- NASA CDF library v3.9.x builds and caches in CI
- CMake supports `-DENABLE_CDF=ON/OFF` (default OFF) with library detection
- Autotools supports `--enable-cdf/--disable-cdf` (default disabled) with library detection
- HAVE_CDF macro defined in config headers when CDF enabled and found
- CI validates CDF detection in both CMake and Autotools builds
- Build documentation updated with CDF options
- All builds pass (2 systems × 2 CDF states = 4 configurations)
- No UDF implementation - library detection only

## Technical Notes (Quick Reference)
- **CDF Library Version**: 3.9.x from https://spdf.gsfc.nasa.gov/pub/software/cdf/dist/latest/
- **CI Installation Path**: `$GITHUB_WORKSPACE/cdf-install`
- **CMake Option**: `-DENABLE_CDF=ON/OFF` (default: OFF)
- **Autotools Option**: `--enable-cdf/--disable-cdf` (default: disabled)
- **Config Macro**: `HAVE_CDF`
- **Scope**: Library detection only, no UDF implementation in Sprint 1
- **Detection Pattern**: Mirrors GRIB2 (AC_CHECK_HEADERS + AC_SEARCH_LIBS / find_library)

## Risk Assessment
- **CDF Build Complexity**:
  - Risk: NASA CDF library may have complex build requirements or dependencies
  - Mitigation: Test CDF build locally before CI integration; use standard configure/make pattern
- **CI Cache Size**:
  - Risk: Adding CDF build artifacts increases cache storage
  - Mitigation: CDF library is relatively small; cache only built artifacts, not source
- **Build Matrix Expansion**:
  - Risk: Adding CDF to matrix could significantly increase CI time
  - Mitigation: Only one configuration with CDF enabled; others use default OFF
- **Test Data Licensing**:
  - Risk: CDF test data may have usage restrictions
  - Mitigation: Use publicly available NASA SPDF data; document source and any restrictions

## Success Metrics
- CI build time increase <5 minutes for CDF-enabled configuration
- Zero build failures in CDF-disabled configurations
- CDF cache hit rate >80% in subsequent CI runs
- All four build configurations (2 systems × 2 CDF states) pass
- Documentation complete and clear for CDF integration
