# v1.4.0 Sprint 1: Spack CI Testing and Integration - Implementation Plan

## Overview

**Goal**: Add Spack CI testing workflow and prepare package for submission to official spack repository.

**Duration**: 1 week

**Deliverables**:
- `.github/workflows/spack.yml` CI workflow
- Updated `spack/package.py` with Fortran variant and CMake-only build
- Updated `docs/spack.md` reflecting changes
- PR submitted to spack/spack repository

## Prerequisites

- v1.3.0 complete (CDF support)
- Existing `spack/package.py` functional
- NEP builds successfully with CMake

## Phase 1: Update Spack Package

### Task 1.1: Convert to CMake-Only Package
- **File**: `spack/package.py`
- **Requirements**:
  - Change class inheritance from `CMakePackage, AutotoolsPackage` to just `CMakePackage`
  - Remove `configure_args()` method entirely
  - Remove any build_system variant if present
- **Acceptance Criteria**:
  - [ ] Package inherits only from CMakePackage
  - [ ] No Autotools-related code remains
  - [ ] Package passes `spack audit` check

### Task 1.2: Add Fortran Variant
- **File**: `spack/package.py`
- **Requirements**:
  - Add variant: `variant("fortran", default=True, description="Build Fortran wrappers")`
  - Add dependency: `depends_on("netcdf-fortran", when="+fortran", type=("build", "link"))`
  - Update `cmake_args()` to include: `self.define_from_variant("ENABLE_FORTRAN", "fortran")`
- **Acceptance Criteria**:
  - [ ] Fortran variant defined with default=True
  - [ ] netcdf-fortran dependency conditional on +fortran
  - [ ] cmake_args passes ENABLE_FORTRAN correctly

### Task 1.3: Add CDF Variant
- **File**: `spack/package.py`
- **Requirements**:
  - Add variant: `variant("cdf", default=False, description="Enable NASA CDF support")`
  - Add dependency: `depends_on("cdf", when="+cdf", type=("build", "link"))`
  - Update `cmake_args()` to include: `self.define_from_variant("ENABLE_CDF", "cdf")`
- **Acceptance Criteria**:
  - [ ] CDF variant defined with default=False
  - [ ] cdf dependency conditional on +cdf
  - [ ] cmake_args passes ENABLE_CDF correctly

### Task 1.4: Update Version Information
- **File**: `spack/package.py`
- **Requirements**:
  - Keep `version("develop", branch="main")` for testing
  - Update version line to use v1.4.0 (checksum TBD after release)
  - Add `version("1.3.0", sha256="...")` if release exists
- **Acceptance Criteria**:
  - [ ] develop version points to main branch
  - [ ] At least one versioned release with placeholder checksum

### Task 1.5: Add Missing Import
- **File**: `spack/package.py`
- **Requirements**:
  - Add `import os` for `os.path.exists()` in check_install method
- **Acceptance Criteria**:
  - [ ] No import errors when loading package

## Phase 2: Create Spack CI Workflow

### Task 2.1: Create Workflow File
- **File**: `.github/workflows/spack.yml`
- **Requirements**:
  - Trigger on push to main and pull_request to main
  - Use ubuntu-latest runner
  - Clone spack repository
  - Add NEP package as local repo
- **Acceptance Criteria**:
  - [ ] Workflow file exists with correct triggers
  - [ ] Spack cloned successfully

### Task 2.2: Implement Lint Checks
- **File**: `.github/workflows/spack.yml`
- **Requirements**:
  - Run `spack style spack/package.py` for code style
  - Run `spack audit` for package validation (if available for local packages)
  - Fail build on style errors
- **Acceptance Criteria**:
  - [ ] Style check runs on every PR
  - [ ] Errors cause workflow failure

### Task 2.3: Implement Install Test (Main Branch Only)
- **File**: `.github/workflows/spack.yml`
- **Requirements**:
  - Only run on push to main (not PRs)
  - Run `spack install nep@develop` with dependencies
  - Use spack mirror/cache if practical
  - Verify installation completes
- **Acceptance Criteria**:
  - [ ] Install test runs only on main branch
  - [ ] Full dependency chain builds
  - [ ] Installation succeeds

### Task 2.4: Add Concretization Test
- **File**: `.github/workflows/spack.yml`
- **Requirements**:
  - Run `spack spec nep@develop` to verify package concretizes
  - Run on all PRs (fast check)
  - Verify all variants concretize correctly
- **Acceptance Criteria**:
  - [ ] Spec check passes for all variant combinations
  - [ ] Dependencies resolve correctly

## Phase 3: Documentation Updates

### Task 3.1: Update Spack Documentation
- **File**: `docs/spack.md`
- **Requirements**:
  - Remove Autotools build_system references
  - Add Fortran variant documentation
  - Add CDF variant documentation
  - Update examples to reflect CMake-only
- **Acceptance Criteria**:
  - [ ] No Autotools references remain
  - [ ] Fortran variant documented with examples
  - [ ] CDF variant documented

### Task 3.2: Update README Spack Section
- **File**: `README.md`
- **Requirements**:
  - Verify Spack installation instructions are current
  - Add link to Spack CI status badge (optional)
- **Acceptance Criteria**:
  - [ ] README reflects current Spack capabilities

## Phase 4: Spack Repository Submission

### Task 4.1: Prepare Package for Submission
- **File**: `spack/package.py`
- **Requirements**:
  - Ensure package follows spack contribution guidelines
  - Add proper copyright header
  - Verify all metadata fields are complete
  - Calculate SHA256 checksum for v1.4.0 release tarball
- **Acceptance Criteria**:
  - [ ] Package passes all spack style checks
  - [ ] Copyright header present
  - [ ] Checksum valid for release

### Task 4.2: Submit PR to spack/spack
- **Requirements**:
  - Fork spack/spack repository
  - Add NEP package to `var/spack/repos/builtin/packages/nep/`
  - Create PR with package description
  - Reference NEP repository and documentation
- **Acceptance Criteria**:
  - [ ] PR submitted to spack/spack
  - [ ] CI passes on spack repo
  - [ ] Maintainer feedback addressed

## Definition of Done

- [ ] `spack/package.py` updated with CMake-only, Fortran, and CDF variants
- [ ] `.github/workflows/spack.yml` created and passing
- [ ] Lint checks run on all PRs
- [ ] Install test runs on main branch pushes
- [ ] `docs/spack.md` updated
- [ ] PR submitted to spack/spack repository
- [ ] All existing tests still pass

## Technical Notes

### Spack Package Structure (Updated)
```python
from spack.package import *
import os

class Nep(CMakePackage):
    """NEP (NetCDF Extension Pack) provides high-performance compression."""
    
    homepage = "https://github.com/Intelligent-Data-Design-Inc/NEP"
    url = "https://github.com/Intelligent-Data-Design-Inc/NEP/archive/v1.4.0.tar.gz"
    git = "https://github.com/Intelligent-Data-Design-Inc/NEP.git"
    
    maintainers("edhartnett")
    license("Apache-2.0")
    
    version("develop", branch="main")
    version("1.4.0", sha256="TBD")
    
    variant("docs", default=True, description="Build documentation")
    variant("lz4", default=True, description="Enable LZ4 compression")
    variant("bzip2", default=True, description="Enable BZIP2 compression")
    variant("fortran", default=True, description="Build Fortran wrappers")
    variant("cdf", default=False, description="Enable NASA CDF support")
    
    depends_on("netcdf-c@4.9:", type=("build", "link"))
    depends_on("hdf5@1.12:+hl", type=("build", "link"))
    depends_on("lz4", when="+lz4", type=("build", "link"))
    depends_on("bzip2", when="+bzip2", type=("build", "link"))
    depends_on("netcdf-fortran", when="+fortran", type=("build", "link"))
    depends_on("cdf", when="+cdf", type=("build", "link"))
    depends_on("doxygen", when="+docs", type="build")
    
    def cmake_args(self):
        return [
            self.define_from_variant("BUILD_DOCUMENTATION", "docs"),
            self.define_from_variant("ENABLE_FORTRAN", "fortran"),
            self.define_from_variant("ENABLE_CDF", "cdf"),
        ]
```

### Spack CI Workflow Structure
```yaml
name: Spack CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone Spack
        run: git clone --depth=1 https://github.com/spack/spack.git
      - name: Add NEP package
        run: |
          mkdir -p spack/var/spack/repos/builtin/packages/nep
          cp spack/package.py spack/var/spack/repos/builtin/packages/nep/
      - name: Style check
        run: ./spack/bin/spack style spack/package.py
      - name: Spec check
        run: ./spack/bin/spack spec nep@develop

  install:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      # Full install test on main branch only
```

## Risk Assessment

**Risk**: Spack package may fail on spack/spack CI with different environment
- **Mitigation**: Test with multiple spack versions, follow spack best practices

**Risk**: CDF package may not exist in spack
- **Mitigation**: Check spack package list; if missing, CDF variant may need deferred

**Risk**: Checksum changes if release tarball is regenerated
- **Mitigation**: Wait for stable release before submission

## Success Metrics

- [ ] Spack CI workflow passes on 100% of PRs
- [ ] Full install test succeeds on main branch
- [ ] Package accepted to spack/spack repository
- [ ] Zero regressions in existing CI tests
