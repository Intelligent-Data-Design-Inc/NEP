# v1.4.0 Sprint 1: Spack CI Testing and Spack Integration - Implementation Plan

## Overview

**Goal**: Add Spack package manager CI testing and prepare package.py for submission to the official Spack repository.

**Duration**: 1-2 weeks

**Deliverables**:
- Updated `spack/package.py` with v1.3.0 support, CDF variant, and CMake-only build
- GitHub Actions workflow `.github/workflows/spack.yml` for automated Spack testing
- Verified package.py ready for submission to spack/spack repository
- Updated Spack documentation

## Prerequisites

- v1.3.0 CDF support completed and released
- v1.0.0 and v1.3.0 release tarballs available on GitHub
- SHA256 checksums for release tarballs
- Both CMake and Autotools build systems functional
- Existing `spack/package.py` file in repository

## Phase 1: Update Spack Package File

### Task 1.1: Simplify to CMake-Only Build
- **File**: `spack/package.py`
- **Requirements**:
  - Remove `AutotoolsPackage` from class inheritance
  - Keep only `CMakePackage`: `class Nep(CMakePackage):`
  - Remove `configure_args()` method entirely
  - Keep `cmake_args()` method
- **Acceptance Criteria**:
  - [ ] Class inherits only from CMakePackage
  - [ ] No Autotools-related methods remain
  - [ ] Package.py syntax is valid Python

### Task 1.2: Add Version Information with Checksums
- **File**: `spack/package.py`
- **Requirements**:
  - Get SHA256 checksum for v1.0.0 release tarball:
    ```bash
    wget https://github.com/Intelligent-Data-Design-Inc/NEP/archive/v1.0.0.tar.gz
    sha256sum v1.0.0.tar.gz
    ```
  - Get SHA256 checksum for v1.3.0 release tarball (when available):
    ```bash
    wget https://github.com/Intelligent-Data-Design-Inc/NEP/archive/v1.3.0.tar.gz
    sha256sum v1.3.0.tar.gz
    ```
  - Update v1.0.0 version line with actual checksum
  - Add v1.3.0 version line with actual checksum
  - Keep "develop" version for development builds
- **Code Pattern**:
  ```python
  version("develop", branch="main")
  version("1.3.0", sha256="<actual_sha256_checksum>")
  version("1.0.0", sha256="<actual_sha256_checksum>")
  ```
- **Acceptance Criteria**:
  - [ ] v1.0.0 has real SHA256 checksum (not placeholder zeros)
  - [ ] v1.3.0 version added with real SHA256 checksum
  - [ ] "develop" version points to main branch
  - [ ] Version URLs point to correct GitHub release tarballs

### Task 1.3: Add CDF Variant and Dependency
- **File**: `spack/package.py`
- **Requirements**:
  - Add CDF variant (default off to match NEP build system):
    ```python
    variant("cdf", default=False, description="Enable CDF format support")
    ```
  - Add conditional CDF dependency:
    ```python
    depends_on("cdf", when="+cdf", type=("build", "link"))
    ```
  - Update `cmake_args()` to handle CDF variant:
    ```python
    def cmake_args(self):
        args = [
            self.define_from_variant("BUILD_DOCUMENTATION", "docs"),
            self.define_from_variant("ENABLE_CDF", "cdf"),
        ]
        return args
    ```
- **Acceptance Criteria**:
  - [ ] CDF variant defined with default=False
  - [ ] CDF dependency conditional on +cdf variant
  - [ ] cmake_args() includes ENABLE_CDF flag
  - [ ] CDF variant appears in `spack info nep` output

### Task 1.4: Update Package Description
- **File**: `spack/package.py`
- **Requirements**:
  - Update description to mention CDF support:
    ```python
    """NEP (NetCDF Extension Pack) provides high-performance compression for
    HDF5/NetCDF-4 files with LZ4 and BZIP2 compression algorithms, and extends
    NetCDF to support additional scientific data formats including NASA CDF."""
    ```
- **Acceptance Criteria**:
  - [ ] Description mentions CDF support
  - [ ] Description is concise and accurate

## Phase 2: Create Spack CI Workflow

### Task 2.1: Create Spack Workflow File
- **File**: `.github/workflows/spack.yml`
- **Requirements**:
  - Create new GitHub Actions workflow for Spack testing
  - Use Ubuntu latest runner
  - Install Spack in the workflow
  - Cache Spack installation for faster runs
- **Code Pattern**:
  ```yaml
  name: Spack
  
  on:
    push:
      branches: [ main ]
    pull_request:
      branches: [ main ]
  
  jobs:
    spack-test:
      runs-on: ubuntu-latest
      strategy:
        matrix:
          variant:
            - "default"
            - "~docs"
            - "+lz4~bzip2"
            - "~lz4+bzip2"
            - "+cdf"
      
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
        
        - name: Cache Spack
          uses: actions/cache@v4
          with:
            path: ~/spack
            key: spack-${{ runner.os }}-${{ hashFiles('.github/workflows/spack.yml') }}
        
        - name: Install Spack
          run: |
            if [ ! -d ~/spack ]; then
              git clone -c feature.manyFiles=true https://github.com/spack/spack.git ~/spack
            fi
            . ~/spack/share/spack/setup-env.sh
            spack --version
        
        - name: Install NEP with variant
          run: |
            . ~/spack/share/spack/setup-env.sh
            if [ "${{ matrix.variant }}" = "default" ]; then
              spack install --test=root ./spack/package.py
            else
              spack install --test=root ./spack/package.py ${{ matrix.variant }}
            fi
        
        - name: Verify installation
          run: |
            . ~/spack/share/spack/setup-env.sh
            spack find nep
            spack load nep
  ```
- **Acceptance Criteria**:
  - [ ] Workflow file created in correct location
  - [ ] Workflow triggers on push and PR to main
  - [ ] Spack installation cached
  - [ ] Matrix strategy tests multiple variants

### Task 2.2: Add Variant-Specific Testing
- **File**: `.github/workflows/spack.yml`
- **Requirements**:
  - Test each variant combination specified in roadmap
  - Verify installation succeeds for each variant
  - Use `--test=root` flag to run package tests
- **Variants to Test**:
  - Default build (all features enabled)
  - `~docs` (documentation disabled)
  - `+lz4~bzip2` (LZ4 only)
  - `~lz4+bzip2` (BZIP2 only)
  - `+cdf` (with CDF support)
- **Acceptance Criteria**:
  - [ ] All five variant combinations tested
  - [ ] Each variant installs successfully
  - [ ] Test failures cause workflow to fail

### Task 2.3: Add Installation Verification
- **File**: `.github/workflows/spack.yml`
- **Requirements**:
  - After installation, verify key files exist
  - Check plugin directory for expected libraries
  - Verify NEP can be loaded with `spack load nep`
- **Verification Steps**:
  ```yaml
  - name: Verify plugin installation
    run: |
      . ~/spack/share/spack/setup-env.sh
      spack load nep
      NEP_PREFIX=$(spack location -i nep)
      ls -la $NEP_PREFIX/lib/plugin/
      # Check for LZ4 if enabled
      if [[ "${{ matrix.variant }}" != *"~lz4"* ]]; then
        test -f $NEP_PREFIX/lib/plugin/libh5lz4.so
      fi
      # Check for BZIP2 if enabled
      if [[ "${{ matrix.variant }}" != *"~bzip2"* ]]; then
        test -f $NEP_PREFIX/lib/plugin/libh5bzip2.so
      fi
  ```
- **Acceptance Criteria**:
  - [ ] Plugin directory verified to exist
  - [ ] Expected plugin libraries verified based on variants
  - [ ] Verification failures cause workflow to fail

## Phase 3: Test and Validate

### Task 3.1: Local Spack Testing
- **Requirements**:
  - Install Spack locally if not already installed
  - Test package.py with various variants
  - Verify all variants build successfully
  - Check for any Spack warnings or errors
- **Testing Commands**:
  ```bash
  # Install Spack
  git clone https://github.com/spack/spack.git ~/spack
  . ~/spack/share/spack/setup-env.sh
  
  # Test default build
  spack install --test=root ./spack/package.py
  
  # Test variants
  spack install ./spack/package.py~docs
  spack install ./spack/package.py+lz4~bzip2
  spack install ./spack/package.py~lz4+bzip2
  spack install ./spack/package.py+cdf
  
  # Verify installations
  spack find nep
  spack load nep
  ```
- **Acceptance Criteria**:
  - [ ] All variants install successfully locally
  - [ ] No Spack errors or warnings
  - [ ] Plugin libraries installed correctly
  - [ ] `spack info nep` shows correct information

### Task 3.2: CI Workflow Testing
- **Requirements**:
  - Push changes to a branch
  - Verify Spack workflow runs successfully
  - Check all matrix jobs pass
  - Review workflow logs for any issues
- **Acceptance Criteria**:
  - [ ] Spack workflow runs on push
  - [ ] All matrix jobs complete successfully
  - [ ] No errors in workflow logs
  - [ ] Workflow completes in reasonable time (<30 minutes)

### Task 3.3: Package.py Validation
- **Requirements**:
  - Run `spack info nep` to verify package information
  - Check variant descriptions are clear
  - Verify dependency information is correct
  - Test package.py syntax with `spack style`
- **Validation Commands**:
  ```bash
  . ~/spack/share/spack/setup-env.sh
  spack info nep
  spack style ./spack/package.py
  ```
- **Acceptance Criteria**:
  - [ ] `spack info nep` shows all variants
  - [ ] All dependencies listed correctly
  - [ ] No style violations reported
  - [ ] Package description is accurate

## Phase 4: Documentation Updates

### Task 4.1: Update Spack Documentation
- **File**: `docs/spack.md`
- **Requirements**:
  - Add CDF variant documentation
  - Update examples to show CDF usage
  - Add note about CMake-only build
  - Update version information
- **New Content**:
  ```markdown
  ### CDF Format Support
  ```bash
  # Enable CDF support
  spack install nep+cdf
  ```
  
  ### Build System
  The Spack package uses CMake build system only. For Autotools builds,
  use the standard build instructions in the main README.
  ```
- **Acceptance Criteria**:
  - [ ] CDF variant documented
  - [ ] Examples updated
  - [ ] Build system note added
  - [ ] Documentation is clear and accurate

### Task 4.2: Update README
- **File**: `README.md`
- **Requirements**:
  - Update Spack installation section
  - Add CDF variant example
  - Mention v1.3.0 availability
- **Acceptance Criteria**:
  - [ ] README mentions v1.3.0
  - [ ] CDF variant example included
  - [ ] Spack section is current

## Phase 5: Prepare for Spack Repository Submission

### Task 5.1: Verify Release Tarballs
- **Requirements**:
  - Confirm v1.0.0 release tarball exists on GitHub
  - Confirm v1.3.0 release tarball exists (or will exist)
  - Download and verify checksums
  - Test that tarballs extract correctly
- **Verification**:
  ```bash
  # Download releases
  wget https://github.com/Intelligent-Data-Design-Inc/NEP/archive/v1.0.0.tar.gz
  wget https://github.com/Intelligent-Data-Design-Inc/NEP/archive/v1.3.0.tar.gz
  
  # Verify checksums
  sha256sum v1.0.0.tar.gz
  sha256sum v1.3.0.tar.gz
  
  # Test extraction
  tar -xzf v1.0.0.tar.gz
  tar -xzf v1.3.0.tar.gz
  ```
- **Acceptance Criteria**:
  - [ ] Both release tarballs accessible
  - [ ] Checksums calculated and verified
  - [ ] Tarballs extract without errors
  - [ ] Extracted contents match repository

### Task 5.2: Create Submission Checklist
- **File**: `docs/plan/spack-submission-checklist.md`
- **Requirements**:
  - Document steps for Spack PR submission
  - List required information for PR description
  - Note Spack contribution guidelines
  - Include testing verification steps
- **Checklist Items**:
  - [ ] Fork spack/spack repository
  - [ ] Create branch for NEP package
  - [ ] Copy package.py to `var/spack/repos/builtin/packages/nep/`
  - [ ] Test with `spack install nep@1.3.0`
  - [ ] Run `spack audit packages nep`
  - [ ] Run `spack style nep`
  - [ ] Create PR with clear description
  - [ ] Reference NEP repository and documentation
  - [ ] Respond to reviewer feedback
- **Acceptance Criteria**:
  - [ ] Checklist created and comprehensive
  - [ ] All steps documented clearly
  - [ ] Links to Spack guidelines included

### Task 5.3: Document Submission Process
- **File**: `docs/spack.md`
- **Requirements**:
  - Add section on package maintenance
  - Document how to update package for new releases
  - Note maintainer responsibilities
- **Content**:
  ```markdown
  ## Package Maintenance
  
  The NEP Spack package is maintained in the official Spack repository.
  
  ### Updating for New Releases
  1. Calculate SHA256 checksum for new release tarball
  2. Update package.py in spack/spack repository
  3. Submit PR with version update
  4. Test new version builds correctly
  
  ### Maintainers
  - Ed Hartnett (@edhartnett)
  ```
- **Acceptance Criteria**:
  - [ ] Maintenance section added
  - [ ] Update process documented
  - [ ] Maintainer information included

## Definition of Done

### Code Changes
- [ ] `spack/package.py` updated with CMake-only build
- [ ] v1.0.0 and v1.3.0 versions with real SHA256 checksums
- [ ] CDF variant added with conditional dependency
- [ ] Autotools support removed from package.py
- [ ] `.github/workflows/spack.yml` created and functional

### Testing
- [ ] All variant combinations tested locally
- [ ] Spack CI workflow passes for all variants
- [ ] Plugin libraries verified for each variant
- [ ] No Spack style violations
- [ ] Package.py validated with `spack info nep`

### Documentation
- [ ] `docs/spack.md` updated with CDF variant
- [ ] README.md updated with v1.3.0 information
- [ ] Submission checklist created
- [ ] Maintenance process documented

### Verification
- [ ] Local Spack install works for all variants
- [ ] CI workflow runs successfully
- [ ] Release tarballs verified and checksums calculated
- [ ] Package ready for submission to spack/spack

### Submission Preparation
- [ ] v1.3.0 release tarball available on GitHub
- [ ] All checksums verified
- [ ] Submission checklist complete
- [ ] Ready to create PR to spack/spack repository

## Technical Notes

### Spack Package Testing
```bash
# Install Spack
git clone https://github.com/spack/spack.git ~/spack
. ~/spack/share/spack/setup-env.sh

# Test local package.py
spack install --test=root ./spack/package.py

# Test specific variant
spack install ./spack/package.py+cdf

# Verify installation
spack find nep
spack load nep
export HDF5_PLUGIN_PATH=$(spack location -i nep)/lib/plugin
```

### Getting SHA256 Checksums
```bash
# For v1.0.0
wget https://github.com/Intelligent-Data-Design-Inc/NEP/archive/v1.0.0.tar.gz
sha256sum v1.0.0.tar.gz

# For v1.3.0
wget https://github.com/Intelligent-Data-Design-Inc/NEP/archive/v1.3.0.tar.gz
sha256sum v1.3.0.tar.gz
```

### Spack Style Checking
```bash
. ~/spack/share/spack/setup-env.sh
spack style ./spack/package.py
spack audit packages nep
```

### CDF Dependency
The CDF library in Spack is named `cdf`. Verify it exists:
```bash
spack info cdf
```

If CDF is not in Spack, we may need to:
1. Create a CDF package for Spack first
2. Or document manual CDF installation for +cdf variant

## Risk Assessment

### High Risk
- **CDF not in Spack**: CDF library may not exist in Spack repository
  - **Mitigation**: Check `spack list cdf` early; may need to create CDF package first or use external CDF
  - **Alternative**: Document that +cdf requires manual CDF installation

### Medium Risk
- **SHA256 checksum mismatch**: Release tarballs may change
  - **Mitigation**: Calculate checksums from official GitHub releases only
  - **Verification**: Test installation with checksums before submission

- **Spack version compatibility**: Package may not work with older Spack versions
  - **Mitigation**: Test with recent Spack develop branch
  - **Documentation**: Note minimum Spack version if needed

### Low Risk
- **CI workflow timeout**: Spack builds may take longer than expected
  - **Mitigation**: Use caching for Spack installation
  - **Monitoring**: Check workflow run times and adjust if needed

- **Variant conflicts**: Some variant combinations may conflict
  - **Mitigation**: Test all documented variant combinations
  - **Documentation**: Note any incompatible combinations

## Success Metrics

### Functionality
- [ ] 100% of variant combinations install successfully
- [ ] All plugin libraries installed correctly for each variant
- [ ] Zero Spack style violations
- [ ] Package.py passes `spack audit`

### CI Performance
- [ ] Spack workflow completes in <30 minutes
- [ ] Cache hit rate >80% for Spack installation
- [ ] Zero workflow failures on main branch

### Documentation Quality
- [ ] All variants documented with examples
- [ ] Submission process clearly explained
- [ ] Maintenance procedures documented

### Submission Readiness
- [ ] Package.py ready for spack/spack repository
- [ ] All checksums verified
- [ ] Testing complete and passing
- [ ] Documentation complete and accurate
