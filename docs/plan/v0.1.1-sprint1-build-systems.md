# NEP v0.1.1 Sprint 1: Build System Enhancement
## Phased Implementation Plan

**Sprint Goal**: Complete integration of all VOL connectors (BUFR, GeoTIFF, CDF) into both CMake and Autotools build systems with proper dependency management and configuration options.

**Duration**: 6-9 days  
**Priority**: High  
**Version**: v0.1.1 Sprint 1

---

## Current State Assessment

### ✅ Completed
- All VOL connector source files exist:
  - `grib2_vol_connector.c/.h`
  - `bufr_vol_connector.c/.h`
  - `cdf_vol_connector.c/.h`
  - `geotiff_vol_connector.c/.h`
- Basic CMake and Autotools build systems operational

### ❌ Missing/Incomplete
- VOL connector integration in build systems
- Dependency detection mechanisms
- Enable/disable configuration options
- Shared library compilation setup
- Error handling for missing dependencies

---

## Phase 1: CMake Build System Integration
**Duration**: 2-3 days  
**Dependencies**: None (all connector files exist)

### Tasks
1. **VOL Connector Integration**
   - Update root `CMakeLists.txt`
   - Add each connector as separate shared library target
   - Configure proper include paths and source files

2. **Dependency Detection**
   - Implement FindNCEPLIBS-g2.cmake module
   - Implement FindNCEPLIBS-bufr.cmake module
   - Implement FindLibGeoTIFF.cmake module
   - Implement FindNASACDF.cmake module

3. **Configuration Options**
   - Add `ENABLE_GRIB2` option (default: ON)
   - Add `ENABLE_BUFR` option (default: ON)
   - Add `ENABLE_GEOTIFF` option (default: ON)
   - Add `ENABLE_CDF` option (default: ON)

4. **Shared Library Setup**
   - Configure each connector as shared library (.so/.dll)
   - Set proper RPATH/RUNPATH for dynamic loading
   - Configure export symbols

### Deliverables
- Updated CMakeLists.txt files
- Find*.cmake modules for all dependencies
- Working shared library compilation
- Configuration options functional

### Success Criteria
- `cmake -DENABLE_<VOL>=ON/OFF` works for all VOL types
- Dependencies properly detected when available
- Each connector compiles to separate shared library
- Build fails gracefully when dependencies missing

---

## Phase 2: Autotools Build System Integration
**Duration**: 2-3 days  
**Dependencies**: Phase 1 complete

### Tasks
1. **Configure Script Updates**
   - Update `configure.ac` with VOL connector options
   - Add dependency detection macros
   - Implement `--enable/disable-<vol>` flags

2. **Makefile Updates**
   - Update `Makefile.am` files
   - Configure shared library compilation
   - Set proper linking flags

3. **Dependency Detection**
   - Create autotools macros for NCEPLIBS-g2
   - Create autotools macros for NCEPLIBS-bufr
   - Create autotools macros for libgeotiff
   - Create autotools macros for NASA CDF

4. **Configuration Options**
   - `--enable-grib2/--disable-grib2` (default: enabled)
   - `--enable-bufr/--disable-bufr` (default: enabled)
   - `--enable-geotiff/--disable-geotiff` (default: enabled)
   - `--enable-cdf/--disable-cdf` (default: enabled)

### Deliverables
- Updated configure.ac
- Updated Makefile.am files
- Autotools dependency detection macros
- Working configure flags

### Success Criteria
- `./configure --enable/disable-<vol>` works for all VOL types
- Dependencies properly detected by autotools
- Shared libraries compile correctly
- Parallel functionality with CMake system

---

## Phase 3: Error Handling & Robustness
**Duration**: 1-2 days  
**Dependencies**: Phases 1 & 2 complete

### Tasks
1. **Error Message Implementation**
   - Clear messages when dependencies missing
   - Helpful suggestions for installing dependencies
   - Proper exit codes for build failures

2. **Dependency Validation**
   - Version checking for libraries
   - Compatibility validation
   - Runtime dependency verification

3. **Build Configuration Validation**
   - Validate enable/disable combinations
   - Check for conflicting options
   - Ensure at least one VOL type enabled

### Deliverables
- Comprehensive error handling
- User-friendly error messages
- Robust build configuration validation

### Success Criteria
- Clear error messages when dependencies missing
- Build fails fast with helpful information
- No silent failures or undefined behavior

---

## Phase 4: Testing & Validation
**Duration**: 1-2 days  
**Dependencies**: Phases 1-3 complete

### Tasks
1. **Build System Testing**
   - Test with all VOL types enabled
   - Test with individual VOL types disabled
   - Test with missing dependencies
   - Test cross-platform compatibility

2. **Integration Testing**
   - Verify shared libraries load correctly
   - Test dynamic loading mechanisms
   - Validate connector registration

3. **CI/CD Integration**
   - Update GitHub Actions workflow
   - Add build matrix for different configurations
   - Test dependency installation
   - **CI Matrix Testing Requirements**:
     - Test each VOL connector independently (all others disabled)
       - GRIB2 only: `-DENABLE_GRIB2=ON -DENABLE_BUFR=OFF -DENABLE_GEOTIFF=OFF -DENABLE_CDF=OFF`
       - BUFR only: `-DENABLE_GRIB2=OFF -DENABLE_BUFR=ON -DENABLE_GEOTIFF=OFF -DENABLE_CDF=OFF`
       - GeoTIFF only: `-DENABLE_GRIB2=OFF -DENABLE_BUFR=OFF -DENABLE_GEOTIFF=ON -DENABLE_CDF=OFF`
       - CDF only: `-DENABLE_GRIB2=OFF -DENABLE_BUFR=OFF -DENABLE_GEOTIFF=OFF -DENABLE_CDF=ON`
     - Test all VOL connectors enabled together
       - All enabled: `-DENABLE_GRIB2=ON -DENABLE_BUFR=ON -DENABLE_GEOTIFF=ON -DENABLE_CDF=ON`
     - Test equivalent Autotools configurations
       - Individual: `--enable-<vol> --disable-<others>`
       - All enabled: `--enable-grib2 --enable-bufr --enable-geotiff --enable-cdf`

### Deliverables
- Comprehensive test suite
- Updated CI/CD pipeline with build matrix
- Cross-platform validation
- CI matrix testing for all VOL combinations

### Success Criteria
- All build configurations work correctly
- CI/CD pipeline passes with full build matrix
- Each VOL connector builds independently when others are disabled
- All VOL connectors build together when all are enabled
- Both CMake and Autotools configurations tested in CI
- No regressions in existing functionality

---

## Phase 5: Documentation & Finalization
**Duration**: 1 day  
**Dependencies**: Phases 1-4 complete

### Tasks
1. **Build Documentation**
   - Update README with build instructions
   - Document dependency requirements
   - Create troubleshooting guide

2. **Developer Documentation**
   - Update design.md with build system details
   - Document connector development process
   - Add build system architecture diagrams

3. **User Documentation**
   - Configuration option reference
   - Installation guides for dependencies
   - Platform-specific instructions

### Deliverables
- Updated documentation
- Build troubleshooting guide
- Developer reference materials

### Success Criteria
- Complete build documentation
- Clear dependency installation instructions
- Updated design documentation

---

## Dependencies & Libraries

| VOL Connector | Required Library | Source | Detection Method |
|---------------|------------------|--------|------------------|
| GRIB2 | NCEPLIBS-g2 | NOAA/NCEP libraries | pkg-config, cmake find, autotools macro |
| BUFR | NCEPLIBS-bufr | NOAA/NCEP libraries | pkg-config, cmake find, autotools macro |
| GeoTIFF | libgeotiff | OSGeo project | pkg-config, cmake find, autotools macro |
| CDF | NASA CDF | https://cdf.gsfc.nasa.gov/html/sw_and_docs.html | cmake find, autotools macro |

---

## Risk Assessment & Mitigation

### High Risk
- **Dependency availability**: Some libraries may not be readily available
  - *Mitigation*: Provide clear installation instructions, consider fallback options
- **Cross-platform compatibility**: Different library locations/names
  - *Mitigation*: Comprehensive find modules, platform-specific detection

### Medium Risk
- **Build system complexity**: Dual build system maintenance
  - *Mitigation*: Automated testing, parallel development approach
- **Dynamic loading issues**: Platform-specific dlopen behavior
  - *Mitigation*: Abstract dynamic loading, extensive testing

### Low Risk
- **Documentation completeness**: Keeping docs up to date
  - *Mitigation*: Documentation as part of each phase

---

## Success Metrics

### Functional Requirements
- [ ] All VOL connectors compile as separate shared libraries
- [ ] Enable/disable options work for each VOL type in both build systems
- [ ] Dependencies properly detected and linked
- [ ] Build fails with clear messages when dependencies missing
- [ ] Default configuration enables all VOL types when dependencies available

### Quality Requirements
- [ ] No regressions in existing functionality
- [ ] Cross-platform compatibility maintained
- [ ] CI/CD pipeline passes all tests
- [ ] Documentation complete and accurate

### Performance Requirements
- [ ] Build time remains reasonable
- [ ] Shared library loading time <500ms per connector
- [ ] Memory footprint acceptable for dynamic loading

---

## Post-Sprint Activities

### Immediate Follow-up (v0.1.1 Sprint 2)
- Install target implementation
- Package management integration
- Distribution testing

### Future Considerations (v0.1.2+)
- Doxygen documentation integration
- gh-pages deployment
- Advanced dependency management

---

## Team Coordination

### Daily Standup Topics
- Phase completion status
- Dependency detection challenges
- Cross-platform testing results
- Documentation progress

### Review Points
- End of Phase 1: CMake integration review
- End of Phase 2: Autotools integration review
- End of Phase 4: Full system testing review

### Definition of Done
- All acceptance criteria met
- Code reviewed and approved
- Tests passing in CI/CD
- Documentation updated
- No regressions identified
