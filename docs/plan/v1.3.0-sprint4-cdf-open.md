# v1.3.0 Sprint 4 Implementation Plan

## Overview
- **Goal**: Implement functional CDF UDF handler with file open, metadata reading, and basic data access
- **Sprint**: v1.3.0, Sprint 4
- **Primary Deliverables**:
  - Complete NC_CDF_open() with full metadata mapping
  - Complete NC_CDF_close() with proper cleanup
  - CDF type mapping (cdf_type_info function)
  - Metadata helper functions (dimensions, variables, attributes)
  - Basic NC_CDF_get_vara() for data validation
  - Test program (tst_cdf_udf.c) with assertion-based validation
  - CI integration

## Prerequisites
- Sprint 1-3 complete: CDF library detection, test data file, stubbed UDF library
- NASA CDF library v3.9.x available
- CDF test file characteristics documented
- NetCDF-C internal metadata structures understood

## Phase 1: CDF Type Mapping

### Task 1.1: Implement cdf_type_info()
- **File**: `src/cdffile.c` (line 72)
- **Requirements**: Map CDF types to NetCDF types (CDF_INT4竊誰C_INT, CDF_REAL8竊誰C_DOUBLE, etc.), set endianness and type size, return NC_EBADTYPE for unknown types
- **Acceptance**: All common CDF types mapped correctly

### Task 1.2: Implement nc4_set_var_type()
- **File**: `src/cdffile.c` (line 93)
- **Requirements**: Allocate NC_TYPE_INFO_T, set type fields, handle allocation failures
- **Acceptance**: Structure properly initialized, no memory leaks

## Phase 2: Metadata Helper Functions

### Task 2.1: Implement cdf_rec_grp_del()
- **File**: `src/cdffile.c` (line 48)
- **Requirements**: Recursively free all metadata structures, handle NULL pointers
- **Acceptance**: No memory leaks on file close

### Task 2.2: Create cdf_read_dims()
- **File**: `src/cdffile.c` (new)
- **Requirements**: Query CDF dimensions via CDFinquire(), create NC_DIM_INFO_T structures, add to group
- **Acceptance**: All dimensions mapped correctly

### Task 2.3: Create cdf_read_vars()
- **File**: `src/cdffile.c` (new)
- **Requirements**: Query CDF variables, map types via cdf_type_info(), create NC_VAR_INFO_T, store CDF variable IDs, add to group via nc4_vararray_add()
- **Acceptance**: All zVariables mapped with correct types/dimensions

### Task 2.4: Create cdf_read_atts()
- **File**: `src/cdffile.c` (new)
- **Requirements**: Query and read CDF attributes (global and variable), create NC_ATT_INFO_T, handle string attributes
- **Acceptance**: All attributes mapped with correct values

## Phase 3: File Open/Close

### Task 3.1: Implement NC_CDF_open()
- **File**: `src/cdffile.c` (new)
- **Requirements**: Validate parameters, open CDF file via CDFopen(), allocate NC_CDF_FILE_INFO_T, call cdf_read_dims/vars/atts(), handle errors
- **Acceptance**: Opens valid CDF files, rejects invalid files with NC_ENOTNC4, metadata fully populated

### Task 3.2: Add cdf_status_to_nc_error()
- **File**: `src/cdffile.c` (new)
- **Requirements**: Map CDF error codes to NetCDF codes (CDF_OK竊誰C_NOERR, NO_SUCH_CDF竊誰C_ENOTNC4, etc.)
- **Acceptance**: All common errors mapped

### Task 3.3: Implement NC_CDF_close() and NC_CDF_abort()
- **File**: `src/cdffile.c` (new)
- **Requirements**: Close CDF file via CDFclose(), free metadata via cdf_rec_grp_del(), free NC_CDF_FILE_INFO_T
- **Acceptance**: File closed, all memory freed, no leaks

## Phase 4: Basic Data Reading

### Task 4.1: Implement NC_CDF_get_vara()
- **File**: `src/cdffile.c` (new)
- **Requirements**: Get CDF variable ID, read scalars via CDFgetVarData(), read arrays via CDFhyperGetVarData(), handle basic type conversion
- **Acceptance**: Reads scalar and array data correctly

## Phase 5: Test Program

### Task 5.1: Create tst_cdf_udf.c
- **File**: `test/tst_cdf_udf.c` (new)
- **Requirements**: Open CDF via nc_open(), validate dimensions/variables/attributes via nc_inq functions, read data via nc_get_var, use assertions for validation, close via nc_close()
- **Acceptance**: Test passes with all assertions, returns 0 on success

### Task 5.2: Build System Integration
- **Files**: `test/CMakeLists.txt`, `test/Makefile.am`
- **Requirements**: Add conditional test build when CDF enabled, link against NetCDF, register with CTest/make check
- **Acceptance**: Test builds when enabled, skipped when disabled

## Phase 6: CI and Documentation

### Task 6.1: Verify CI and Local Testing
- **Requirements**: Test locally with both build systems, verify with valgrind, push and monitor CI
- **Acceptance**: All tests pass locally and in CI, no memory leaks

### Task 6.2: Add Documentation
- **Files**: `src/cdffile.c`, `README.md`
- **Requirements**: Add Doxygen comments to all functions, update user docs with CDF UDF usage
- **Acceptance**: All functions documented, usage examples provided

## Definition of Done
- NC_CDF_open/close/abort fully implemented
- cdf_type_info maps all common CDF types
- Metadata functions create complete NetCDF structures
- NC_CDF_get_vara reads scalars and arrays
- tst_cdf_udf validates via NetCDF API with assertions
- Test integrated in both build systems and CI
- All tests pass, zero warnings, no memory leaks
- Code and user documentation complete

## Technical Notes
- **CDF API**: CDFopen, CDFclose, CDFinquire, CDFgetVarInfo, CDFgetVarData, CDFhyperGetVarData, CDFgetNumgAttributes, CDFgetAttrgEntry
- **NetCDF Structures**: NC_FILE_INFO_T, NC_GRP_INFO_T, NC_VAR_INFO_T, NC_DIM_INFO_T, NC_ATT_INFO_T, NC_TYPE_INFO_T, NC_CDF_FILE_INFO_T, NC_VAR_CDF_INFO_T
- **Key Files**: src/cdffile.c, src/cdfdispatch.c, include/cdfdispatch.h, test/tst_cdf_udf.c
- **Reference**: /home/ed/netcdf-c/libhdf4 for NetCDF internal patterns

## Risk Assessment
- **CDF API complexity**: Mitigate with NASA docs, Sprint 2 test program, simple test file
- **NetCDF internal APIs**: Reference libhdf4, use existing functions, test thoroughly
- **Memory management**: Use valgrind, follow NetCDF patterns, test open/close cycles
- **Type conversion**: Start with common types, validate with test data
- **Test dependencies**: Document test file requirements, hard-code expected values

## Success Metrics
- Test passes 100% of assertions
- Zero memory leaks (valgrind)
- Zero compilation warnings
- CI passes all configurations
- Test execution <10 seconds
- All metadata accessible via NetCDF API
- Data values match CDF API results
