# v1.5.3 Sprint 2 Implementation Plan: Fortran Quickstart Example

## Overview
- **Goal**: Create Fortran equivalent of C quickstart example using NetCDF-Fortran API
- **Sprint**: v1.5.3, Sprint 2
- **Primary Deliverables**:
  - Fortran program `f_classic/f_quickstart.f90` with comprehensive documentation
  - CMake and Autotools build integration with Fortran conditionals
  - Automated test execution when Fortran enabled
  - NetCDF file creation matching C example structure

## Prerequisites
- v1.5.3 Sprint 1 complete (C quickstart working)
- NetCDF-Fortran library available
- ENABLE_FORTRAN option functional in both build systems
- Fortran compiler configured

## Phase 1: Fortran Program Implementation

### Task 1.1: Create f_quickstart.f90 File Structure
- **File path**: `examples/f_classic/f_quickstart.f90`
- **Requirements**:
  - Add comprehensive Doxygen documentation header
  - Explain purpose: Fortran version of quickstart example
  - Document learning objectives:
    - Creating a NetCDF file from Fortran
    - Defining dimensions using nf90_def_dim
    - Defining variables using nf90_def_var
    - Writing data using nf90_put_var
    - Adding attributes (global and variable)
    - Reading back and validating data
  - Include prerequisites section (basic Fortran knowledge)
  - Reference C version for comparison
  - Add example output description
- **Acceptance criteria**:
  - File created with proper header comments
  - Doxygen-compatible documentation format
  - Clear explanation suitable for Fortran/NetCDF beginners

### Task 1.2: Implement Program Structure and Module Usage
- **Requirements**:
  - Use `program f_quickstart` structure
  - Include `use netcdf` module for NetCDF-Fortran API
  - Declare implicit none for type safety
  - Declare all variables with appropriate types
  - Use Fortran 90 free-form syntax
- **Code pattern**:
```fortran
program f_quickstart
  use netcdf
  implicit none
  
  integer :: ncid, x_dimid, y_dimid, data_varid
  integer :: retval
  integer, parameter :: XDIM = 2, YDIM = 3
  integer :: data(XDIM, YDIM)
  integer :: data_in(XDIM, YDIM)
  integer :: i, j
```
- **Acceptance criteria**:
  - Program structure follows Fortran 90 conventions
  - All variables declared explicitly
  - netcdf module imported

### Task 1.3: Implement File Creation and Dimension Definition
- **Requirements**:
  - Create NetCDF file using `nf90_create()` with `nf90_clobber` mode
  - Define two dimensions:
    - "X" with size 2
    - "Y" with size 3
  - Store dimension IDs for variable definition
  - Check return values and handle errors
  - Use check() subroutine for error handling
- **Code pattern**:
```fortran
  ! Create the NetCDF file
  retval = nf90_create("f_quickstart.nc", nf90_clobber, ncid)
  call check(retval, "creating file")
  
  ! Define dimensions
  retval = nf90_def_dim(ncid, "X", XDIM, x_dimid)
  call check(retval, "defining X dimension")
  
  retval = nf90_def_dim(ncid, "Y", YDIM, y_dimid)
  call check(retval, "defining Y dimension")
```
- **Acceptance criteria**:
  - File creation succeeds
  - Both dimensions defined correctly
  - Error handling via check() subroutine

### Task 1.4: Implement Variable Definition
- **Requirements**:
  - Define one variable named "data"
  - Type: nf90_int (32-bit integer)
  - Dimensions: X and Y (2D array: 2x3)
  - Note: Fortran dimension order is opposite of C (column-major)
  - Store variable ID for data writing
- **Code pattern**:
```fortran
  ! Define variable
  retval = nf90_def_var(ncid, "data", nf90_int, [x_dimid, y_dimid], data_varid)
  call check(retval, "defining variable")
```
- **Acceptance criteria**:
  - Variable defined with correct name, type, and dimensions
  - Dimension order correct for Fortran (column-major)

### Task 1.5: Implement Attribute Definition
- **Requirements**:
  - Add one global attribute:
    - Name: "description"
    - Value: "a quickstart example"
  - Add one variable attribute for "data" variable:
    - Name: "units"
    - Value: "m/s"
  - Use `nf90_put_att()` for character attributes
  - Use nf90_global for global attributes
- **Code pattern**:
```fortran
  ! Add global attribute
  retval = nf90_put_att(ncid, nf90_global, "description", "a quickstart example")
  call check(retval, "adding global attribute")
  
  ! Add variable attribute
  retval = nf90_put_att(ncid, data_varid, "units", "m/s")
  call check(retval, "adding variable attribute")
```
- **Acceptance criteria**:
  - Global attribute "description" added successfully
  - Variable attribute "units" added to "data" variable
  - Attribute values correct

### Task 1.6: Implement Data Generation and Writing
- **Requirements**:
  - End define mode using `nf90_enddef()`
  - Generate simple sequential data in 2x3 array
  - Note: Fortran arrays are column-major, so data layout differs from C
  - Write data using `nf90_put_var()`
  - Close file using `nf90_close()`
- **Code pattern**:
```fortran
  ! End define mode
  retval = nf90_enddef(ncid)
  call check(retval, "ending define mode")
  
  ! Generate data (column-major order)
  do j = 1, YDIM
    do i = 1, XDIM
      data(i, j) = (j-1) * XDIM + i
    end do
  end do
  
  ! Write data
  retval = nf90_put_var(ncid, data_varid, data)
  call check(retval, "writing data")
  
  ! Close file
  retval = nf90_close(ncid)
  call check(retval, "closing file")
```
- **Acceptance criteria**:
  - Define mode ended successfully
  - Data array generated with sequential values
  - Data written to variable
  - File closed properly

### Task 1.7: Implement File Reopening and Validation
- **Requirements**:
  - Reopen file in read-only mode using `nf90_open()` with `nf90_nowrite`
  - Query and validate file contents:
    - Number of dimensions using `nf90_inquire()`
    - Number of variables using `nf90_inquire()`
    - Number of global attributes using `nf90_inquire()`
    - Dimension names and sizes using `nf90_inquire_dimension()`
    - Variable name, type, and dimensions using `nf90_inquire_variable()`
    - Attribute values using `nf90_get_att()`
  - Read data back using `nf90_get_var()`
  - Print validation results to stdout
  - Verify data values match what was written
  - Close file
  - Stop with error code on validation failure
- **Code pattern**:
```fortran
  ! Reopen file
  retval = nf90_open("f_quickstart.nc", nf90_nowrite, ncid)
  call check(retval, "reopening file")
  
  ! Query file metadata
  retval = nf90_inquire(ncid, ndims, nvars, ngatts)
  call check(retval, "inquiring file")
  
  print *, "File contains:", ndims, "dimensions,", nvars, "variables,", &
           ngatts, "global attributes"
  
  ! Read data
  retval = nf90_get_var(ncid, data_varid, data_in)
  call check(retval, "reading data")
  
  ! Validate data
  do j = 1, YDIM
    do i = 1, XDIM
      if (data_in(i, j) /= data(i, j)) then
        print *, "Error: Data validation failed"
        stop 1
      end if
    end do
  end do
  
  print *, "Validation successful!"
  
  ! Close file
  retval = nf90_close(ncid)
  call check(retval, "closing file after reading")
```
- **Acceptance criteria**:
  - File reopened successfully
  - All metadata queried and validated
  - Data read back correctly
  - Data values match original values
  - Clear output messages for validation
  - Exit code 0 on success, 1 on validation failure

### Task 1.8: Implement Error Handling Subroutine
- **Requirements**:
  - Create check() subroutine for consistent error handling
  - Accept return value and context message
  - Print NetCDF error message using `nf90_strerror()`
  - Stop program with error code on failure
- **Code pattern**:
```fortran
contains
  subroutine check(status, context)
    integer, intent(in) :: status
    character(len=*), intent(in) :: context
    
    if (status /= nf90_noerr) then
      print *, "Error ", trim(context), ": ", trim(nf90_strerror(status))
      stop 2
    end if
  end subroutine check
  
end program f_quickstart
```
- **Acceptance criteria**:
  - check() subroutine defined as contained subroutine
  - Used consistently throughout program
  - Clear error messages with context
  - Stop with code 2 on NetCDF errors

## Phase 2: CMake Build Integration

### Task 2.1: Update examples/f_classic/CMakeLists.txt
- **File path**: `examples/f_classic/CMakeLists.txt`
- **Requirements**:
  - Add f_quickstart.f90 to list of Fortran example programs
  - Create executable: `add_executable(f_quickstart f_quickstart.f90)`
  - Link against NetCDF-Fortran: `target_link_libraries(f_quickstart PRIVATE NetCDF::NetCDFF)`
  - Register as CTest test: `add_test(NAME f_quickstart COMMAND f_quickstart)`
  - Ensure builds only when ENABLE_FORTRAN=ON and netcdf-fortran available
  - Follow existing pattern from other f_classic examples
- **Acceptance criteria**:
  - f_quickstart executable builds when BUILD_EXAMPLES=ON and ENABLE_FORTRAN=ON
  - Executable linked correctly against NetCDF-Fortran
  - Test registered in CTest suite
  - Skipped when Fortran disabled

### Task 2.2: Verify CMake Test Execution
- **Requirements**:
  - Run `cmake -DBUILD_EXAMPLES=ON -DENABLE_FORTRAN=ON ..` to configure
  - Run `make` or `cmake --build .` to build
  - Run `ctest -R f_quickstart` to execute test
  - Verify test passes (exit code 0)
  - Verify f_quickstart.nc file created
- **Acceptance criteria**:
  - CMake configuration succeeds with Fortran enabled
  - f_quickstart builds without warnings
  - CTest execution passes
  - NetCDF file created in build directory

### Task 2.3: Verify CMake Fortran Conditional
- **Requirements**:
  - Test that f_quickstart is NOT built when ENABLE_FORTRAN=OFF
  - Verify no build errors when Fortran disabled
- **Acceptance criteria**:
  - Fortran examples skipped when ENABLE_FORTRAN=OFF
  - No build failures in Fortran-disabled configuration

## Phase 3: Autotools Build Integration

### Task 3.1: Update examples/f_classic/Makefile.am
- **File path**: `examples/f_classic/Makefile.am`
- **Requirements**:
  - Add f_quickstart to TESTS variable (within Fortran conditional)
  - Add f_quickstart to check_PROGRAMS
  - Set `f_quickstart_SOURCES = f_quickstart.f90`
  - Set `f_quickstart_LDADD = $(NETCDF_FORTRAN_LIBS)`
  - Ensure within `if BUILD_FORTRAN ... endif` block
  - Follow existing pattern from other f_classic examples
- **Acceptance criteria**:
  - f_quickstart added to Autotools build
  - Builds only when Fortran enabled
  - Runs as part of `make check` when Fortran enabled

### Task 3.2: Verify Autotools Test Execution
- **Requirements**:
  - Run `./configure --enable-examples --enable-fortran` to configure
  - Run `make` to build
  - Run `make check` to execute tests
  - Verify f_quickstart test passes
  - Verify f_quickstart.nc file created
- **Acceptance criteria**:
  - Autotools configuration succeeds with Fortran enabled
  - f_quickstart builds without warnings
  - `make check` passes
  - NetCDF file created in build directory

### Task 3.3: Verify Autotools Fortran Conditional
- **Requirements**:
  - Test that f_quickstart is NOT built when --disable-fortran
  - Verify no build errors when Fortran disabled
- **Acceptance criteria**:
  - Fortran examples skipped when Fortran disabled
  - No build failures in Fortran-disabled configuration

## Phase 4: Documentation

### Task 4.1: Add Inline Code Documentation
- **Requirements**:
  - Add Doxygen comments for program and subroutines
  - Add inline comments explaining each major step:
    - File creation
    - Dimension definition
    - Variable definition
    - Attribute definition
    - Data writing
    - File reopening
    - Data validation
  - Explain Fortran-specific considerations (column-major order)
  - Keep comments concise and beginner-friendly
- **Acceptance criteria**:
  - All major sections documented
  - Fortran-specific aspects explained
  - Suitable for Fortran/NetCDF beginners

### Task 4.2: Update examples/README.md
- **File path**: `examples/README.md`
- **Requirements**:
  - Add f_quickstart.f90 to f_classic examples list
  - Brief description: "Fortran version of quickstart - minimal introduction to NetCDF from Fortran"
  - Note that this is equivalent to C quickstart example
  - Mention Fortran-specific considerations (column-major arrays)
- **Acceptance criteria**:
  - README updated with f_quickstart entry
  - Description clear and accurate
  - Relationship to C version explained

## Phase 5: Testing and Validation

### Task 5.1: Manual Testing
- **Requirements**:
  - Build and run f_quickstart manually
  - Verify f_quickstart.nc created
  - Run `ncdump f_quickstart.nc` to inspect output
  - Verify CDL output shows:
    - dimensions: X=2, Y=3
    - variable: int data(X, Y)
    - global attribute: description = "a quickstart example"
    - variable attribute: data:units = "m/s"
    - data values: 1, 2, 3, 4, 5, 6 (same as C version)
  - Compare with C quickstart output
- **Acceptance criteria**:
  - Program runs without errors
  - ncdump output matches C version expectations
  - All metadata present and correct
  - Data values identical to C version

### Task 5.2: Build System Testing
- **Requirements**:
  - Test CMake build with BUILD_EXAMPLES=ON, ENABLE_FORTRAN=ON
  - Test CMake build with BUILD_EXAMPLES=ON, ENABLE_FORTRAN=OFF (f_quickstart not built)
  - Test Autotools build with --enable-examples --enable-fortran
  - Test Autotools build with --enable-examples --disable-fortran (f_quickstart not built)
- **Acceptance criteria**:
  - All four configurations work correctly
  - f_quickstart only built when examples AND Fortran enabled
  - No build errors or warnings

### Task 5.3: CI Validation
- **Requirements**:
  - Verify f_quickstart runs in CI for both build systems
  - Check CI logs for successful test execution
  - Verify no new warnings or errors introduced
  - Confirm Fortran examples run when ENABLE_FORTRAN=ON
- **Acceptance criteria**:
  - CI passes with f_quickstart test
  - Test execution logged in CI output
  - No CI failures related to f_quickstart

### Task 5.4: Cross-Language Validation
- **Requirements**:
  - Compare ncdump output of quickstart.nc (C) and f_quickstart.nc (Fortran)
  - Verify both produce identical CDL structure
  - Verify data values are identical
  - Confirm attributes match
- **Acceptance criteria**:
  - Both programs produce equivalent NetCDF files
  - CDL output identical (except file name)
  - Data values match exactly

## Definition of Done
- [ ] f_quickstart.f90 created in examples/f_classic/
- [ ] Program creates NetCDF file with 2 dimensions (X=2, Y=3)
- [ ] Program defines 1 variable (integer data(X,Y))
- [ ] Program adds 1 global attribute (description)
- [ ] Program adds 1 variable attribute (units)
- [ ] Program writes data array (2x3 integers)
- [ ] Program reopens file and validates all contents
- [ ] Program stops with code 0 on success, non-zero on failure
- [ ] Comprehensive Doxygen documentation included
- [ ] CMake build integration complete with Fortran conditionals
- [ ] Autotools build integration complete with Fortran conditionals
- [ ] Tests pass in both build systems when Fortran enabled
- [ ] Tests skipped when Fortran disabled
- [ ] CI passes with new example
- [ ] examples/README.md updated
- [ ] Manual ncdump verification confirms output matches C version
- [ ] Cross-language validation confirms C and Fortran produce identical files

## Technical Notes
- **File name**: `f_quickstart.nc` (created in current directory)
- **Dimensions**: X=2, Y=3 (total 6 data points)
- **Variable**: "data" of type nf90_int (32-bit integer)
- **Data values**: Sequential integers (1, 2, 3, 4, 5, 6) - same as C version
- **Global attribute**: "description" = "a quickstart example"
- **Variable attribute**: "units" = "m/s"
- **Error handling**: check() subroutine for consistent error reporting
- **Exit codes**: 0=success, 1=validation failure, 2=NetCDF error
- **Array order**: Fortran uses column-major order (opposite of C)
- **API differences**: nf90_* functions vs nc_* functions

## Expected ncdump Output
```
netcdf f_quickstart {
dimensions:
	X = 2 ;
	Y = 3 ;
variables:
	int data(X, Y) ;
		data:units = "m/s" ;

// global attributes:
		:description = "a quickstart example" ;
data:

 data =
  1, 2, 3,
  4, 5, 6 ;
}
```
**Note**: Output should be identical to C version (quickstart.nc)

## Fortran-Specific Considerations
- **Array Indexing**: Fortran arrays are 1-based (not 0-based like C)
- **Array Order**: Fortran uses column-major order; C uses row-major order
- **Module System**: Use `use netcdf` instead of `#include <netcdf.h>`
- **API Naming**: nf90_* functions instead of nc_* functions
- **Error Handling**: Subroutine-based error checking vs macro-based in C
- **Type Safety**: `implicit none` enforces explicit variable declarations
- **String Handling**: Fortran character types vs C char arrays

## References
- Sprint 1 C quickstart implementation (examples/classic/quickstart.c)
- Existing Fortran examples: `examples/f_classic/f_simple_2D.f90`
- NetCDF-Fortran API: https://docs.unidata.ucar.edu/netcdf-fortran/current/
- NetCDF-Fortran Tutorial: https://docs.unidata.ucar.edu/netcdf-fortran/current/f90_The-NetCDF-Fortran-90-Interface-Guide.html
- v1.5.1 Sprint 2 for Fortran build integration patterns

## Risk Assessment
- **Fortran Availability**: Risk that netcdf-fortran not available in all CI environments
  - Mitigation: Conditional build ensures graceful skip when unavailable
- **Array Order Confusion**: Risk of incorrect data layout due to column-major order
  - Mitigation: Clear documentation and careful data generation loop
- **API Differences**: Risk of using wrong API functions (nc_* vs nf90_*)
  - Mitigation: Reference existing Fortran examples for correct API usage
- **Cross-Language Validation**: Risk that C and Fortran versions produce different output
  - Mitigation: Explicit validation step comparing ncdump outputs

## Success Metrics
- Program compiles without warnings when Fortran enabled
- Test passes 100% of the time in CI (when Fortran enabled)
- ncdump output identical to C version
- Code is under 200 lines (keeping it minimal)
- Documentation clear for Fortran/NetCDF beginners
- Graceful skip when Fortran disabled (no build failures)
