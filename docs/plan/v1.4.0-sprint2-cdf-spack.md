# v1.4.0 Sprint 2: Spack Package File for CDF - Implementation Plan

## Overview

**Goal**: Create a Spack package for NASA CDF library and test it with CI workflow.

**Duration**: 1 week

**Deliverables**:
- `spack/cdf/package.py` - Spack package for NASA CDF library
- `.github/workflows/spack-cdf.yml` - CI workflow to test CDF package
- CDF package tested locally with Spack
- PR submitted to spack/spack-packages repository

## Prerequisites

- v1.4.0 Sprint 1 complete (NEP Spack package submitted)
- Spack installed and configured locally
- Understanding of CDF build system from `.github/workflows/ci.yml`

## Phase 1: Create CDF Spack Package

### Task 1.1: Calculate CDF Checksum
- **Command**: Download and calculate SHA256 for CDF 3.9.1
- **Requirements**:
  ```bash
  curl -sL https://spdf.gsfc.nasa.gov/pub/software/cdf/dist/cdf39_1/cdf39_1-dist-cdf.tar.gz | sha256sum
  ```
- **Acceptance Criteria**:
  - [ ] SHA256 checksum calculated and verified
  - [ ] Checksum documented for use in package.py

### Task 1.2: Create Package Directory Structure
- **Directory**: `spack/cdf/`
- **Requirements**:
  - Create directory following lowercase Spack naming convention
  - Matches pattern used for NEP: `spack/NEP/package.py`
- **Acceptance Criteria**:
  - [ ] Directory `spack/cdf/` exists
  - [ ] Ready to receive `package.py` file

### Task 1.3: Write CDF Package File
- **File**: `spack/cdf/package.py`
- **Requirements**:
  - Inherit from `MakefilePackage` base class
  - Import: `from spack_repo.builtin.build_systems.makefile import MakefilePackage`
  - Class name: `Cdf` (capitalized)
  - Homepage: `https://cdf.gsfc.nasa.gov/`
  - URL: `https://spdf.gsfc.nasa.gov/pub/software/cdf/dist/cdf39_1/cdf39_1-dist-cdf.tar.gz`
  - Version: `3.9.1` with SHA256 checksum from Task 1.1
  - Maintainer: `edhartnett`
  - License: Check CDF distribution for license type
  - No variants in initial implementation
  - No dependencies beyond system compiler
- **Implementation Details**:
  ```python
  def edit(self, spec, prefix):
      # CDF build system doesn't need editing
      pass
  
  def build(self, spec, prefix):
      # CDF requires OS and ENV parameters
      make("OS=linux", "ENV=gnu", "all")
  
  def install(self, spec, prefix):
      # CDF uses INSTALLDIR parameter
      make("INSTALLDIR={0}".format(prefix), "install")
  ```
- **Acceptance Criteria**:
  - [ ] Package file created with correct structure
  - [ ] Imports use Spack v2.0 API format
  - [ ] Version and checksum specified
  - [ ] Build and install methods override MakefilePackage defaults
  - [ ] `spack style spack/cdf/package.py` passes (ignoring F405 warnings)

### Task 1.4: Test Package Locally
- **Requirements**:
  - Copy package to local spack-packages repository
  - Test spec resolution
  - Test installation
- **Commands**:
  ```bash
  # Copy to spack-packages
  cp spack/cdf/package.py ~/spack-packages/repos/spack_repo/builtin/packages/cdf/
  
  # Test spec
  spack spec cdf
  
  # Test installation
  spack install -v cdf
  ```
- **Acceptance Criteria**:
  - [ ] `spack spec cdf` resolves successfully
  - [ ] `spack install cdf` completes without errors
  - [ ] CDF libraries installed to prefix
  - [ ] `spack audit packages cdf` passes

## Phase 2: Create CI Testing Workflow

### Task 2.1: Create Workflow File
- **File**: `.github/workflows/spack-cdf.yml`
- **Requirements**:
  - Based on `.github/workflows/spack.yml` structure
  - Simplified to test CDF package only
  - Include lint and spec jobs
  - Include install job with `|| true` for debugging
- **Workflow Structure**:
  ```yaml
  name: Spack CDF CI
  
  on:
    push:
      branches: [main]
    pull_request:
      branches: [main]
  
  jobs:
    lint:
      # Style and audit checks
    
    spec:
      # Spec resolution check
    
    install:
      # Installation attempt (exits 0 even on failure)
  ```
- **Acceptance Criteria**:
  - [ ] Workflow file created
  - [ ] Triggers on PR and push to main
  - [ ] Three jobs: lint, spec, install

### Task 2.2: Implement Lint Job
- **Requirements**:
  - Clone Spack
  - Setup Spack environment
  - Copy CDF package to local repo
  - Run `spack style` (with || true for F405 warnings)
  - Run `spack audit packages cdf`
- **Acceptance Criteria**:
  - [ ] Lint job runs successfully
  - [ ] Style check executes (warnings allowed)
  - [ ] Audit check passes

### Task 2.3: Implement Spec Job
- **Requirements**:
  - Clone Spack
  - Setup Spack environment
  - Find system compilers
  - Copy CDF package to local repo
  - Run `spack spec cdf`
  - Display dependency tree
- **Acceptance Criteria**:
  - [ ] Spec job runs successfully
  - [ ] CDF package spec resolves
  - [ ] Dependency tree displayed

### Task 2.4: Implement Install Job
- **Requirements**:
  - Clone Spack
  - Setup Spack environment
  - Find system compilers
  - Copy CDF package to local repo
  - Run `spack install -v cdf 2>&1 | tee install.log || true`
  - Display last 200 lines of install log
  - Exit with success (0) regardless of install result
- **Key Command**:
  ```bash
  spack install -v cdf 2>&1 | tee spack_install_cdf.log || true
  echo "=== Installation attempt complete (check logs above) ==="
  ```
- **Acceptance Criteria**:
  - [ ] Install job always exits successfully
  - [ ] Install output captured in logs
  - [ ] Build errors visible for debugging
  - [ ] Job doesn't fail CI even if install fails

### Task 2.5: Test Workflow
- **Requirements**:
  - Push changes to branch
  - Verify workflow runs
  - Review logs for any issues
  - Iterate on package.py if needed
- **Acceptance Criteria**:
  - [ ] Workflow runs on PR
  - [ ] All jobs complete (green checkmarks)
  - [ ] Install logs show build progress
  - [ ] Any errors are debuggable from logs

## Phase 3: Submit to Spack Repository

### Task 3.1: Prepare for Submission
- **Requirements**:
  - Ensure package works locally
  - Ensure CI workflow passes
  - Remove `|| true` from install job once working
  - Update workflow to fail on install errors
- **Acceptance Criteria**:
  - [ ] Local install succeeds: `spack install cdf`
  - [ ] CI install job succeeds without `|| true`
  - [ ] All tests pass

### Task 3.2: Submit PR to spack-packages
- **Requirements**:
  - Fork spack/spack-packages if not already done
  - Create branch: `add-cdf-package`
  - Copy `spack/cdf/package.py` to `repos/spack_repo/builtin/packages/cdf/package.py`
  - Commit with message: `cdf: new package at 3.9.1`
  - Push to fork
  - Create PR to spack/spack-packages:develop
- **PR Description Template**:
  ```
  Add NASA CDF library package to Spack.
  
  NASA CDF (Common Data Format) is a self-describing data format for the 
  storage and manipulation of scalar and multidimensional data.
  
  **Features:**
  - Version 3.9.1
  - Custom Makefile build system
  - No external dependencies
  
  **Testing:**
  - [x] `spack audit packages cdf` passes
  - [x] `spack spec cdf` resolves correctly
  - [x] `spack install cdf` completes successfully
  ```
- **Acceptance Criteria**:
  - [ ] PR created in spack/spack-packages
  - [ ] PR description complete
  - [ ] Spack CI runs on PR
  - [ ] Ready for maintainer review

## Definition of Done

- [ ] `spack/cdf/package.py` created with MakefilePackage implementation
- [ ] Version 3.9.1 with valid SHA256 checksum
- [ ] Package inherits from MakefilePackage with overridden build/install methods
- [ ] `.github/workflows/spack-cdf.yml` workflow created
- [ ] Workflow includes lint, spec, and install jobs
- [ ] Install job uses `|| true` initially for debugging
- [ ] Package successfully installs locally: `spack install cdf`
- [ ] `spack audit packages cdf` passes
- [ ] `spack style spack/cdf/package.py` passes (F405 warnings acceptable)
- [ ] CI workflow passes (all jobs green)
- [ ] PR submitted to spack/spack-packages repository
- [ ] PR includes proper description and testing checklist

## Technical Notes

### CDF Build System
- Uses custom Makefile with OS and ENV parameters
- Not CMake or Autotools based
- Build: `make OS=linux ENV=gnu all`
- Install: `make INSTALLDIR=<prefix> install`
- Reference: `.github/workflows/ci.yml` lines 74-86

### Spack v2.0 API
- Import: `from spack_repo.builtin.build_systems.makefile import MakefilePackage`
- Also import: `from spack.package import *`
- Class name must match package name (capitalized): `class Cdf(MakefilePackage)`

### Testing Strategy
- Initial CI workflow uses `|| true` to always pass
- Allows manual debugging through CI logs
- Remove `|| true` once package installs successfully
- Then workflow will fail on real errors

### Common Issues
- CDF build may require specific compiler flags
- INSTALLDIR path must be absolute
- May need to set environment variables for build
- Check CI logs for specific error messages

## Risk Assessment

### Risk: CDF Build System Complexity
- **Impact**: Medium
- **Probability**: Medium
- **Mitigation**: Reference working CI build in `.github/workflows/ci.yml`. Start with exact commands that work in CI.

### Risk: Spack MakefilePackage Limitations
- **Impact**: Medium
- **Probability**: Low
- **Mitigation**: Override all necessary methods (edit, build, install). Use base Package class if MakefilePackage proves too restrictive.

### Risk: Platform-Specific Build Issues
- **Impact**: Low
- **Probability**: Medium
- **Mitigation**: Initial implementation targets Linux only (OS=linux). Can add platform detection in future sprint.

### Risk: Checksum Mismatch
- **Impact**: Low
- **Probability**: Low
- **Mitigation**: Calculate checksum locally and verify against multiple downloads. Document checksum calculation command.

## Success Metrics

- **Package Quality**: `spack audit packages cdf` passes with zero errors
- **Build Success**: Package installs successfully on Ubuntu (CI environment)
- **Code Quality**: `spack style` passes (F405 warnings acceptable)
- **Documentation**: Package includes homepage, description, and maintainer
- **CI Reliability**: Workflow runs successfully on every PR
- **Submission**: PR accepted by Spack maintainers (may require iterations)
