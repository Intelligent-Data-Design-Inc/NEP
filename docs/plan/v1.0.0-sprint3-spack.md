# v1.0.0 Sprint 3: Spack Support - Implementation Plan

## Overview

**Goal**: Add Spack package manager support for NEP to enable easy installation and dependency management in HPC environments.

**Duration**: 1-2 weeks

**Deliverables**:
- Spack package.py file for NEP
- Spack package documentation
- Testing verification similar to NCEPLIBS-g2c approach

## Prerequisites

- v1.0.0 Sprint 1 and Sprint 2 completed
- NEP v1.0.0 with LZ4 and BZIP2 compression functional
- Both CMake and Autotools build systems working
- Understanding of Spack package structure and conventions

## Phase 1: Spack Package Structure

### Task 1.1: Create Spack Package File
- **File**: `spack/package.py`
- **Requirements**:
  - Create package.py following Spack conventions
  - Inherit from both CMakePackage and AutotoolsPackage
  - Define package metadata (name, homepage, description, maintainers)
  - Add license information
- **Acceptance Criteria**:
  - [ ] Valid Python syntax
  - [ ] Follows Spack naming conventions (class Nep)
  - [ ] Includes all required metadata fields

### Task 1.2: Define Version Information
- **File**: `spack/package.py`
- **Requirements**:
  - Add version() directives for v1.0.0 release
  - Include GitHub release URL
  - Add SHA256 checksum for tarball verification
  - Support git development version
- **Acceptance Criteria**:
  - [ ] Version 1.0.0 defined with correct URL
  - [ ] Checksum placeholder for release tarball
  - [ ] Git version points to correct repository

## Phase 2: Dependency Specification

### Task 2.1: Define Required Dependencies
- **File**: `spack/package.py`
- **Requirements**:
  - Add depends_on() for netcdf-c (v4.9+)
  - Add depends_on() for hdf5 (v1.12+)
  - Add depends_on() for lz4
  - Add depends_on() for bzip2
  - Specify version constraints where needed
- **Acceptance Criteria**:
  - [ ] All required dependencies declared
  - [ ] Version constraints specified correctly
  - [ ] Dependencies match NEP requirements

### Task 2.2: Define Optional Dependencies
- **File**: `spack/package.py`
- **Requirements**:
  - Add conditional depends_on() for doxygen (when +docs)
  - Use when= clauses for variant-based dependencies
- **Acceptance Criteria**:
  - [ ] Doxygen dependency conditional on +docs variant
  - [ ] Proper when= syntax used

## Phase 3: Build System Integration

### Task 3.1: Implement CMake Build Configuration
- **File**: `spack/package.py`
- **Requirements**:
  - Implement cmake_args() method
  - Set CMAKE_INSTALL_PREFIX
  - Configure BUILD_DOCUMENTATION based on +docs variant
  - Handle dependency paths from Spack
- **Acceptance Criteria**:
  - [ ] cmake_args() method returns proper list of arguments
  - [ ] Installation prefix configured correctly
  - [ ] Documentation build controlled by variant
  - [ ] Dependency paths properly passed

### Task 3.2: Implement Autotools Build Configuration
- **File**: `spack/package.py`
- **Requirements**:
  - Implement configure_args() method
  - Set --prefix
  - Add --enable-lz4, --enable-bzip2, --enable-docs flags
  - Configure based on variants
- **Acceptance Criteria**:
  - [ ] configure_args() method returns proper list of arguments
  - [ ] Prefix configured correctly
  - [ ] Enable/disable flags match variants
  - [ ] All build options covered

## Phase 4: Variants and Options

### Task 4.1: Define Package Variants
- **File**: `spack/package.py`
- **Requirements**:
  - variant('docs', default=True, description='Build documentation')
  - variant('lz4', default=True, description='Enable LZ4 compression')
  - variant('bzip2', default=True, description='Enable BZIP2 compression')
  - variant('build_system', values=('cmake', 'autotools'), default='cmake')
- **Acceptance Criteria**:
  - [ ] All variants defined with proper syntax
  - [ ] Default values set appropriately
  - [ ] Descriptions are clear and accurate
  - [ ] Build system variant allows choice

## Phase 5: Testing Integration

### Task 5.1: Add Install Tests
- **File**: `spack/package.py`
- **Requirements**:
  - Implement test() method or install checks
  - Verify libh5lz4.so exists in lib/plugin/
  - Verify libh5bzip2.so exists in lib/plugin/
  - Check header files installed
- **Acceptance Criteria**:
  - [ ] Install checks verify plugin libraries
  - [ ] Header file installation verified
  - [ ] Tests follow Spack conventions

### Task 5.2: Add Smoke Tests
- **File**: `spack/package.py`
- **Requirements**:
  - Add basic functionality tests similar to NCEPLIBS-g2c
  - Test that plugins can be loaded
  - Verify HDF5_PLUGIN_PATH compatibility
- **Acceptance Criteria**:
  - [ ] Smoke tests verify basic functionality
  - [ ] Tests can run in Spack environment
  - [ ] Similar approach to NCEPLIBS-g2c testing

## Phase 6: Documentation

### Task 6.1: Create Spack Installation Documentation
- **File**: `docs/spack.md`
- **Requirements**:
  - Installation instructions via `spack install nep`
  - Variant usage examples
  - Integration with other Spack packages
  - Environment setup instructions
- **Acceptance Criteria**:
  - [ ] Clear installation instructions
  - [ ] All variants documented with examples
  - [ ] Integration examples provided
  - [ ] Troubleshooting section included

### Task 6.2: Update README with Spack Information
- **File**: `README.md`
- **Requirements**:
  - Add Spack installation section
  - Link to detailed Spack documentation
  - Show basic spack install command
- **Acceptance Criteria**:
  - [ ] Spack section added to Installation
  - [ ] Link to docs/spack.md included
  - [ ] Basic usage example provided

## Definition of Done

- [ ] spack/package.py created with all required components
- [ ] All dependencies properly declared
- [ ] Both CMake and Autotools build systems supported
- [ ] All variants defined and functional
- [ ] Install and smoke tests implemented
- [ ] Documentation complete (docs/spack.md and README.md)
- [ ] Package follows Spack conventions and best practices
- [ ] Testing approach similar to NCEPLIBS-g2c verified

## Technical Notes

### Spack Package Class Structure
```python
class Nep(CMakePackage, AutotoolsPackage):
    """NEP (NetCDF Expansion Pack) provides high-performance compression."""
    
    homepage = "https://github.com/Intelligent-Data-Design-Inc/NEP"
    url = "https://github.com/Intelligent-Data-Design-Inc/NEP/archive/v1.0.0.tar.gz"
    git = "https://github.com/Intelligent-Data-Design-Inc/NEP.git"
    
    maintainers("edhartnett")
    
    license("Apache-2.0")
    
    version("develop", branch="main")
    version("1.0.0", sha256="TBD")
```

### Build System Selection
Spack will use the `build_system` variant to choose between CMake and Autotools.

### Testing Reference
Look at NCEPLIBS-g2c Spack package for testing patterns:
- https://github.com/spack/spack/blob/develop/var/spack/repos/builtin/packages/nceplibs-g2c/package.py

## Risk Assessment

**Risk**: Spack package may not build correctly on all platforms
- **Mitigation**: Test on multiple platforms, follow Spack best practices

**Risk**: Dependency version conflicts with other Spack packages
- **Mitigation**: Use flexible version constraints, test with common package combinations

**Risk**: HDF5 plugin path may not be configured correctly
- **Mitigation**: Document HDF5_PLUGIN_PATH setup, provide examples

## Success Metrics

- [ ] Spack package installs successfully with default variants
- [ ] All variant combinations build and install correctly
- [ ] Install tests pass for all configurations
- [ ] Documentation is clear and complete
- [ ] Package follows Spack conventions (passes spack audit)
