# v1.3.0 Sprint 2 Implementation Plan

## Overview
- **Goal**: Add CDF test data file and test program using NASA CDF library
- **Sprint**: v1.3.0, Sprint 2
- **Primary Deliverables**:
  - Small CDF test data file added to repository in `test/data/`
  - Test program to open CDF file and print metadata using NASA CDF library
  - Test program only builds when CDF is enabled
  - Test integrated into CI for CDF-enabled builds
  - Test validates CDF library integration without UDF implementation

## Prerequisites
- v1.3.0 Sprint 1 complete: CDF library detection working in both build systems
- NASA CDF library v3.9.x available in CI environment
- CMake and Autotools support `-DENABLE_CDF=ON` and `--enable-cdf` options
- HAVE_CDF macro defined when CDF enabled

## Phase 1: Test Data Acquisition

### Task 1.1: Find and Add CDF Test Data File
- **File paths**:
  - `test/data/` (new CDF file to be added)
  - `test/CMakeLists.txt` (for data file copying)
  - `test/Makefile.am` (for data file distribution)
- **Requirements**:
  - Identify small, publicly available CDF data file (<1 MB preferred)
  - Sources to consider:
    - NASA SPDF data archive: https://spdf.gsfc.nasa.gov/
    - Sample CDF files from NASA CDF distribution
    - Create minimal synthetic CDF file if needed
  - Add CDF file to `test/data/` directory
  - Document data file source, format, and any licensing in README or comments
  - File should contain basic CDF structures (variables, attributes, dimensions)
- **Acceptance criteria**:
  - CDF test file committed to repository in `test/data/`
  - File size reasonable for version control (<1 MB)
  - File source documented
  - File contains representative CDF structures for testing

### Task 1.2: Configure Test Data File Copying
- **File paths**:
  - `test/CMakeLists.txt`
  - `test/Makefile.am`
- **Requirements**:
  - CMake: Add command to copy CDF test file from `test/data/` to build directory
  - Autotools: Add CDF test file to EXTRA_DIST for distribution
  - Mirror pattern used for existing test data files (e.g., GRIB2 test file)
  - Ensure test file available in build directory for test execution
- **Acceptance criteria**:
  - CMake build copies CDF test file to build directory
  - Autotools build includes CDF test file in distribution
  - Test file accessible at runtime in both build systems

## Phase 2: CDF Test Program Implementation

### Task 2.1: Create CDF Test Program Source
- **File paths**:
  - `test/tst_cdf_basic.c` (new file)
- **Requirements**:
  - Create C test program that uses NASA CDF library API
  - Program functionality:
    - Open the CDF test file using CDFopen() or CDFopenCDF()
    - Query and print basic file metadata:
      - CDF version and encoding
      - Number of variables (zVariables and rVariables)
      - Number of global attributes
      - Variable names and data types
      - Attribute names and values
    - Close the CDF file using CDFclose()
    - Return success (0) or failure (non-zero) exit code
  - Include proper error handling for all CDF API calls
  - Use CDF library error reporting functions (CDFerror, CDFstatusText)
  - Print informative messages for debugging
  - Keep program simple and focused on metadata reading
- **Acceptance criteria**:
  - Program compiles with CDF library headers
  - Program successfully opens CDF test file
  - Program prints meaningful metadata information
  - Program handles errors gracefully
  - Program returns appropriate exit codes

### Task 2.2: Add Test Program to CMake Build
- **File paths**:
  - `test/CMakeLists.txt`
- **Requirements**:
  - Add conditional compilation of `tst_cdf_basic.c` when ENABLE_CDF=ON
  - Create executable target: `tst_cdf_basic`
  - Link against CDF library
  - Set include directories for CDF headers
  - Add test to CTest when CDF enabled: `add_test(NAME tst_cdf_basic COMMAND tst_cdf_basic)`
  - Pass CDF test file path to program (via command line arg or environment variable)
  - Skip test when ENABLE_CDF=OFF
- **Acceptance criteria**:
  - Test program builds when `-DENABLE_CDF=ON`
  - Test program does not build when `-DENABLE_CDF=OFF`
  - Test executable links correctly with CDF library
  - Test registered with CTest when enabled
  - Test can locate and open test data file

### Task 2.3: Add Test Program to Autotools Build
- **File paths**:
  - `test/Makefile.am`
- **Requirements**:
  - Add conditional compilation of `tst_cdf_basic.c` when HAVE_CDF=yes
  - Use AM_CONDITIONAL to control build: `if HAVE_CDF`
  - Create test program target: `tst_cdf_basic`
  - Add CDF library to LDADD
  - Add CDF include path to AM_CPPFLAGS
  - Add test to TESTS variable when CDF enabled
  - Pass CDF test file path to program
  - Skip test when `--disable-cdf`
- **Acceptance criteria**:
  - Test program builds when `--enable-cdf`
  - Test program does not build when `--disable-cdf`
  - Test executable links correctly with CDF library
  - Test runs with `make check` when enabled
  - Test can locate and open test data file

## Phase 3: CI Integration

### Task 3.1: Add CDF Test Execution to CI
- **File paths**:
  - `.github/workflows/ci.yml`
- **Requirements**:
  - Add test execution step for CDF-enabled builds
  - CMake: Run `ctest` or `ctest -R tst_cdf_basic` in CDF-enabled configuration
  - Autotools: Run `make check` in CDF-enabled configuration
  - Capture test output for debugging
  - Fail CI if test fails
  - Skip test execution for CDF-disabled builds
- **Acceptance criteria**:
  - CI runs CDF test for CDF-enabled builds
  - CI skips CDF test for CDF-disabled builds
  - Test output visible in CI logs
  - CI fails if test returns non-zero exit code
  - Test execution time reasonable (<30 seconds)

### Task 3.2: Validate CI Test Execution
- **Requirements**:
  - Verify test runs successfully in CI for both CMake and Autotools
  - Confirm test output shows expected metadata from CDF file
  - Validate test does not run when CDF disabled
  - Check for any warnings or errors in test output
  - Ensure test does not interfere with other tests
- **Acceptance criteria**:
  - CI passes with CDF test for both build systems
  - Test output shows correct CDF metadata
  - No unexpected warnings or errors
  - Test execution isolated from other tests

## Phase 4: Documentation

### Task 4.1: Document CDF Test Program
- **File paths**:
  - `test/tst_cdf_basic.c` (inline comments)
  - `README.md` or `test/README.md` (test documentation)
- **Requirements**:
  - Add header comment to test program explaining purpose
  - Document test data file source and format
  - Explain how to run test manually (both build systems)
  - Document expected output
  - Note that test only validates CDF library integration, not UDF
- **Acceptance criteria**:
  - Test program well-commented
  - Test data file documented
  - Manual test execution documented
  - Purpose and scope clear

### Task 4.2: Update Build Documentation
- **File paths**:
  - `README.md`
  - `docs/design.md` (if applicable)
- **Requirements**:
  - Document new CDF test program in testing section
  - Explain that Sprint 2 adds CDF library validation test
  - Note that UDF implementation comes in Sprint 3
  - Update test matrix to include CDF test
- **Acceptance criteria**:
  - CDF test documented in appropriate files
  - Sprint 2 scope clear (library test, not UDF)
  - Test execution instructions clear

## Phase 5: Validation

### Task 5.1: Local Testing
- **Requirements**:
  - Build and run test locally with CMake and CDF enabled
  - Build and run test locally with Autotools and CDF enabled
  - Verify test does not build when CDF disabled
  - Confirm test output shows expected CDF metadata
  - Test with different CDF files if available
- **Acceptance criteria**:
  - Test builds and runs successfully locally for both build systems
  - Test output correct and informative
  - Test properly skipped when CDF disabled
  - No memory leaks or resource issues

### Task 5.2: CI Validation
- **Requirements**:
  - Push changes and verify CI passes
  - Check CI logs for test execution and output
  - Verify test runs for CDF-enabled configurations
  - Verify test skipped for CDF-disabled configurations
  - Confirm no new warnings or errors introduced
- **Acceptance criteria**:
  - All CI builds pass
  - CDF test executes successfully in CI
  - Test output visible and correct in CI logs
  - No regressions in other tests

## Definition of Done
- Small CDF test data file added to `test/data/` with documented source
- Test program `tst_cdf_basic.c` created that opens CDF file and prints metadata
- Test program builds conditionally when CDF enabled in both CMake and Autotools
- Test program integrated into test suites (CTest and `make check`)
- Test data file copied to build directory in both build systems
- CI executes CDF test for CDF-enabled builds
- Test passes in CI for both CMake and Autotools
- Documentation updated with test information
- All existing tests continue to pass
- No UDF implementation - library validation only

## Technical Notes (Quick Reference)
- **Test File Location**: `test/data/` (source), build directory (runtime)
- **Test Program**: `test/tst_cdf_basic.c`
- **CDF API Functions**: CDFopen/CDFopenCDF, CDFclose, CDFinquire, CDFgetAttrgEntry, etc.
- **Build Condition**: ENABLE_CDF (CMake) / HAVE_CDF (Autotools)
- **Test Execution**: `ctest` (CMake) / `make check` (Autotools)
- **Scope**: CDF library validation, not UDF testing
- **Data File Size**: <1 MB preferred for version control

## Risk Assessment
- **CDF Test Data Availability**:
  - Risk: Difficulty finding suitable small public CDF file
  - Mitigation: Can create minimal synthetic CDF file using CDF library tools; NASA SPDF has many examples
- **CDF API Complexity**:
  - Risk: CDF API may be complex for basic metadata reading
  - Mitigation: Use simple API calls; reference CDF documentation and examples; keep test focused
- **Test Data Licensing**:
  - Risk: CDF test data may have usage restrictions
  - Mitigation: Use NASA public data or create synthetic file; document source and licensing
- **Platform-Specific Issues**:
  - Risk: CDF library behavior may vary across platforms
  - Mitigation: Test on Linux (CI platform); document any platform-specific issues
- **Test Flakiness**:
  - Risk: Test may fail intermittently due to file I/O or environment issues
  - Mitigation: Use robust error handling; ensure test data file always available; validate locally before CI

## Success Metrics
- Test program successfully opens and reads CDF test file
- Test passes in CI for both CMake and Autotools CDF-enabled builds
- Test execution time <30 seconds
- Zero test failures in CDF-disabled configurations (test properly skipped)
- No new warnings or errors introduced
- Test output provides useful debugging information
- Documentation complete and clear

## Future Work (Sprint 3+)
- Sprint 3: Implement CDF UDF handler with hello-world functionality
- Sprint 4: Extend test to open CDF file via NetCDF API using UDF
- Sprint 4: Validate NetCDF metadata mapping from CDF structures
- Sprint 4: Validate data reading through UDF layer
