# v1.1.0 Sprint 1 Implementation Plan

## Overview
- **Goal**: Add Fortran wrappers for existing NEP compression functions from v1.0.0, integrate them into both CMake and Autotools build systems, and wire up basic Fortran smoke tests and CI, without changing existing C API behavior.
- **Sprint**: v1.1.0, Sprint 1
- **Primary Deliverables**:
  - Fortran-callable wrappers for v1.0.0 compression functions.
  - Build-system options to enable/disable Fortran in CMake and Autotools.
  - Fortran test suite skeleton in `ftest/` with smoke tests per wrapper.
  - CI integration for Fortran builds/tests, including disabled-Fortran configurations.

## Prerequisites
- v1.0.0 LZ4 compression implementation and tests are passing.
- CI already builds with NetCDF-Fortran available (as per existing workflow).
- Directory structure exists or will be created for:
  - `fsrc/` (Fortran source files).
  - `ftest/` (Fortran tests).

## Phase 1: Fortran Wrapper API Design and Skeleton

### Task 1.1: Identify Compression Functions to Wrap
- **File paths**:
  - Existing compression APIs in `src/` and headers in `include/` used by v1.0.0.
- **Requirements**:
  - Enumerate all public compression functions that should be exposed to Fortran.
  - Confirm mapping with PRD_2 requirements (v1.0.0 compression scope only).
- **Acceptance criteria**:
  - List of C functions and signatures to be wrapped is documented in this plan (or a short note file) and agreed to be in-scope for v1.1.0.

### Task 1.2: Define Fortran Naming and Calling Conventions
- **File paths**:
  - Design notes in `docs/plan/v1.1.0-sprint1.md` (this file) and/or a short companion design note if needed.
- **Requirements**:
  - Choose a consistent naming convention for Fortran entry points (e.g., module-based interfaces that call C bindings, or direct `bind(C)` interfaces with a prefix/suffix).
  - Define how error codes are returned (e.g., integer status argument, exceptions avoided).
  - Decide how arrays and buffers are passed (rank, kind, assumed-shape vs explicit-shape, etc.).
- **Acceptance criteria**:
  - Naming convention and argument passing rules are written down and can be applied consistently across all wrappers.

### Task 1.3: Create Fortran Wrapper Skeletons in `fsrc/`
- **File paths**:
  - `fsrc/nep_compress_wrappers.F90` (or similar central module file).
- **Requirements**:
  - Add minimal Fortran modules/interfaces for each in-scope C compression function.
  - Use `bind(C)` and types compatible with the existing C API where applicable.
  - Map error returns to the same NetCDF/NEP error codes as the C implementation.
- **Acceptance criteria**:
  - Fortran sources compile (when wired into the build) even if tests are not yet written.

## Phase 2: Build System Integration (CMake and Autotools)

### Task 2.1: Add CMake Fortran Option and Targets
- **File paths**:
  - `CMakeLists.txt`
  - Any Fortran-related subdirectory CMake files (e.g., `fsrc/CMakeLists.txt`, `ftest/CMakeLists.txt`) if added.
- **Requirements**:
  - Add `ENABLE_FORTRAN` cache option with default `ON`.
  - When `ENABLE_FORTRAN=ON`:
    - Enable Fortran language if required (`enable_language(Fortran)` as appropriate).
    - Add library/target for Fortran wrappers built from `fsrc/`.
  - When `ENABLE_FORTRAN=OFF`:
    - Do not configure or build any Fortran targets.
    - Do not add Fortran tests.
- **Acceptance criteria**:
  - CMake configure succeeds with `-DENABLE_FORTRAN=ON` and `-DENABLE_FORTRAN=OFF`.
  - Build works in both modes without touching Fortran when disabled.

### Task 2.2: Add Autotools Fortran Option and Rules
- **File paths**:
  - `configure.ac`
  - `fsrc/Makefile.am`
  - `ftest/Makefile.am`
  - Any top-level `Makefile.am` references.
- **Requirements**:
  - Add `--enable-fortran/--disable-fortran` configure options.
  - When Fortran is enabled:
    - Detect a Fortran compiler and NetCDF-Fortran.
    - Add build rules to compile and link `fsrc/` into a Fortran library (and/or objects linked into existing libraries).
  - When Fortran is disabled:
    - Do not build or install any Fortran objects/libraries.
    - Do not include Fortran test programs in the build.
- **Acceptance criteria**:
  - `./configure --enable-fortran` and `./configure --disable-fortran` both succeed.
  - `make` and `make install` work in both modes without stray Fortran objects when disabled.

### Task 2.3: Install and Export Rules for Fortran Components
- **File paths**:
  - Existing install rules in CMake and Autotools (same files as tasks 2.1/2.2).
- **Requirements**:
  - When Fortran is enabled, ensure Fortran modules/libraries are installed to a reasonable location with other NEP artifacts.
  - When Fortran is disabled, no Fortran modules/libraries are installed.
- **Acceptance criteria**:
  - Installation tree for Fortran-enabled builds contains expected Fortran artifacts.
  - Installation tree for disabled builds contains none.

## Phase 3: Fortran Tests and CI Integration

### Task 3.1: Create Fortran Smoke Tests in `ftest/`
- **File paths**:
  - `ftest/` directory (new or extended).
- **Requirements**:
  - For each exposed Fortran wrapper, add at least one simple test program that:
    - Calls the wrapper with valid arguments.
    - Performs a basic correctness check (e.g., compression succeeds, status == success code).
  - Use simple, self-contained test logic suitable for CI.
- **Acceptance criteria**:
  - All Fortran tests build and run successfully when Fortran is enabled.

### Task 3.2: Hook Fortran Tests into CMake/CTest
- **File paths**:
  - `CMakeLists.txt`
  - Any `ftest` CMake files.
- **Requirements**:
  - Register Fortran test executables with CTest when `ENABLE_FORTRAN=ON`.
  - Ensure tests are not defined or run when `ENABLE_FORTRAN=OFF`.
- **Acceptance criteria**:
  - `ctest` runs Fortran tests only in Fortran-enabled builds and reports them cleanly.

### Task 3.3: Hook Fortran Tests into Autotools Test Harness
- **File paths**:
  - `ftest/Makefile.am`
  - Any top-level `TESTS` or related variables.
- **Requirements**:
  - Add Fortran test programs to the Autotools test suite only when Fortran is enabled.
  - Ensure `make check` runs Fortran tests appropriately.
- **Acceptance criteria**:
  - `make check` passes with Fortran enabled and does not attempt Fortran tests when disabled.

### Task 3.4: Update CI Workflows for Fortran
- **File paths**:
  - GitHub Actions workflow(s) under `.github/workflows/`.
- **Requirements**:
  - Ensure at least one CI job builds with Fortran enabled for both CMake and Autotools and runs Fortran tests.
  - Ensure at least one CI job runs with Fortran disabled (to verify that configuration path).
  - Reuse existing NetCDF-Fortran, NetCDF-C, and HDF5 setup.
- **Acceptance criteria**:
  - CI succeeds in both Fortran-enabled and Fortran-disabled configurations.

## Phase 4: Validation and Cleanup

### Task 4.1: Backward Compatibility Validation
- **Requirements**:
  - Run existing v1.0.0 C-only tests with Fortran both enabled and disabled.
  - Confirm no API or behavior changes are introduced by presence of Fortran wrappers.
- **Acceptance criteria**:
  - All existing C-only tests pass in both configurations.

### Task 4.2: Documentation Cross-Check
- **File paths**:
  - `docs/roadmap.md` (v1.1.0 section).
  - `docs/prd_2.md` (v1.1.0 Fortran wrappers section).
- **Requirements**:
  - Verify implementation matches documented options, directories, and test/CI behavior.
- **Acceptance criteria**:
  - No discrepancies between implemented behavior and roadmap/PRD.

## Definition of Done
- Fortran wrappers for in-scope v1.0.0 compression functions implemented in `fsrc/`.
- CMake and Autotools both support default-on Fortran builds with:
  - CMake: `-DENABLE_FORTRAN=ON/OFF`.
  - Autotools: `--enable-fortran/--disable-fortran`.
- When Fortran is disabled:
  - No Fortran libraries/modules are built or installed.
  - No Fortran tests are built or run.
- Fortran smoke tests exist in `ftest/` for each wrapper and are hooked into CTest and Autotools tests.
- CI has at least one Fortran-enabled job and one Fortran-disabled job passing.
- Existing C-only tests pass in both configurations.

## Technical Notes (Quick Reference)
- **Directories**:
  - Fortran sources: `fsrc/`.
  - Fortran tests: `ftest/`.
- **Options**:
  - CMake: `-DENABLE_FORTRAN=ON/OFF` (default ON).
  - Autotools: `--enable-fortran/--disable-fortran` (default enabled).
- **Dependencies**:
  - Same as v1.0.0 compression (NetCDF-C, NetCDF-Fortran, HDF5, LZ4), plus Fortran compiler.

## Risk Assessment
- **Build System Complexity**:
  - Risk: CMake/Autotools logic for enabling/disabling Fortran becomes brittle.
  - Mitigation: Keep options centralized and add tests for both configurations in CI.
- **Fortran/C Interop Issues**:
  - Risk: Mismatched types, calling conventions, or error handling.
  - Mitigation: Use `bind(C)` consistently; mirror C signatures closely; add focused smoke tests.
- **CI Runtime Increase**:
  - Risk: Additional Fortran jobs lengthen CI.
  - Mitigation: Limit Fortran jobs to minimal representative matrix.

## Success Metrics
- All new Fortran tests pass in CI.
- All existing C-only tests pass with Fortran both enabled and disabled.
- No new CI failures introduced in unrelated jobs.
- Fortran wrappers are adopted in at least one example or internal workflow without changes to C APIs.
