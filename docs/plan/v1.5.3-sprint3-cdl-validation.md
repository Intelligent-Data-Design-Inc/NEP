# v1.5.3 Sprint 3 Implementation Plan: CDL Output Validation

## Overview
- **Goal**: Generate expected CDL baselines and implement automated validation for quickstart examples
- **Sprint**: v1.5.3, Sprint 3
- **Primary Deliverables**:
  - CDL reference files for both quickstart examples
  - Automated CDL comparison in CMake test suite
  - Automated CDL comparison in Autotools test suite
  - Documentation of validation approach and regeneration process
  - CI integration for regression testing

## Prerequisites
- v1.5.3 Sprint 1 complete (C quickstart working)
- v1.5.3 Sprint 2 complete (Fortran quickstart working)
- ncdump utility available in build environment
- Both examples producing NetCDF files successfully

## Phase 1: CDL Reference File Generation

### Task 1.1: Generate C Quickstart CDL Baseline
- **Requirements**:
  - Run quickstart program to create quickstart.nc
  - Execute `ncdump quickstart.nc` to generate CDL output
  - Capture output to file
  - Store in `examples/expected_output/quickstart_expected.cdl`
  - Verify CDL is complete and correct
  - Ensure consistent formatting (ncdump default format)
- **Commands**:
```bash
cd examples/classic
./quickstart
ncdump quickstart.nc > ../expected_output/quickstart_expected.cdl
```
- **Acceptance criteria**:
  - quickstart_expected.cdl created
  - File contains complete CDL representation
  - Dimensions, variables, attributes, and data all present
  - Format is standard ncdump output

### Task 1.2: Generate Fortran Quickstart CDL Baseline
- **Requirements**:
  - Run f_quickstart program to create f_quickstart.nc
  - Execute `ncdump f_quickstart.nc` to generate CDL output
  - Capture output to file
  - Store in `examples/expected_output/f_quickstart_expected.cdl`
  - Verify CDL is complete and correct
  - Verify output matches C version (except file name)
- **Commands**:
```bash
cd examples/f_classic
./f_quickstart
ncdump f_quickstart.nc > ../expected_output/f_quickstart_expected.cdl
```
- **Acceptance criteria**:
  - f_quickstart_expected.cdl created
  - File contains complete CDL representation
  - Output structurally identical to C version
  - Data values match C version

### Task 1.3: Create expected_output Directory Structure
- **File path**: `examples/expected_output/`
- **Requirements**:
  - Create directory if it doesn't exist
  - Add README.md explaining purpose of CDL files
  - Document that these are regression test baselines
  - Explain when and how to regenerate baselines
  - Add .gitignore for temporary test files (*.nc, *.tmp)
- **Acceptance criteria**:
  - Directory created with proper structure
  - README.md documents purpose and usage
  - Both CDL files stored in directory

### Task 1.4: Verify CDL File Correctness
- **Requirements**:
  - Manual inspection of both CDL files
  - Verify dimensions: X=2, Y=3
  - Verify variable: int data(X, Y)
  - Verify global attribute: description = "a quickstart example"
  - Verify variable attribute: data:units = "m/s"
  - Verify data values: 1, 2, 3, 4, 5, 6
  - Confirm both files are structurally identical
- **Acceptance criteria**:
  - Both CDL files contain correct metadata
  - Data values correct in both files
  - Files are structurally equivalent

## Phase 2: CMake Test Integration

### Task 2.1: Create CDL Comparison Test Script
- **File path**: `examples/test_cdl.sh` (or similar)
- **Requirements**:
  - Shell script that accepts three arguments:
    1. Example program path
    2. Output NetCDF file name
    3. Expected CDL file path
  - Execute example program
  - Run ncdump on generated NetCDF file
  - Compare ncdump output with expected CDL
  - Use diff for comparison
  - Exit with 0 on match, non-zero on mismatch
  - Print clear error messages showing differences
- **Script pattern**:
```bash
#!/bin/bash
set -e

PROGRAM=$1
OUTPUT_NC=$2
EXPECTED_CDL=$3

# Run the example program
$PROGRAM

# Generate CDL from output
ncdump $OUTPUT_NC > ${OUTPUT_NC}.cdl

# Compare with expected
if diff -u $EXPECTED_CDL ${OUTPUT_NC}.cdl; then
    echo "CDL validation passed for $OUTPUT_NC"
    rm -f $OUTPUT_NC ${OUTPUT_NC}.cdl
    exit 0
else
    echo "ERROR: CDL validation failed for $OUTPUT_NC"
    echo "Expected: $EXPECTED_CDL"
    echo "Got: ${OUTPUT_NC}.cdl"
    exit 1
fi
```
- **Acceptance criteria**:
  - Script created and executable
  - Accepts correct arguments
  - Runs example and ncdump
  - Compares output correctly
  - Clear error messages on failure

### Task 2.2: Update examples/classic/CMakeLists.txt
- **File path**: `examples/classic/CMakeLists.txt`
- **Requirements**:
  - Find ncdump utility using find_program()
  - Add custom test for quickstart with CDL validation
  - Use add_test() with script execution
  - Pass program path, output file, and expected CDL as arguments
  - Test should run in build directory
  - Ensure test only runs when BUILD_EXAMPLES=ON
- **CMake pattern**:
```cmake
# Find ncdump utility
find_program(NCDUMP_EXECUTABLE ncdump)

if(NCDUMP_EXECUTABLE)
  # Add CDL validation test for quickstart
  add_test(
    NAME quickstart_cdl
    COMMAND ${CMAKE_SOURCE_DIR}/examples/test_cdl.sh
            $<TARGET_FILE:quickstart>
            quickstart.nc
            ${CMAKE_SOURCE_DIR}/examples/expected_output/quickstart_expected.cdl
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
  )
  set_tests_properties(quickstart_cdl PROPERTIES
    DEPENDS quickstart
  )
endif()
```
- **Acceptance criteria**:
  - ncdump found by CMake
  - CDL validation test registered
  - Test runs after quickstart builds
  - Test executes in correct directory

### Task 2.3: Update examples/f_classic/CMakeLists.txt
- **File path**: `examples/f_classic/CMakeLists.txt`
- **Requirements**:
  - Similar to C version, add CDL validation for f_quickstart
  - Only add test when ENABLE_FORTRAN=ON
  - Use same test script with different arguments
  - Test should run in build directory
- **CMake pattern**:
```cmake
if(NCDUMP_EXECUTABLE AND ENABLE_FORTRAN)
  # Add CDL validation test for f_quickstart
  add_test(
    NAME f_quickstart_cdl
    COMMAND ${CMAKE_SOURCE_DIR}/examples/test_cdl.sh
            $<TARGET_FILE:f_quickstart>
            f_quickstart.nc
            ${CMAKE_SOURCE_DIR}/examples/expected_output/f_quickstart_expected.cdl
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
  )
  set_tests_properties(f_quickstart_cdl PROPERTIES
    DEPENDS f_quickstart
  )
endif()
```
- **Acceptance criteria**:
  - CDL validation test registered for Fortran
  - Test only runs when Fortran enabled
  - Test executes in correct directory

### Task 2.4: Test CMake CDL Validation
- **Requirements**:
  - Run `cmake -DBUILD_EXAMPLES=ON ..` to configure
  - Run `cmake --build .` to build
  - Run `ctest -R quickstart_cdl` to test C version
  - Run `ctest -R f_quickstart_cdl` to test Fortran version (if enabled)
  - Verify both tests pass
  - Verify clear error messages if validation fails
- **Acceptance criteria**:
  - CMake configuration succeeds
  - Both CDL validation tests pass
  - Tests produce clear output
  - Temporary files cleaned up on success

## Phase 3: Autotools Test Integration

### Task 3.1: Create Autotools Test Scripts
- **File paths**: 
  - `examples/classic/test_quickstart_cdl.sh`
  - `examples/f_classic/test_f_quickstart_cdl.sh`
- **Requirements**:
  - Create wrapper scripts for each example
  - Scripts execute example program
  - Run ncdump on generated file
  - Compare with expected CDL using diff
  - Exit 0 on success, non-zero on failure
  - Print clear error messages
  - Clean up temporary files on success
- **Script pattern for C version**:
```bash
#!/bin/bash
set -e

# Run quickstart
./quickstart

# Generate CDL
ncdump quickstart.nc > quickstart.cdl

# Compare with expected
if diff -u ../expected_output/quickstart_expected.cdl quickstart.cdl; then
    echo "CDL validation passed for quickstart"
    rm -f quickstart.nc quickstart.cdl
    exit 0
else
    echo "ERROR: CDL validation failed for quickstart"
    exit 1
fi
```
- **Acceptance criteria**:
  - Both scripts created and executable
  - Scripts run examples and validate CDL
  - Clear error messages on failure
  - Cleanup on success

### Task 3.2: Update examples/classic/Makefile.am
- **File path**: `examples/classic/Makefile.am`
- **Requirements**:
  - Add test_quickstart_cdl.sh to TESTS variable
  - Add script to EXTRA_DIST for distribution
  - Ensure script runs as part of `make check`
  - Script should be executable
- **Makefile.am pattern**:
```makefile
TESTS = quickstart test_quickstart_cdl.sh
EXTRA_DIST = test_quickstart_cdl.sh

# Make script executable
check-local:
	chmod +x $(srcdir)/test_quickstart_cdl.sh
```
- **Acceptance criteria**:
  - Test script added to TESTS
  - Script included in distribution
  - Script executable during make check

### Task 3.3: Update examples/f_classic/Makefile.am
- **File path**: `examples/f_classic/Makefile.am`
- **Requirements**:
  - Add test_f_quickstart_cdl.sh to TESTS variable (within Fortran conditional)
  - Add script to EXTRA_DIST
  - Ensure script only runs when Fortran enabled
  - Script should be executable
- **Makefile.am pattern**:
```makefile
if BUILD_FORTRAN
TESTS = f_quickstart test_f_quickstart_cdl.sh
EXTRA_DIST = test_f_quickstart_cdl.sh

check-local:
	chmod +x $(srcdir)/test_f_quickstart_cdl.sh
endif
```
- **Acceptance criteria**:
  - Test script added to TESTS (conditional)
  - Script included in distribution
  - Script only runs when Fortran enabled

### Task 3.4: Update examples/Makefile.am for expected_output
- **File path**: `examples/Makefile.am`
- **Requirements**:
  - Add expected_output directory to EXTRA_DIST
  - Ensure CDL files are included in distribution
  - Add README.md to distribution
- **Makefile.am pattern**:
```makefile
EXTRA_DIST = expected_output/quickstart_expected.cdl \
             expected_output/f_quickstart_expected.cdl \
             expected_output/README.md
```
- **Acceptance criteria**:
  - Expected CDL files included in distribution
  - Files available during make check

### Task 3.5: Test Autotools CDL Validation
- **Requirements**:
  - Run `./configure --enable-examples` to configure
  - Run `make` to build
  - Run `make check` to execute tests
  - Verify quickstart CDL validation passes
  - Verify f_quickstart CDL validation passes (if Fortran enabled)
  - Verify clear error messages if validation fails
- **Acceptance criteria**:
  - Autotools configuration succeeds
  - Both CDL validation tests pass
  - Tests produce clear output
  - Temporary files cleaned up on success

## Phase 4: Documentation

### Task 4.1: Create examples/expected_output/README.md
- **File path**: `examples/expected_output/README.md`
- **Requirements**:
  - Explain purpose of CDL reference files
  - Document that these are regression test baselines
  - Explain CDL validation process
  - Document how to regenerate CDL files when intentional changes occur
  - Add troubleshooting section for validation failures
  - Explain when regeneration is needed vs when it indicates a bug
- **Content outline**:
  - Purpose: Regression testing for example outputs
  - What are CDL files: NetCDF Common Data Language representation
  - How validation works: ncdump + diff comparison
  - When to regenerate: Intentional changes to examples
  - How to regenerate: Step-by-step instructions
  - Troubleshooting: Common validation failures and solutions
- **Acceptance criteria**:
  - README created with comprehensive documentation
  - Clear instructions for regeneration
  - Troubleshooting guidance included

### Task 4.2: Update examples/README.md
- **File path**: `examples/README.md`
- **Requirements**:
  - Add section on CDL validation
  - Explain that examples include automated output validation
  - Reference expected_output/README.md for details
  - Document that validation runs automatically in test suite
  - Explain purpose of regression testing
- **Content additions**:
  - CDL Validation section
  - Explanation of automated testing
  - Link to expected_output/README.md
  - Benefits of regression testing
- **Acceptance criteria**:
  - README updated with CDL validation section
  - Clear explanation of validation approach
  - Reference to detailed documentation

### Task 4.3: Add Comments to Test Scripts
- **Requirements**:
  - Add header comments to all test scripts
  - Explain purpose of each script
  - Document expected behavior
  - Document exit codes
  - Add usage examples
- **Acceptance criteria**:
  - All scripts have clear header comments
  - Purpose and usage documented
  - Exit codes explained

## Phase 5: CI Integration and Validation

### Task 5.1: Verify ncdump Available in CI
- **File path**: `.github/workflows/ci.yml`
- **Requirements**:
  - Verify ncdump is available in CI environment
  - ncdump should be part of NetCDF-C installation
  - Add explicit check if needed
  - Document ncdump dependency
- **Acceptance criteria**:
  - ncdump available in CI
  - No additional installation needed
  - Tests can run successfully

### Task 5.2: Test CDL Validation in CI
- **Requirements**:
  - Push changes to trigger CI
  - Verify quickstart_cdl test runs in CMake builds
  - Verify f_quickstart_cdl test runs in CMake builds (when Fortran enabled)
  - Verify CDL validation runs in Autotools builds
  - Check CI logs for test execution
  - Verify tests pass
- **Acceptance criteria**:
  - CI runs CDL validation tests
  - All tests pass in CI
  - Test output visible in CI logs
  - No CI failures related to CDL validation

### Task 5.3: Test Failure Scenarios
- **Requirements**:
  - Intentionally modify example to produce different output
  - Verify CDL validation detects the change
  - Verify clear error messages in test output
  - Verify diff output shows actual differences
  - Restore original example
- **Acceptance criteria**:
  - Validation correctly detects changes
  - Error messages are clear and helpful
  - Diff output shows what changed
  - Tests pass after restoration

### Task 5.4: Test CDL Regeneration Process
- **Requirements**:
  - Follow documented regeneration process
  - Make intentional change to example
  - Regenerate CDL baseline
  - Verify tests pass with new baseline
  - Document any issues with regeneration process
- **Acceptance criteria**:
  - Regeneration process works as documented
  - Tests pass with regenerated baselines
  - Process is straightforward

## Phase 6: Final Validation

### Task 6.1: Cross-Platform Testing
- **Requirements**:
  - Test on Linux (primary CI platform)
  - Test locally if different platform available
  - Verify CDL format is consistent across platforms
  - Verify diff works correctly on all platforms
- **Acceptance criteria**:
  - Tests pass on all tested platforms
  - CDL format consistent
  - No platform-specific issues

### Task 6.2: Complete Build Matrix Testing
- **Requirements**:
  - Test all build configurations:
    - CMake with examples ON
    - CMake with examples OFF (no CDL tests)
    - Autotools with examples enabled
    - Autotools with examples disabled (no CDL tests)
    - Fortran ON and OFF variants
  - Verify CDL tests only run when appropriate
  - Verify no build failures in any configuration
- **Acceptance criteria**:
  - All configurations build successfully
  - CDL tests run only when examples enabled
  - No unexpected test failures

### Task 6.3: Documentation Review
- **Requirements**:
  - Review all documentation for accuracy
  - Verify regeneration instructions work
  - Check for typos and clarity
  - Ensure troubleshooting section is helpful
- **Acceptance criteria**:
  - Documentation accurate and complete
  - Instructions tested and working
  - Clear and helpful for users

## Definition of Done
- [ ] CDL reference files generated for both quickstart examples
- [ ] quickstart_expected.cdl stored in examples/expected_output/
- [ ] f_quickstart_expected.cdl stored in examples/expected_output/
- [ ] expected_output/README.md created with comprehensive documentation
- [ ] CMake CDL validation tests implemented for both examples
- [ ] Autotools CDL validation tests implemented for both examples
- [ ] Test scripts created and executable
- [ ] examples/README.md updated with CDL validation section
- [ ] All test scripts have clear documentation
- [ ] CDL validation runs automatically in both build systems
- [ ] Tests pass in CI for both CMake and Autotools
- [ ] Clear error messages on validation failures
- [ ] Temporary files cleaned up after tests
- [ ] Regeneration process documented and tested
- [ ] Troubleshooting guidance provided
- [ ] All build configurations tested and passing
- [ ] Cross-platform compatibility verified

## Technical Notes
- **ncdump utility**: Part of NetCDF-C, should be available wherever NetCDF-C is installed
- **Comparison method**: diff -u for unified diff output showing differences
- **CDL format**: Standard ncdump output format (human-readable)
- **Test execution**: Tests run after example programs build
- **Cleanup**: Temporary .nc and .cdl files removed on success, kept on failure for debugging
- **Exit codes**: 0=success, non-zero=failure (standard test convention)
- **Dependencies**: Tests depend on example programs building successfully

## Expected CDL Content (Both Examples)
```
netcdf quickstart {  // or f_quickstart
dimensions:
	X = 2 ;
	Y = 3 ;
variables:
	int data(X, Y) ;
		data:units = "m/s" ;

// global attributes:
		:description = "a quickstart example" ;
data:

 data =
  1, 2, 3,
  4, 5, 6 ;
}
```

## Test Script Locations
- **CMake generic script**: `examples/test_cdl.sh`
- **Autotools C script**: `examples/classic/test_quickstart_cdl.sh`
- **Autotools Fortran script**: `examples/f_classic/test_f_quickstart_cdl.sh`
- **Expected CDL files**: `examples/expected_output/*.cdl`
- **Documentation**: `examples/expected_output/README.md`

## References
- v1.5.2 Sprint 3 for CDL validation patterns (groups examples)
- ncdump documentation: https://docs.unidata.ucar.edu/netcdf-c/current/ncdump_guide.html
- CDL format: https://docs.unidata.ucar.edu/netcdf-c/current/netcdf_working_with_netcdf_files.html#cdl_guide
- CMake add_test: https://cmake.org/cmake/help/latest/command/add_test.html
- Autotools testing: https://www.gnu.org/software/automake/manual/html_node/Tests.html

## Risk Assessment
- **ncdump Availability**: Risk that ncdump not available in some environments
  - Mitigation: ncdump is part of NetCDF-C, should always be available; graceful skip if not found
- **Platform Differences**: Risk of platform-specific CDL format differences
  - Mitigation: ncdump format is standardized; test on multiple platforms
- **Whitespace Sensitivity**: Risk that diff fails due to minor whitespace differences
  - Mitigation: Use diff -u for better output; consider diff -w if needed
- **Regeneration Confusion**: Risk that users don't know when to regenerate baselines
  - Mitigation: Clear documentation with examples of when regeneration is appropriate
- **Test Ordering**: Risk that CDL tests run before examples build
  - Mitigation: Use test dependencies in CMake; proper ordering in Autotools

## Success Metrics
- CDL validation tests pass 100% of the time in CI
- Zero false positives (tests fail only when output actually changes)
- Clear error messages help developers identify issues quickly
- Regeneration process takes <5 minutes
- Documentation enables users to understand and maintain validation
- No build failures in any configuration
- Tests catch regressions in example output
