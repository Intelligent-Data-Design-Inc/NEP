# v1.3.0 Sprint 3 Implementation Plan

## Overview
- **Goal**: Integrate CDF UDF handler into both build systems with commented-out function bodies
- **Sprint**: v1.3.0, Sprint 3
- **Primary Deliverables**:
  - CDF UDF handler library (`libnccdf`) integrated into CMake build system
  - CDF UDF handler library (`libnccdf.la`) integrated into Autotools build system
  - All CDF source files updated with proper attribution and copyright
  - Function bodies commented out but code compiles successfully
  - Library builds conditionally when CDF enabled
  - CI validates library build and installation

## Prerequisites
- v1.3.0 Sprint 1 complete: CDF library detection working in both build systems
- v1.3.0 Sprint 2 complete: CDF test program validates library integration
- NASA CDF library v3.9.x available and detected when ENABLE_CDF=ON
- Existing CDF source files present:
  - `src/cdfdispatch.c`, `src/cdffile.c`, `src/cdffunc.c`, `src/cdfvar.c`
  - `include/cdfdispatch.h`
- HAVE_CDF macro defined when CDF enabled

## Phase 1: Code Attribution and Preparation

### Task 1.1: Update CDF Source File Headers
- **File paths**:
  - `src/cdfdispatch.c`
  - `src/cdffile.c`
  - `src/cdffunc.c`
  - `src/cdfvar.c`
- **Requirements**:
  - Update all `@author` tags to: `Edward Hartnett` (consistent spelling, no "Ed")
  - Add or update `@date` tags to: `2025-11-23`
  - Add copyright line to file header: `@copyright Intelligent Data Design, Inc. All rights reserved.`
  - Maintain existing Doxygen comment structure
  - Preserve file-level documentation describing purpose
  - Ensure header includes remain intact
- **Acceptance criteria**:
  - All author tags standardized to "Edward Hartnett"
  - All date tags set to 2025-11-23
  - Copyright notice present in all four source files
  - Doxygen comments well-formed and complete

### Task 1.2: Update CDF Header File
- **File paths**:
  - `include/cdfdispatch.h`
- **Requirements**:
  - Update `@author` tag to: `Edward Hartnett`
  - Update or add `@date` tag to: `2025-11-23`
  - Add copyright line: `@copyright Intelligent Data Design, Inc. All rights reserved.`
  - Verify include guards are correct (`#ifndef _CDFDISPATCH_H`)
  - Verify extern "C" blocks present for C++ compatibility
  - Update header documentation to reflect CDF UDF handler purpose
  - Ensure all function prototypes are properly documented
- **Acceptance criteria**:
  - Header attribution updated consistently
  - Include guards correct
  - C++ compatibility maintained
  - All prototypes documented

### Task 1.3: Comment Out Function Bodies
- **File paths**:
  - `src/cdffile.c`
  - `src/cdffunc.c`
  - `src/cdfvar.c`
- **Requirements**:
  - Comment out main function bodies in all CDF implementation files
  - Leave function signatures and declarations intact
  - Preserve all header includes and type definitions
  - Keep NC_Dispatch structure initialization in `cdfdispatch.c` (do NOT comment out)
  - Add placeholder return statements where needed (e.g., `return NC_ENOTNC4;` or `return NC_NOERR;`)
  - Add comments indicating functions are stubbed for Sprint 3
  - Ensure code compiles without errors or warnings
- **Example pattern**:
  ```c
  int NC_CDF_open(const char *path, int mode, int basepe, size_t *chunksizehintp,
                   void *parameters, const NC_Dispatch *dispatch, int ncid)
  {
      /* Function body commented out for v1.3.0 Sprint 3 - UDF skeleton only */
      /* Implementation will be added in Sprint 4 */
      return NC_ENOTNC4; /* Placeholder return */
  }
  ```
- **Acceptance criteria**:
  - All function bodies commented out except dispatch table initialization
  - Code compiles without errors
  - Functions return appropriate placeholder error codes
  - Comments explain stubbed state

## Phase 2: CMake Build System Integration

### Task 2.1: Add CDF UDF Library to CMake
- **File paths**:
  - `src/CMakeLists.txt`
- **Requirements**:
  - Add conditional CDF library build when `HAVE_CDF` is TRUE
  - Follow GRIB2 pattern (currently commented out at lines 26-46)
  - Library name: `nccdf` (creates `libnccdf.so`)
  - Source files: `cdfdispatch.c cdffile.c cdffunc.c cdfvar.c`
  - Link libraries: `${HDF5_C_${LIB_TYPE}_LIBRARY} ${NETCDF_LIBRARIES} ${CDF_LIBRARY}`
  - Set library properties:
    - VERSION: `${PROJECT_VERSION}`
    - SOVERSION: `1`
    - INSTALL_RPATH: `${CMAKE_INSTALL_PREFIX}/${CMAKE_INSTALL_LIBDIR}`
    - INSTALL_RPATH_USE_LINK_PATH: `TRUE`
  - Install target to NEPTargets export
  - Add status message: `"Building CDF UDF library: ${CDF_LIB_NAME}"`
- **Code pattern**:
  ```cmake
  # CDF UDF Handler - v1.3.0 Sprint 3
  if(HAVE_CDF)
      set(CDF_LIB_NAME nccdf)
      add_library(${CDF_LIB_NAME} SHARED 
          cdfdispatch.c cdffile.c cdffunc.c cdfvar.c)
      target_link_libraries(${CDF_LIB_NAME} PRIVATE 
          ${HDF5_C_${LIB_TYPE}_LIBRARY} ${NETCDF_LIBRARIES} ${CDF_LIBRARY})
      set_target_properties(${CDF_LIB_NAME} PROPERTIES 
          VERSION ${PROJECT_VERSION}
          SOVERSION 1
          INSTALL_RPATH "${CMAKE_INSTALL_PREFIX}/${CMAKE_INSTALL_LIBDIR}"
          INSTALL_RPATH_USE_LINK_PATH TRUE
      )
      install(TARGETS ${CDF_LIB_NAME}
          EXPORT NEPTargets
          LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
      )
      message(STATUS "Building CDF UDF library: ${CDF_LIB_NAME}")
  endif()
  ```
- **Acceptance criteria**:
  - CDF library builds when `-DENABLE_CDF=ON`
  - Library does not build when `-DENABLE_CDF=OFF`
  - `libnccdf.so` created in build directory
  - Library links against all required dependencies
  - No compilation errors or warnings

### Task 2.2: Verify CMake Include Directories
- **File paths**:
  - `src/CMakeLists.txt`
- **Requirements**:
  - Verify CDF include directory already added in root CMakeLists.txt (line 93)
  - Confirm include paths set correctly for CDF library target
  - Existing include directories should be sufficient:
    - `${CMAKE_BINARY_DIR}/include`
    - `${CMAKE_SOURCE_DIR}/include`
    - `${CMAKE_BINARY_DIR}`
    - `${CMAKE_SOURCE_DIR}`
    - `${CDF_INCLUDE_DIR}` (from root CMakeLists.txt)
- **Acceptance criteria**:
  - CDF headers found during compilation
  - No missing header errors
  - Include paths properly configured

## Phase 3: Autotools Build System Integration

### Task 3.1: Add CDF UDF Library to Autotools
- **File paths**:
  - `src/Makefile.am`
- **Requirements**:
  - Add conditional CDF library build when `HAVE_CDF` is true
  - Follow GRIB2 pattern (currently commented out at lines 20-29)
  - Library name: `libnccdf.la` (libtool library)
  - Source files: `cdfdispatch.c cdffile.c cdffunc.c cdfvar.c`
  - Link flags: `$(HDF5_LIBS) $(NETCDF_LIBS) $(CDF_LIBS)`
  - Version info: `-version-info 1:0:0`
  - Conditional build using `if HAVE_CDF ... endif`
- **Code pattern**:
  ```makefile
  # CDF UDF Handler - v1.3.0 Sprint 3
  if HAVE_CDF
  lib_LTLIBRARIES += libnccdf.la
  libnccdf_la_LDFLAGS = -version-info 1:0:0
  libnccdf_la_SOURCES = cdfdispatch.c cdffile.c cdffunc.c cdfvar.c
  libnccdf_la_LIBADD = $(HDF5_LIBS) $(NETCDF_LIBS) $(CDF_LIBS)
  endif
  ```
- **Acceptance criteria**:
  - CDF library builds when `--enable-cdf`
  - Library does not build when `--disable-cdf`
  - `libnccdf.la` and `libnccdf.so` created
  - Library links against all required dependencies
  - No compilation errors or warnings

### Task 3.2: Verify Autotools Configuration
- **File paths**:
  - `configure.ac`
  - `src/Makefile.am`
- **Requirements**:
  - Verify CDF_LIBS variable set in configure.ac (Sprint 1)
  - Verify HAVE_CDF conditional defined (Sprint 1)
  - Verify AM_CPPFLAGS includes CDF include path
  - Confirm all necessary autotools variables available
- **Acceptance criteria**:
  - CDF_LIBS properly defined
  - HAVE_CDF conditional works
  - Include paths correct
  - Library builds successfully

## Phase 4: Build Verification and Testing

### Task 4.1: Local CMake Build Testing
- **Requirements**:
  - Build with `-DENABLE_CDF=ON` and verify `libnccdf.so` created
  - Build with `-DENABLE_CDF=OFF` and verify library not built
  - Check library installation with `make install`
  - Verify library installed to correct location
  - Check library dependencies with `ldd libnccdf.so`
  - Confirm no undefined symbols
- **Acceptance criteria**:
  - Library builds successfully when enabled
  - Library not built when disabled
  - Installation works correctly
  - All dependencies resolved
  - No undefined symbols

### Task 4.2: Local Autotools Build Testing
- **Requirements**:
  - Build with `--enable-cdf` and verify `libnccdf.la` created
  - Build with `--disable-cdf` and verify library not built
  - Check library installation with `make install`
  - Verify library installed to correct location
  - Check library dependencies with `ldd .libs/libnccdf.so`
  - Confirm no undefined symbols
- **Acceptance criteria**:
  - Library builds successfully when enabled
  - Library not built when disabled
  - Installation works correctly
  - All dependencies resolved
  - No undefined symbols

### Task 4.3: Verify Compilation Output
- **Requirements**:
  - Check for compilation warnings (should be zero)
  - Verify all source files compiled
  - Check linker output for errors
  - Confirm library versioning correct
  - Validate RPATH/RUNPATH settings
- **Acceptance criteria**:
  - Zero compilation warnings
  - All source files compiled
  - No linker errors
  - Library version matches project version
  - RPATH configured correctly

## Phase 5: CI Integration

### Task 5.1: Verify CI Build Configuration
- **File paths**:
  - `.github/workflows/ci.yml`
- **Requirements**:
  - Verify CI already builds with CDF enabled (Sprint 1)
  - Confirm CDF library available in CI environment
  - Check that both CMake and Autotools builds exercise CDF
  - Verify build logs show CDF library compilation
  - No changes to CI workflow needed (library build automatic when CDF enabled)
- **Acceptance criteria**:
  - CI builds CDF library for CDF-enabled configurations
  - Build logs show "Building CDF UDF library: nccdf" message
  - Library compilation successful in CI
  - No CI configuration changes needed

### Task 5.2: Validate CI Library Build
- **Requirements**:
  - Push changes and monitor CI execution
  - Verify CDF library builds in CI for both build systems
  - Check CI logs for library creation and installation
  - Confirm no new warnings or errors
  - Validate library installed to correct location in CI
- **Acceptance criteria**:
  - CI passes for all configurations
  - CDF library builds successfully in CI
  - Library installation verified in CI logs
  - No regressions in other builds
  - No new warnings or errors

## Phase 6: Documentation

### Task 6.1: Update Build Documentation
- **File paths**:
  - `README.md`
  - `docs/prd.md` (if applicable)
- **Requirements**:
  - Document CDF UDF handler library availability
  - Explain that Sprint 3 adds build-only integration (stubbed functions)
  - Note that functional implementation comes in Sprint 4
  - Update build instructions to mention `libnccdf` library
  - Document library location after installation
- **Acceptance criteria**:
  - CDF UDF handler documented
  - Sprint 3 scope clear (build integration, stubbed functions)
  - Build instructions updated
  - Installation paths documented

### Task 6.2: Add Code Comments
- **File paths**:
  - `src/CMakeLists.txt`
  - `src/Makefile.am`
- **Requirements**:
  - Add comments explaining CDF library build section
  - Note Sprint 3 integration
  - Reference Sprint 4 for functional implementation
  - Document library name and purpose
- **Acceptance criteria**:
  - Build files well-commented
  - Sprint context clear
  - Purpose documented

## Definition of Done
- All CDF source files updated with correct author, date, and copyright
- Function bodies commented out in `cdffile.c`, `cdffunc.c`, `cdfvar.c`
- Dispatch table initialization preserved in `cdfdispatch.c`
- CDF UDF library (`libnccdf`) builds in CMake when `ENABLE_CDF=ON`
- CDF UDF library (`libnccdf.la`) builds in Autotools when `--enable-cdf`
- Library links against HDF5, NetCDF-C, and NASA CDF library
- Library installs to correct location with proper RPATH
- Library does not build when CDF disabled
- CI builds and installs CDF library successfully
- Zero compilation warnings or errors
- No undefined symbols in library
- Documentation updated with CDF UDF handler information
- All existing tests continue to pass
- No functional UDF implementation - build skeleton only

## Technical Notes (Quick Reference)
- **Library Name**: `libnccdf` (CMake: `libnccdf.so`, Autotools: `libnccdf.la`)
- **Source Files**: `cdfdispatch.c`, `cdffile.c`, `cdffunc.c`, `cdfvar.c`
- **Header File**: `include/cdfdispatch.h`
- **Dependencies**: HDF5, NetCDF-C, NASA CDF library
- **Build Condition**: ENABLE_CDF=ON (CMake) / HAVE_CDF (Autotools)
- **Installation Path**: `${CMAKE_INSTALL_LIBDIR}` or `${prefix}/lib`
- **Library Version**: Matches project version, SOVERSION 1
- **Scope**: Build integration only, functions stubbed
- **Reference Pattern**: GRIB2 UDF handler (commented out in current codebase)

## Risk Assessment
- **Compilation Errors**:
  - Risk: Stubbed functions may not compile due to missing includes or types
  - Mitigation: Preserve all includes and type definitions; test compilation early
- **Linking Issues**:
  - Risk: CDF library may not link correctly with HDF5/NetCDF
  - Mitigation: Follow GRIB2 pattern; verify dependencies with ldd; test locally first
- **Header Dependencies**:
  - Risk: CDF code may reference NetCDF internal headers not available
  - Mitigation: Review includes; adjust if needed; reference netcdf-c/libhdf4 example
- **Build System Differences**:
  - Risk: CMake and Autotools builds may diverge
  - Mitigation: Test both build systems locally; verify same source files and flags used
- **CI Environment**:
  - Risk: CI may not have all necessary headers or libraries
  - Mitigation: Sprint 1 already validated CDF library in CI; should work
- **Undefined Symbols**:
  - Risk: Stubbed functions may reference undefined symbols
  - Mitigation: Comment out function bodies completely; use simple placeholder returns

## Success Metrics
- Library builds successfully in both build systems when CDF enabled
- Zero compilation warnings or errors
- Zero undefined symbols in library
- Library installs to correct location
- CI passes for all configurations
- Library does not build when CDF disabled
- All existing tests continue to pass
- Documentation complete and accurate
- Code attribution consistent and correct

## Future Work (Sprint 4)
- Sprint 4: Implement NC_CDF_open() function to open CDF files
- Sprint 4: Implement NC_CDF_close() function
- Sprint 4: Implement metadata reading functions
- Sprint 4: Create test that opens CDF file via NetCDF API using UDF
- Sprint 4: Validate NetCDF metadata mapping from CDF structures
- Sprint 4: Validate data reading through UDF layer
