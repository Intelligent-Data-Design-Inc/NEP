# v1.6.0 Phase 4: GeoTIFF CRS and Georeferencing Implementation

## Overview

Implement Phase 4 of the GeoTIFF read layer for NEP v1.5.0: Extract and expose coordinate reference system (CRS) and georeferencing information following CF conventions (GitHub issue 59).

## Implementation Approach

Based on analysis of current code and CF conventions requirements:

- **Target**: CF-1.8 compliance with full grid mapping support
- **Coordinate Variables**: Create 1D coordinate variables with bounds and spacing
- **Grid Mapping**: Dedicated grid mapping variable with all CRS parameters
- **Parameter Mapping**: Standard CF names plus original GeoTIFF names for completeness
- **CRS Types**: Prioritize geographic and projected coordinate systems
- **Error Handling**: Graceful degradation for malformed CRS (continue reading raster data)

## Sprint Breakdown

### Sprint 1: CRS Metadata Extraction Foundation
**Duration**: 1 week
**Dependencies**: Existing GeoTIFF handler (v1.5.0)

#### Tasks:
1. **Enhance NC_GEOTIFF_extract_metadata() function**
   - Replace placeholder CRS code with actual extraction logic
   - Implement GTIFDefn parsing and validation
   - Add CRS parameter extraction from libgeotiff

2. **Create CRS helper functions**
   - `extract_crs_parameters()` - Parse GTIFDefn into structured format
   - `map_geotiff_to_cf_attributes()` - Convert GeoTIFF tags to CF attribute names
   - `validate_crs_completeness()` - Check for required CRS parameters

3. **Add CRS data structures**
   - Extend NC_GEOTIFF_FILE_INFO_T with CRS metadata fields
   - Create CRS parameter storage structure
   - Add coordinate system type enumeration

#### Deliverables:
- CRS extraction functions implemented
- Basic CRS parameters available in memory
- Unit tests for CRS extraction logic

### Sprint 2: CF-Compliant Attribute Mapping
**Duration**: 1 week  
**Dependencies**: Sprint 1

#### Tasks:
1. **Implement CF grid mapping variable creation**
   - Create dedicated `crs` variable following CF conventions
   - Add standard CF grid mapping attributes (grid_mapping_name, etc.)
   - Preserve original GeoTIFF parameter names with prefixes

2. **Add coordinate variable support**
   - Create 1D coordinate variables (lon/lat or x/y)
   - Implement coordinate axis identification
   - Add units and standard_name attributes

3. **Global attributes enhancement**
   - Add file-level CRS metadata
   - Include GeoTIFF tag information for traceability
   - Add CF compliance metadata

#### Deliverables:
- CF-compliant grid mapping variable
- Coordinate variables with proper attributes
- Global CRS attributes

### Sprint 3: Advanced CRS Features and Validation
**Duration**: 1 week
**Dependencies**: Sprint 2

#### Tasks:
1. **Support multiple CRS types**
   - Geographic coordinate systems (lat/lon)
   - Projected coordinate systems (UTM, State Plane, etc.)
   - Handle common projections and datums

2. **Coordinate transformation metadata**
   - Add projection parameters
   - Include datum and spheroid information
   - Handle coordinate axis order

3. **Bounds and spacing information**
   - Calculate coordinate bounds from GeoTIFF tie points
   - Add spacing/interval information for regular grids
   - Implement pixel-as-point vs pixel-as-area handling

#### Deliverables:
- Multi-CS type support
- Coordinate transformation metadata
- Bounds and spacing information

### Sprint 4: Testing and Error Handling
**Duration**: 1 week
**Dependencies**: Sprint 3

#### Tasks:
1. **Comprehensive CRS testing**
   - Test with various GeoTIFF files (geographic, projected, different datums)
   - Validate CF compliance of output attributes
   - Test coordinate variable accuracy

2. **Error handling robustness**
   - Graceful degradation for malformed CRS
   - Handle missing or incomplete CRS information
   - Add warning attributes for CRS issues

3. **Performance optimization**
   - Efficient CRS parameter extraction
   - Minimize memory overhead for CRS metadata
   - Optimize attribute creation process

#### Deliverables:
- Comprehensive test suite
- Robust error handling
- Performance-optimized implementation

### Sprint 5: Documentation and Integration
**Duration**: 1 week
**Dependencies**: Sprint 4

#### Tasks:
1. **Update documentation**
   - Add CRS support to design.md
   - Update API documentation
   - Create CF compliance guide

2. **Build system integration**
   - Ensure CRS features work with existing build options
   - Update CI to test CRS functionality
   - Verify compatibility with all platforms

3. **Final validation**
   - End-to-end testing with real-world GeoTIFF files
   - CF conventions validation
   - Performance benchmarking

#### Deliverables:
- Complete documentation updates
- CI integration
- Final validated implementation

## Technical Specifications

### CF-1.8 Grid Mapping Variables
```
crs:grid_mapping_name = "latitude_longitude"
crs:longitude_of_central_meridian = 0.0
crs:latitude_of_projection_origin = 0.0
crs:semi_major_axis = 6378137.0
crs:inverse_flattening = 298.257223563
crs:geotiff_crs_code = 4326
crs:geotiff_cs_code = 4326
```

### Coordinate Variables
```
lon:standard_name = "longitude"
lon:units = "degrees_east"
lon:axis = "X"

lat:standard_name = "latitude"  
lat:units = "degrees_north"
lat:axis = "Y"
```

### Data Variable Attributes
```
data:grid_mapping = "crs"
data:coordinates = "lon lat"
```

## Definition of Done

Each sprint is complete when:
- All tasks implemented and tested
- CF compliance validated
- No regression in existing functionality
- Documentation updated
- CI tests passing

## Risk Mitigation

- **Complex CRS**: Focus on common coordinate systems first
- **CF Compliance**: Use CF checker tools for validation
- **Performance**: Profile CRS extraction overhead
- **Compatibility**: Maintain backward compatibility with existing GeoTIFF files

## Success Criteria

- GeoTIFF files open with full CRS metadata
- CF-1.8 compliant output
- Coordinate variables accurately represent georeferencing
- Graceful handling of malformed CRS
- No performance regression in existing operations
