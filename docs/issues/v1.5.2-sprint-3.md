# v1.5.2 Sprint 3: CDL Output Validation

**Labels:** enhancement, v1.5.2, sprint-3

## Overview

Add automated CDL-based output validation for groups examples (both C and Fortran). Generate reference CDL files and integrate comparison testing into both build systems.

## Tasks

### CDL Reference File Generation

#### Generate Expected Output
- [ ] Run groups.c to create `groups.nc` NetCDF file
- [ ] Run `ncdump groups.nc > groups_expected.cdl`
- [ ] Store `groups_expected.cdl` in `examples/expected_output/`
- [ ] Run f_groups.f90 to create `f_groups.nc` NetCDF file
- [ ] Run `ncdump f_groups.nc > f_groups_expected.cdl`
- [ ] Store `f_groups_expected.cdl` in `examples/expected_output/`

#### Verify CDL Content
- [ ] Verify groups_expected.cdl shows correct group hierarchy
- [ ] Verify all 5 new integer types are present
- [ ] Verify dimensions are correctly defined
- [ ] Verify variables are in correct groups
- [ ] Verify data values are present
- [ ] Verify f_groups_expected.cdl matches groups_expected.cdl structure

### CMake Test Integration

#### Update examples/netcdf-4/CMakeLists.txt
- [ ] Create custom test for groups with CDL validation
- [ ] Test command: run groups → ncdump → compare with expected CDL
- [ ] Use CMake `add_test()` with comparison logic
- [ ] Store generated files in build directory
- [ ] Clean up temporary files after test

#### Update examples/f_netcdf-4/CMakeLists.txt
- [ ] Create custom test for f_groups with CDL validation (conditional on ENABLE_FORTRAN)
- [ ] Test command: run f_groups → ncdump → compare with expected CDL
- [ ] Follow same pattern as C example
- [ ] Conditional test registration when Fortran enabled

#### CMake Test Script
- [ ] Create `examples/validate_groups_cdl.cmake` script
- [ ] Script executes example program
- [ ] Script runs ncdump on output file
- [ ] Script compares ncdump output with expected CDL
- [ ] Script reports differences with clear error messages
- [ ] Script returns non-zero exit code on validation failure

### Autotools Test Integration

#### Update examples/netcdf-4/Makefile.am
- [ ] Create shell script `validate_groups.sh`
- [ ] Add `validate_groups.sh` to TESTS variable
- [ ] Script performs: execute groups → ncdump → compare
- [ ] Use `diff` for CDL comparison
- [ ] Report failures with helpful diagnostics

#### Update examples/f_netcdf-4/Makefile.am
- [ ] Create shell script `validate_f_groups.sh`
- [ ] Add `validate_f_groups.sh` to TESTS variable (conditional on BUILD_FORTRAN)
- [ ] Script performs: execute f_groups → ncdump → compare
- [ ] Follow same pattern as C validation script

#### Shell Script Implementation
- [ ] Create `examples/validate_groups.sh`
  - Execute groups program
  - Run ncdump on output file
  - Compare with expected_output/groups_expected.cdl
  - Exit 0 on match, non-zero on mismatch
  - Print diff output on failure
- [ ] Create `examples/validate_f_groups.sh`
  - Execute f_groups program
  - Run ncdump on output file
  - Compare with expected_output/f_groups_expected.cdl
  - Exit 0 on match, non-zero on mismatch
  - Print diff output on failure
- [ ] Make scripts executable: `chmod +x validate_*.sh`

### Documentation Updates

#### Update examples/README.md
- [ ] Add section on CDL validation for groups examples
- [ ] Explain purpose of regression testing
- [ ] Document how to regenerate expected CDL files
- [ ] Add troubleshooting section for validation failures
- [ ] Example: "If you intentionally change groups.c, regenerate CDL with: `./groups && ncdump groups.nc > expected_output/groups_expected.cdl`"

#### Update Test Documentation
- [ ] Document CDL comparison approach
- [ ] Explain when validation failures occur
- [ ] Provide guidance on updating reference CDL files
- [ ] Note that both C and Fortran examples should produce equivalent structures

### CI Integration

#### Verify CI Execution
- [ ] Confirm examples run as tests when BUILD_EXAMPLES=ON (default)
- [ ] Confirm CDL validation executes in CI pipeline
- [ ] Verify test failures are reported clearly in CI logs
- [ ] No additional CI workflow changes needed (uses existing test infrastructure)

#### Test Matrix Coverage
- [ ] CMake build with examples enabled
- [ ] Autotools build with examples enabled
- [ ] Fortran examples when ENABLE_FORTRAN=ON
- [ ] Fortran examples skipped when ENABLE_FORTRAN=OFF

## Implementation Notes

### CDL Comparison Strategy
```bash
# Basic comparison approach
ncdump groups.nc > groups_actual.cdl
diff groups_actual.cdl expected_output/groups_expected.cdl
if [ $? -ne 0 ]; then
    echo "ERROR: CDL output differs from expected"
    exit 1
fi
```

### CMake Test Example
```cmake
add_test(NAME groups_cdl_validation
    COMMAND ${CMAKE_COMMAND}
        -D TEST_PROGRAM=$<TARGET_FILE:groups>
        -D EXPECTED_CDL=${CMAKE_SOURCE_DIR}/examples/expected_output/groups_expected.cdl
        -D NCDUMP=${NCDUMP_EXECUTABLE}
        -P ${CMAKE_SOURCE_DIR}/examples/validate_groups_cdl.cmake
)
```

### Expected CDL Structure
```cdl
netcdf groups {
group: SubGroup1 {
  dimensions:
  variables:
    ushort ushort_var(y, x) ;
  data:
}
group: SubGroup2 {
  group: NestedGroup {
    dimensions:
      z = 2 ;
    variables:
      int64 int64_var(y, x) ;
      uint64 uint64_var(z, y, x) ;
    data:
  }
}
}
```

## Definition of Done

- [ ] CDL reference files generated for both examples
- [ ] Reference files stored in `examples/expected_output/`
- [ ] CMake CDL validation tests created
- [ ] Autotools CDL validation tests created
- [ ] Shell scripts created and executable
- [ ] Documentation updated with validation approach
- [ ] All tests pass in both build systems
- [ ] CI pipeline passes with CDL validation
- [ ] Clear error messages on validation failures
- [ ] Regeneration process documented

## References

- v1.5.1 Sprint 2: CDL validation implementation patterns
- Existing validation: `examples/validate_cdl.sh`, `examples/expected_output/`
- ncdump documentation: https://docs.unidata.ucar.edu/netcdf-c/current/ncdump.html
- Sprint 1: C groups example (groups.c)
- Sprint 2: Fortran groups example (f_groups.f90)
