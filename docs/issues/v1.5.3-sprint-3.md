# v1.5.3 Sprint 3: CDL Output Validation

**Labels:** enhancement, v1.5.3, sprint-3

## Overview

Generate expected CDL baselines and implement automated validation for quickstart examples. This sprint adds regression testing infrastructure to ensure example outputs remain consistent.

**Detailed Implementation Plan**: `docs/plan/v1.5.3-sprint3-cdl-validation.md`

## Prerequisites

- v1.5.3 Sprint 1 complete (C quickstart working)
- v1.5.3 Sprint 2 complete (Fortran quickstart working)
- ncdump utility available in build environment

## Tasks

### CDL Reference File Generation

#### Generate C Quickstart CDL Baseline
- [ ] Run quickstart program to create quickstart.nc
- [ ] Execute `ncdump quickstart.nc` to generate CDL output
- [ ] Store in `examples/expected_output/quickstart_expected.cdl`
- [ ] Verify CDL is complete and correct

#### Generate Fortran Quickstart CDL Baseline
- [ ] Run f_quickstart program to create f_quickstart.nc
- [ ] Execute `ncdump f_quickstart.nc` to generate CDL output
- [ ] Store in `examples/expected_output/f_quickstart_expected.cdl`
- [ ] Verify output matches C version (except file name)

#### Create expected_output Directory Structure
- [ ] Create `examples/expected_output/` directory if needed
- [ ] Add README.md explaining purpose of CDL files
- [ ] Document that these are regression test baselines
- [ ] Explain when and how to regenerate baselines
- [ ] Add .gitignore for temporary test files

#### Verify CDL File Correctness
- [ ] Manual inspection of both CDL files
- [ ] Verify dimensions: X=2, Y=3
- [ ] Verify variable: int data(X, Y)
- [ ] Verify global attribute: description = "a quickstart example"
- [ ] Verify variable attribute: data:units = "m/s"
- [ ] Verify data values: 1, 2, 3, 4, 5, 6
- [ ] Confirm both files are structurally identical

### CMake Test Integration

#### Create CDL Comparison Test Script
- [ ] Create `examples/test_cdl.sh` shell script
- [ ] Accept three arguments: program path, output file, expected CDL
- [ ] Execute example program
- [ ] Run ncdump on generated NetCDF file
- [ ] Compare ncdump output with expected CDL using diff
- [ ] Exit with 0 on match, non-zero on mismatch
- [ ] Print clear error messages showing differences

#### Update examples/classic/CMakeLists.txt
- [ ] Find ncdump utility using find_program()
- [ ] Add custom test for quickstart with CDL validation
- [ ] Use add_test() with script execution
- [ ] Pass program path, output file, and expected CDL as arguments
- [ ] Test runs in build directory
- [ ] Test only runs when BUILD_EXAMPLES=ON

#### Update examples/f_classic/CMakeLists.txt
- [ ] Add CDL validation for f_quickstart
- [ ] Only add test when ENABLE_FORTRAN=ON
- [ ] Use same test script with different arguments
- [ ] Test runs in build directory

#### Test CMake CDL Validation
- [ ] Run `cmake -DBUILD_EXAMPLES=ON ..` to configure
- [ ] Run `cmake --build .` to build
- [ ] Run `ctest -R quickstart_cdl` to test C version
- [ ] Run `ctest -R f_quickstart_cdl` to test Fortran version
- [ ] Verify both tests pass
- [ ] Verify clear error messages if validation fails

### Autotools Test Integration

#### Create Autotools Test Scripts
- [ ] Create `examples/classic/test_quickstart_cdl.sh`
- [ ] Create `examples/f_classic/test_f_quickstart_cdl.sh`
- [ ] Scripts execute example programs
- [ ] Run ncdump on generated files
- [ ] Compare with expected CDL using diff
- [ ] Exit 0 on success, non-zero on failure
- [ ] Clean up temporary files on success

#### Update examples/classic/Makefile.am
- [ ] Add test_quickstart_cdl.sh to TESTS variable
- [ ] Add script to EXTRA_DIST for distribution
- [ ] Ensure script runs as part of `make check`
- [ ] Make script executable

#### Update examples/f_classic/Makefile.am
- [ ] Add test_f_quickstart_cdl.sh to TESTS (within Fortran conditional)
- [ ] Add script to EXTRA_DIST
- [ ] Ensure script only runs when Fortran enabled
- [ ] Make script executable

#### Update examples/Makefile.am
- [ ] Add expected_output directory to EXTRA_DIST
- [ ] Ensure CDL files are included in distribution
- [ ] Add README.md to distribution

#### Test Autotools CDL Validation
- [ ] Run `./configure --enable-examples` to configure
- [ ] Run `make` to build
- [ ] Run `make check` to execute tests
- [ ] Verify quickstart CDL validation passes
- [ ] Verify f_quickstart CDL validation passes (if Fortran enabled)

### Documentation

#### Create examples/expected_output/README.md
- [ ] Explain purpose of CDL reference files
- [ ] Document that these are regression test baselines
- [ ] Explain CDL validation process
- [ ] Document how to regenerate CDL files
- [ ] Add troubleshooting section for validation failures
- [ ] Explain when regeneration is needed vs when it indicates a bug

#### Update examples/README.md
- [ ] Add section on CDL validation
- [ ] Explain automated output validation
- [ ] Reference expected_output/README.md for details
- [ ] Document that validation runs automatically in test suite
- [ ] Explain purpose of regression testing

#### Add Comments to Test Scripts
- [ ] Add header comments to all test scripts
- [ ] Explain purpose of each script
- [ ] Document expected behavior and exit codes
- [ ] Add usage examples

### CI Integration and Validation

#### Verify ncdump Available in CI
- [ ] Verify ncdump is available in CI environment
- [ ] ncdump should be part of NetCDF-C installation
- [ ] Document ncdump dependency

#### Test CDL Validation in CI
- [ ] Push changes to trigger CI
- [ ] Verify quickstart_cdl test runs in CMake builds
- [ ] Verify f_quickstart_cdl test runs in CMake builds (when Fortran enabled)
- [ ] Verify CDL validation runs in Autotools builds
- [ ] Check CI logs for test execution
- [ ] Verify tests pass

#### Test Failure Scenarios
- [ ] Intentionally modify example to produce different output
- [ ] Verify CDL validation detects the change
- [ ] Verify clear error messages in test output
- [ ] Verify diff output shows actual differences
- [ ] Restore original example

#### Test CDL Regeneration Process
- [ ] Follow documented regeneration process
- [ ] Make intentional change to example
- [ ] Regenerate CDL baseline
- [ ] Verify tests pass with new baseline
- [ ] Document any issues with regeneration process

### Final Validation

#### Cross-Platform Testing
- [ ] Test on Linux (primary CI platform)
- [ ] Verify CDL format is consistent across platforms
- [ ] Verify diff works correctly on all platforms

#### Complete Build Matrix Testing
- [ ] Test CMake with examples ON
- [ ] Test CMake with examples OFF (no CDL tests)
- [ ] Test Autotools with examples enabled
- [ ] Test Autotools with examples disabled (no CDL tests)
- [ ] Test Fortran ON and OFF variants
- [ ] Verify CDL tests only run when appropriate

#### Documentation Review
- [ ] Review all documentation for accuracy
- [ ] Verify regeneration instructions work
- [ ] Check for typos and clarity
- [ ] Ensure troubleshooting section is helpful

## Expected CDL Content

Both examples should produce identical CDL output:

```
netcdf quickstart {  // or f_quickstart
dimensions:
	X = 2 ;
	Y = 3 ;
variables:
	int data(X, Y) ;
		data:units = "m/s" ;

// global attributes:
		:description = "a quickstart example" ;
data:

 data =
  1, 2, 3,
  4, 5, 6 ;
}
```

## Test Script Locations

- **CMake generic script**: `examples/test_cdl.sh`
- **Autotools C script**: `examples/classic/test_quickstart_cdl.sh`
- **Autotools Fortran script**: `examples/f_classic/test_f_quickstart_cdl.sh`
- **Expected CDL files**: `examples/expected_output/*.cdl`
- **Documentation**: `examples/expected_output/README.md`

## Definition of Done

- [ ] CDL reference files generated for both quickstart examples
- [ ] quickstart_expected.cdl stored in examples/expected_output/
- [ ] f_quickstart_expected.cdl stored in examples/expected_output/
- [ ] expected_output/README.md created with comprehensive documentation
- [ ] CMake CDL validation tests implemented for both examples
- [ ] Autotools CDL validation tests implemented for both examples
- [ ] Test scripts created and executable
- [ ] examples/README.md updated with CDL validation section
- [ ] All test scripts have clear documentation
- [ ] CDL validation runs automatically in both build systems
- [ ] Tests pass in CI for both CMake and Autotools
- [ ] Clear error messages on validation failures
- [ ] Temporary files cleaned up after tests
- [ ] Regeneration process documented and tested
- [ ] Troubleshooting guidance provided
- [ ] All build configurations tested and passing
- [ ] Cross-platform compatibility verified

## References

- Detailed plan: `docs/plan/v1.5.3-sprint3-cdl-validation.md`
- v1.5.2 Sprint 3 for CDL validation patterns (groups examples)
- ncdump documentation: https://docs.unidata.ucar.edu/netcdf-c/current/ncdump_guide.html
- CDL format: https://docs.unidata.ucar.edu/netcdf-c/current/netcdf_working_with_netcdf_files.html#cdl_guide
