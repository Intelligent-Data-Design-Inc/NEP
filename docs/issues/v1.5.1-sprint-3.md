# v1.5.1 Sprint 3: Further Development of Examples

**Labels:** enhancement, v1.5.1, sprint-3

**Depends on:** Sprint 1 and Sprint 2 (examples must be integrated with CDL validation)

## Overview
Refactor Fortran example programs to match the structure and output of their C counterparts. This sprint focuses on making `f_simple_2D.f90` structurally similar to `simple_2D.c` and ensuring both programs produce identical NetCDF output that can be validated through CDL comparison.

## Goals
- Simplify Fortran example structure by moving code from subroutines to main program
- Ensure C and Fortran examples produce identical output files
- Maintain code clarity and educational value of examples
- Validate equivalence through automated CDL comparison

## Tasks

### Refactor f_simple_2D.f90 Structure
- [ ] Move code from `handle_err` subroutine into main program body
- [ ] Replace subroutine calls with inline error handling similar to C version
- [ ] Maintain similar program flow to `simple_2D.c`:
  - Write phase: create file, define dimensions/variables, write data, close
  - Read phase: reopen file, verify metadata, verify data, close
- [ ] Keep error handling pattern consistent with C version (print and exit)
- [ ] Preserve all validation checks (metadata and data verification)

### Align Attributes Between C and Fortran Examples
- [ ] Identify all attributes defined in `simple_2D.c`
- [ ] Add equivalent attributes to `f_simple_2D.f90` using Fortran NetCDF API
- [ ] Ensure attribute names, types, and values match exactly
- [ ] Add global attributes if present in C version
- [ ] Add variable attributes if present in C version
- [ ] Use appropriate Fortran NetCDF functions:
  - `nf90_put_att` for defining attributes
  - `nf90_get_att` for reading attributes in validation phase

### Verify Output Equivalence
- [ ] Run both `simple_2D.c` and `f_simple_2D.f90` to generate output files
- [ ] Use `ncdump` to generate CDL for both output files:
  - `ncdump simple_2D.nc > simple_2D.cdl`
  - `ncdump f_simple_2D.nc > f_simple_2D.cdl`
- [ ] Compare CDL outputs using `diff` or text comparison
- [ ] Verify dimensions, variables, attributes, and data are identical
- [ ] Document any acceptable differences (e.g., history attributes with timestamps)

### Update Test Infrastructure
- [ ] Update expected CDL files if output format changes
- [ ] Ensure CDL validation tests pass for both C and Fortran versions
- [ ] Add cross-validation test that compares C and Fortran outputs
- [ ] Document expected equivalence in test documentation

### Documentation Updates
- [ ] Update `examples/README.md` to note C/Fortran output equivalence
- [ ] Document the structural similarities between C and Fortran examples
- [ ] Add notes about attribute definitions in both versions
- [ ] Explain how to verify equivalence using ncdump

## Technical Details

### Current f_simple_2D.f90 Structure
The current Fortran program uses a `contains` section with a `handle_err` subroutine:
```fortran
contains
   subroutine handle_err(status)
      integer, intent(in) :: status
      print *, "Error: ", trim(nf90_strerror(status))
      stop 2
   end subroutine handle_err
end program f_simple_2D
```

### Target Structure (Matching C Version)
Replace subroutine calls with inline error handling:
```fortran
if (retval /= nf90_noerr) then
   print *, "Error: ", trim(nf90_strerror(retval))
   stop 2
end if
```

### Attribute Alignment
Currently, `simple_2D.c` may define attributes such as:
- Global attributes (e.g., title, history, conventions)
- Variable attributes (e.g., units, long_name, valid_range)

The Fortran version must add equivalent attributes using:
```fortran
retval = nf90_put_att(ncid, varid, "units", "count")
retval = nf90_put_att(ncid, varid, "long_name", "Sequential integer data")
```

### CDL Comparison Strategy
1. Generate CDL from both programs' output
2. Compare using `diff -u simple_2D.cdl f_simple_2D.cdl`
3. Acceptable differences:
   - File creation timestamps in history attributes
   - File paths in history attributes
4. All other content must match exactly

## Definition of Done
- [ ] `f_simple_2D.f90` has no subroutines (all code in main program)
- [ ] `f_simple_2D.f90` structure mirrors `simple_2D.c` organization
- [ ] Both programs define identical attributes (names, types, values)
- [ ] CDL output from both programs is identical (except acceptable differences)
- [ ] Automated tests validate output equivalence
- [ ] Documentation updated to reflect changes
- [ ] CI passes with updated examples and tests

## Success Criteria
- Running `ncdump simple_2D.nc` and `ncdump f_simple_2D.nc` produces equivalent CDL
- All attribute names, types, and values match between C and Fortran versions
- Code structure is similar enough that readers can easily compare implementations
- Tests automatically verify C/Fortran output equivalence

## Notes
- This sprint focuses only on `f_simple_2D.f90` and `simple_2D.c`
- Other Fortran examples may be updated in future sprints if needed
- The goal is educational: users should see equivalent implementations in C and Fortran
- Maintain code readability - don't sacrifice clarity for exact structural matching

## Related Files
- C version: `examples/classic/simple_2D.c`
- Fortran version: `examples/f_classic/f_simple_2D.f90`
- Expected CDL: `examples/expected_output/simple_2D_expected.cdl`
- Expected CDL: `examples/expected_output/f_simple_2D_expected.cdl`
- Roadmap: `docs/roadmap.md` v1.5.1 Sprint 3 section
