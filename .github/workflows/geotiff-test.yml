# GitHub Actions CI workflow for testing GeoTIFF library detection
#
# NEP GeoTIFF Test Pipeline - v1.5.0 Configuration
#
# This workflow tests GeoTIFF library detection in both CMake and Autotools build systems.
# It installs libgeotiff and libtiff, then verifies that both build systems can detect
# and configure with these libraries.
#
# Edward Hartnett, Intelligent Data Design, Inc., Dec 26, 2025
name: geotiff_test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  geotiff-detection:
    name: GeoTIFF Detection (${{ matrix.build_system }})
    runs-on: ubuntu-latest
    env:
      LD_LIBRARY_PATH: $GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$LD_LIBRARY_PATH
    strategy:
      fail-fast: false
      matrix:
        build_system: [cmake, autotools]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake make wget zlib1g-dev autoconf automake libtool pkg-config

      - name: Install GeoTIFF and TIFF libraries
        run: |
          sudo apt-get install -y libgeotiff-dev libtiff-dev
          echo "=== Verifying GeoTIFF installation ==="
          pkg-config --modversion libgeotiff || echo "libgeotiff pkg-config not found"
          pkg-config --modversion libtiff-4 || echo "libtiff-4 pkg-config not found"
          pkg-config --cflags libgeotiff || echo "libgeotiff cflags not available"
          pkg-config --libs libgeotiff || echo "libgeotiff libs not available"
          echo "=== Checking for header files ==="
          ls -l /usr/include/geotiff* || echo "geotiff headers not in /usr/include"
          ls -l /usr/include/tiff* || echo "tiff headers not in /usr/include"
          echo "=== Checking for library files ==="
          ls -l /usr/lib/x86_64-linux-gnu/libgeotiff* || echo "libgeotiff not in standard lib path"
          ls -l /usr/lib/x86_64-linux-gnu/libtiff* || echo "libtiff not in standard lib path"

      # Cache HDF5 install
      - name: Cache HDF5 install
        id: cache-hdf5
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/hdf5-install
          key: hdf5-1.14.6-${{ runner.os }}-geotiff-1
      
      - name: Download and build HDF5 1.14.6
        if: steps.cache-hdf5.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1.14.6.tar.gz &> /dev/null
          tar -xzf hdf5-1.14.6.tar.gz
          cd hdf5-hdf5-1.14.6
          mkdir build && cd build
          cmake -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/hdf5-install -DBUILD_SHARED_LIBS=ON -DBUILD_TESTING=OFF ..
          make -j$(nproc)
          make install

      # Cache NetCDF-C install
      - name: Cache NetCDF-C install
        id: cache-netcdf-c
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/netcdf-c-install
          key: netcdf-c-4.9.3-${{ runner.os }}-geotiff-1

      - name: Download and build NetCDF-C
        if: steps.cache-netcdf-c.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/Unidata/netcdf-c/archive/v4.9.3.tar.gz &> /dev/null
          tar -xzf v4.9.3.tar.gz
          cd netcdf-c-4.9.3
          export PATH="$GITHUB_WORKSPACE/hdf5-install/bin:$PATH"
          export CPPFLAGS="-I$GITHUB_WORKSPACE/hdf5-install/include"
          export LDFLAGS="-L$GITHUB_WORKSPACE/hdf5-install/lib"
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$LD_LIBRARY_PATH"
          ./configure --prefix=$GITHUB_WORKSPACE/netcdf-c-install --enable-netcdf-4 --enable-shared
          make -j$(nproc)
          make install

      # --- CMake build with GeoTIFF ---
      - name: Create build directory (CMake)
        if: matrix.build_system == 'cmake'
        run: mkdir -p build

      - name: Configure with CMake and GeoTIFF enabled
        if: matrix.build_system == 'cmake'
        working-directory: build
        run: |
          echo "=== Testing CMake GeoTIFF Detection ==="
          export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH
          cmake .. \
            -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/hdf5-install;$GITHUB_WORKSPACE/netcdf-c-install" \
            -DENABLE_GEOTIFF=ON \
            -DENABLE_FORTRAN=OFF \
            -DBUILD_TESTING=OFF \
            -DBUILD_DOCUMENTATION=OFF
          echo "=== Checking config.h for HAVE_GEOTIFF ==="
          grep -i "HAVE_GEOTIFF" config.h || echo "HAVE_GEOTIFF not found in config.h"
          grep "define HAVE_GEOTIFF" config.h && echo "SUCCESS: HAVE_GEOTIFF is defined" || echo "FAILURE: HAVE_GEOTIFF is not defined"

      - name: Build (CMake)
        if: matrix.build_system == 'cmake'
        working-directory: build
        run: |
          echo "=== Building with CMake and GeoTIFF enabled ==="
          make -j$(nproc)
          echo "=== Build completed successfully ==="

      - name: Test CMake with GeoTIFF disabled (default)
        if: matrix.build_system == 'cmake'
        run: |
          echo "=== Testing CMake with GeoTIFF disabled (default) ==="
          rm -rf build_disabled
          mkdir build_disabled
          cd build_disabled
          cmake .. \
            -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/hdf5-install;$GITHUB_WORKSPACE/netcdf-c-install" \
            -DENABLE_FORTRAN=OFF \
            -DBUILD_TESTING=OFF \
            -DBUILD_DOCUMENTATION=OFF
          echo "=== Checking that HAVE_GEOTIFF is not defined ==="
          if grep "define HAVE_GEOTIFF" config.h; then
            echo "FAILURE: HAVE_GEOTIFF should not be defined when disabled"
            exit 1
          else
            echo "SUCCESS: HAVE_GEOTIFF is not defined (as expected)"
          fi
          make -j$(nproc)
          echo "=== Build with GeoTIFF disabled completed successfully ==="

      # --- Autotools build with GeoTIFF ---
      - name: Bootstrap (Autotools)
        if: matrix.build_system == 'autotools'
        run: |
          autoreconf -fiv

      - name: Configure with Autotools and GeoTIFF enabled
        if: matrix.build_system == 'autotools'
        run: |
          echo "=== Testing Autotools GeoTIFF Detection ==="
          export PATH="$GITHUB_WORKSPACE/hdf5-install/bin:$PATH"
          export CPPFLAGS="-I$GITHUB_WORKSPACE/hdf5-install/include -I$GITHUB_WORKSPACE/netcdf-c-install/include"
          export LDFLAGS="-L$GITHUB_WORKSPACE/hdf5-install/lib -L$GITHUB_WORKSPACE/netcdf-c-install/lib"
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$LD_LIBRARY_PATH"
          ./configure \
            --with-hdf5=$GITHUB_WORKSPACE/hdf5-install/bin/h5cc \
            --enable-geotiff \
            --disable-fortran \
            --disable-lz4 \
            --disable-docs \
            || (echo "Configure failed. Printing config.log:"; cat config.log; exit 1)
          echo "=== Checking config.h for HAVE_GEOTIFF ==="
          grep -i "HAVE_GEOTIFF" config.h || echo "HAVE_GEOTIFF not found in config.h"
          grep "define HAVE_GEOTIFF" config.h && echo "SUCCESS: HAVE_GEOTIFF is defined" || echo "FAILURE: HAVE_GEOTIFF is not defined"
          grep "define HAVE_GEOTIFF_H" config.h && echo "SUCCESS: HAVE_GEOTIFF_H is defined" || echo "FAILURE: HAVE_GEOTIFF_H is not defined"
          grep "define HAVE_TIFF_H" config.h && echo "SUCCESS: HAVE_TIFF_H is defined" || echo "FAILURE: HAVE_TIFF_H is not defined"

      - name: Build (Autotools)
        if: matrix.build_system == 'autotools'
        run: |
          echo "=== Building with Autotools and GeoTIFF enabled ==="
          make -j$(nproc)
          echo "=== Build completed successfully ==="

      - name: Test Autotools with GeoTIFF disabled (default)
        if: matrix.build_system == 'autotools'
        run: |
          echo "=== Testing Autotools with GeoTIFF disabled (default) ==="
          make distclean || true
          autoreconf -fiv
          export PATH="$GITHUB_WORKSPACE/hdf5-install/bin:$PATH"
          export CPPFLAGS="-I$GITHUB_WORKSPACE/hdf5-install/include -I$GITHUB_WORKSPACE/netcdf-c-install/include"
          export LDFLAGS="-L$GITHUB_WORKSPACE/hdf5-install/lib -L$GITHUB_WORKSPACE/netcdf-c-install/lib"
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$LD_LIBRARY_PATH"
          ./configure \
            --with-hdf5=$GITHUB_WORKSPACE/hdf5-install/bin/h5cc \
            --disable-fortran \
            --disable-lz4 \
            --disable-docs \
            || (echo "Configure failed. Printing config.log:"; cat config.log; exit 1)
          echo "=== Checking that HAVE_GEOTIFF is not defined ==="
          if grep "define HAVE_GEOTIFF" config.h; then
            echo "FAILURE: HAVE_GEOTIFF should not be defined when disabled"
            exit 1
          else
            echo "SUCCESS: HAVE_GEOTIFF is not defined (as expected)"
          fi
          make -j$(nproc)
          echo "=== Build with GeoTIFF disabled completed successfully ==="

      - name: Run Tests (CMake)
        if: matrix.build_system == 'cmake'
        working-directory: build
        run: |
          echo "=== Running GeoTIFF Tests ==="
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$LD_LIBRARY_PATH"
          ctest --output-on-failure --verbose -R geotiff || true

      - name: Run Tests (Autotools)
        if: matrix.build_system == 'autotools'
        run: |
          echo "=== Running GeoTIFF Tests ==="
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$LD_LIBRARY_PATH"
          cd test_geotiff
          ./tst_geotiff_detect || echo "tst_geotiff_detect failed"
          ./tst_geotiff_handle || echo "tst_geotiff_handle failed"
          ./tst_geotiff_metadata || echo "tst_geotiff_metadata failed"

      - name: Summary
        if: always()
        run: |
          echo "=== GeoTIFF Detection Test Summary ==="
          echo "Build System: ${{ matrix.build_system }}"
          echo "Test completed - check logs above for detailed results"

  geotiff-valgrind:
    name: GeoTIFF Memory Leak Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake make wget zlib1g-dev valgrind libgeotiff-dev libtiff-dev

      - name: Cache HDF5 install
        id: cache-hdf5
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/hdf5-install
          key: hdf5-1.14.6-${{ runner.os }}-geotiff-1
      
      - name: Download and build HDF5 1.14.6
        if: steps.cache-hdf5.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1.14.6.tar.gz &> /dev/null
          tar -xzf hdf5-1.14.6.tar.gz
          cd hdf5-hdf5-1.14.6
          mkdir build && cd build
          cmake -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/hdf5-install -DBUILD_SHARED_LIBS=ON -DBUILD_TESTING=OFF ..
          make -j$(nproc)
          make install

      - name: Cache NetCDF-C install
        id: cache-netcdf-c
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/netcdf-c-install
          key: netcdf-c-4.9.3-${{ runner.os }}-geotiff-1

      - name: Download and build NetCDF-C
        if: steps.cache-netcdf-c.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/Unidata/netcdf-c/archive/v4.9.3.tar.gz &> /dev/null
          tar -xzf v4.9.3.tar.gz
          cd netcdf-c-4.9.3
          export PATH="$GITHUB_WORKSPACE/hdf5-install/bin:$PATH"
          export CPPFLAGS="-I$GITHUB_WORKSPACE/hdf5-install/include"
          export LDFLAGS="-L$GITHUB_WORKSPACE/hdf5-install/lib"
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$LD_LIBRARY_PATH"
          ./configure --prefix=$GITHUB_WORKSPACE/netcdf-c-install --enable-netcdf-4 --enable-shared
          make -j$(nproc)
          make install

      - name: Create valgrind suppression file
        run: |
          cat > valgrind.supp << 'EOF'
          # Suppress known issues in third-party libraries
          {
             hdf5_known_leak
             Memcheck:Leak
             ...
             obj:*/libhdf5.so*
          }
          {
             netcdf_known_leak
             Memcheck:Leak
             ...
             obj:*/libnetcdf.so*
          }
          {
             tiff_known_leak
             Memcheck:Leak
             ...
             obj:*/libtiff.so*
          }
          {
             geotiff_known_leak
             Memcheck:Leak
             ...
             obj:*/libgeotiff.so*
          }
          EOF

      - name: Build with CMake
        run: |
          mkdir build && cd build
          cmake .. \
            -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/hdf5-install;$GITHUB_WORKSPACE/netcdf-c-install" \
            -DENABLE_GEOTIFF=ON \
            -DENABLE_FORTRAN=OFF \
            -DBUILD_TESTING=ON \
            -DBUILD_DOCUMENTATION=OFF
          make -j$(nproc)

      - name: Run tests under Valgrind
        run: |
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$LD_LIBRARY_PATH"
          cd build/test_geotiff
          # Copy test data to build directory
          cp -r ../../test_geotiff/data .
          cp -r ../../test/data ../../test_geotiff/
          echo "=== Running tst_geotiff_detect under Valgrind ==="
          valgrind --leak-check=full --show-leak-kinds=all --track-fds=yes \
            --suppressions=../../valgrind.supp --error-exitcode=1 \
            ./tst_geotiff_detect 2>&1 | tee valgrind_detect.log
          
          echo "=== Running tst_geotiff_handle under Valgrind ==="
          valgrind --leak-check=full --show-leak-kinds=all --track-fds=yes \
            --suppressions=../../valgrind.supp --error-exitcode=1 \
            ./tst_geotiff_handle 2>&1 | tee valgrind_handle.log
          
          echo "=== Running tst_geotiff_metadata under Valgrind ==="
          valgrind --leak-check=full --show-leak-kinds=all --track-fds=yes \
            --suppressions=../../valgrind.supp --error-exitcode=1 \
            ./tst_geotiff_metadata 2>&1 | tee valgrind_metadata.log

      - name: Check for memory leaks
        run: |
          cd build/test_geotiff
          echo "=== Checking Valgrind Results ==="
          for log in valgrind_*.log; do
            echo "Checking $log..."
            if grep -q "definitely lost: 0 bytes in 0 blocks" "$log" && \
               grep -q "indirectly lost: 0 bytes in 0 blocks" "$log"; then
              echo "✓ No memory leaks in $log"
            else
              echo "✗ Memory leaks detected in $log"
              cat "$log"
              exit 1
            fi
          done
          echo "=== All Valgrind checks passed ==="

      - name: Upload Valgrind reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: valgrind-reports
          path: build/test_geotiff/valgrind_*.log

  geotiff-coverage:
    name: GeoTIFF Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake make wget zlib1g-dev lcov libgeotiff-dev libtiff-dev

      - name: Cache HDF5 install
        id: cache-hdf5
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/hdf5-install
          key: hdf5-1.14.6-${{ runner.os }}-geotiff-1
      
      - name: Download and build HDF5 1.14.6
        if: steps.cache-hdf5.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1.14.6.tar.gz &> /dev/null
          tar -xzf hdf5-1.14.6.tar.gz
          cd hdf5-hdf5-1.14.6
          mkdir build && cd build
          cmake -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/hdf5-install -DBUILD_SHARED_LIBS=ON -DBUILD_TESTING=OFF ..
          make -j$(nproc)
          make install

      - name: Cache NetCDF-C install
        id: cache-netcdf-c
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/netcdf-c-install
          key: netcdf-c-4.9.3-${{ runner.os }}-geotiff-1

      - name: Download and build NetCDF-C
        if: steps.cache-netcdf-c.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/Unidata/netcdf-c/archive/v4.9.3.tar.gz &> /dev/null
          tar -xzf v4.9.3.tar.gz
          cd netcdf-c-4.9.3
          export PATH="$GITHUB_WORKSPACE/hdf5-install/bin:$PATH"
          export CPPFLAGS="-I$GITHUB_WORKSPACE/hdf5-install/include"
          export LDFLAGS="-L$GITHUB_WORKSPACE/hdf5-install/lib"
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$LD_LIBRARY_PATH"
          ./configure --prefix=$GITHUB_WORKSPACE/netcdf-c-install --enable-netcdf-4 --enable-shared
          make -j$(nproc)
          make install

      - name: Build with coverage instrumentation
        run: |
          mkdir build && cd build
          cmake .. \
            -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/hdf5-install;$GITHUB_WORKSPACE/netcdf-c-install" \
            -DENABLE_GEOTIFF=ON \
            -DENABLE_FORTRAN=OFF \
            -DBUILD_TESTING=ON \
            -DBUILD_DOCUMENTATION=OFF \
            -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage"
          make -j$(nproc)

      - name: Run tests to generate coverage data
        run: |
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$LD_LIBRARY_PATH"
          cd build/test_geotiff
          # Copy test data to build directory
          cp -r ../../test_geotiff/data .
          cp -r ../../test/data ../../test_geotiff/
          ./tst_geotiff_detect
          ./tst_geotiff_handle
          ./tst_geotiff_metadata

      - name: Generate coverage report
        run: |
          cd build
          lcov --capture --directory . --output-file coverage.info
          lcov --remove coverage.info '/usr/*' '*/test_geotiff/*' '*/hdf5_plugins/*' --output-file coverage_filtered.info
          lcov --list coverage_filtered.info
          genhtml coverage_filtered.info --output-directory coverage_html

      - name: Check coverage threshold
        run: |
          cd build
          COVERAGE=$(lcov --summary coverage_filtered.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
          echo "Code coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "⚠️  Warning: Coverage is below 80% threshold"
          else
            echo "✓ Coverage meets 80% threshold"
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/coverage_html
