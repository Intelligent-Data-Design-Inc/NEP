# GitHub Actions CI workflow for building and testing the project
# This workflow sets up an Ubuntu environment, installs MPI and CMake,
# and runs the build and test commands as specified in the project documentation.
#
# Build command:
#   CC=mpicc cmake .. -DCMAKE_PREFIX_PATH=/home/ed/Downloads/hdf5-1.14.5
#
# The workflow will also run `make` and `make test`.
#
# NOTE: If /home/ed/Downloads/hdf5-1.14.5 is not available in the CI runner,
# you may need to upload it as an artifact or install HDF5 via apt or another method.

name: ci_main

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        build_system: [cmake, autotools]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mpich cmake make wget doxygen graphviz

      - name: Cache HDF5 install
        id: cache-hdf5
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/hdf5-install
          key: hdf5-1.14.5-${{ runner.os }}-1
      
      - name: Download and build HDF5 1.14.5
        if: steps.cache-hdf5.outputs.cache-hit != 'true'
        id: build-hdf5
        run: |
          wget https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1.14.5.tar.gz &> /dev/null
          tar -xzf hdf5-1.14.5.tar.gz
          ls -l
          cd hdf5-hdf5-1.14.5
          mkdir build && cd build
          cmake -DHDF5_ENABLE_PARALLEL=ON -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/hdf5-install -DBUILD_SHARED_LIBS=ON -DHDF5_BUILD_CPP_LIB=ON ..
          make -j$(nproc)
          make install

            # --- CMake build ---------------------------------------------------
      - name: Create build directory (CMake)
        if: matrix.build_system == 'cmake'
        run: mkdir -p build

      - name: Configure with CMake and custom HDF5
        if: matrix.build_system == 'cmake'
        working-directory: build
        run: |
          CC=mpicc cmake .. -DCMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/hdf5-install

      - name: Build (CMake)
        if: matrix.build_system == 'cmake'
        working-directory: build
        run: make -j$(nproc)

      - name: Test (CTest)
        if: matrix.build_system == 'cmake'
        working-directory: build
        run: make test

      # --- Autotools build ---------------------------------------------
      - name: Bootstrap (Autotools)
        if: matrix.build_system == 'autotools'
        run: |
          ./bootstrap || true

      - name: Configure (Autotools)
        if: matrix.build_system == 'autotools'
        run: |
          autoreconf -i
          export CPPFLAGS=-I$GITHUB_WORKSPACE/hdf5-install/include
          export LDFLAGS=-L$GITHUB_WORKSPACE/hdf5-install/lib
          ls -l $GITHUB_WORKSPACE/hdf5-install
          ls -l $GITHUB_WORKSPACE/hdf5-install/bin
          ./configure --with-hdf5=$GITHUB_WORKSPACE/hdf5-install/bin 

      - name: Build (Autotools)
        if: matrix.build_system == 'autotools'
        run: make -j$(nproc)

      - name: Test (make check)
        if: matrix.build_system == 'autotools'
        run: make check

# If you need to use a custom HDF5 build, consider uploading it as an artifact or adjusting the CMAKE_PREFIX_PATH accordingly.
# Documentation last updated: 2025-07-05
