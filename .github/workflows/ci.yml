# GitHub Actions CI workflow for building and testing the NFEP project with cmake and autotools.
#
# Edward Hartnett 8/28/25
name: ci_main

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JASPER_INSTALL_PREFIX: ${{ github.workspace }}/jasper-install
      HDF5_PLUGIN_PATH: ${{ github.workspace }}/netcdf-c-install/hdf5/lib/plugin
      LD_LIBRARY_PATH: $JASPER_INSTALL_PREFIX/lib:$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/g2c-install/lib:$GITHUB_WORKSPACE/cdf-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$GITHUB_WORKSPACE/netcdf-fortran-install/lib:$LD_LIBRARY_PATH
    strategy:
      fail-fast: false
      matrix:
        build_system: [cmake, autotools]
        doc_build: [enabled, disabled]
        vol_config:
          - name: "all_enabled"
            cmake_flags: "-DENABLE_GRIB2=ON -DENABLE_LZ4=ON"
            autotools_flags: "--enable-grib2 --enable-lz4"
          - name: "grib2_only"
            cmake_flags: "-DENABLE_GRIB2=ON -DLZ4=OFF"
            autotools_flags: "--enable-grib2 --disable-lz4"
          - name: "lz4_only"
            cmake_flags: "-DENABLE_GRIB2=OFF -DENABLE_LZ4=ON"
            autotools_flags: "--disable-grib2 --enable-lz4"
        exclude:
          # Reduce matrix size by only testing documentation with all_enabled configuration
          - vol_config: { name: "all_enabled" }
            doc_build: enabled
          - vol_config: { name: "grib2_only" }
            doc_build: disabled
          - vol_config: { name: "lz4_only" }
            doc_build: disabled
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get install -y cmake make wget doxygen graphviz zlib1g-dev libpng-dev libaec-dev libjpeg-dev liblz4-dev wget libbz2-dev libjpeg-dev liblzf-dev
          sudo apt-get install -y libgeotiff-dev

      - name: Cache Jasper install
        id: cache-jasper
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/jasper-install
          key: jasper-4.2.5-${{ runner.os }}-1

      - name: Download and build Jasper 4.2.5
        if: steps.cache-jasper.outputs.cache-hit != 'true'
        run: |
          JASPER_VERSION=4.2.5
          JASPER_URL="https://github.com/jasper-software/jasper/releases/download/version-${JASPER_VERSION}/jasper-${JASPER_VERSION}.tar.gz"

          wget -q "$JASPER_URL" -O jasper.tar.gz
          tar -xzf jasper.tar.gz
          cd jasper-${JASPER_VERSION}
          mkdir ../build_jasper && cd ../build_jasper
          cmake -DCMAKE_INSTALL_PREFIX="$JASPER_INSTALL_PREFIX" -DBUILD_SHARED_LIBS=ON ../jasper-${JASPER_VERSION} -DBUILD_TESTING=OFF 
          make -j$(nproc)
          make install

      - name: Cache HDF5 install
        id: cache-hdf5
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/hdf5-install
          key: hdf5-1.14.6-${{ runner.os }}-3
      
      - name: Download and build HDF5 1.14.6
        if: steps.cache-hdf5.outputs.cache-hit != 'true'
        id: build-hdf5
        run: |
          wget https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1.14.6.tar.gz &> /dev/null
          tar -xzf hdf5-1.14.6.tar.gz
          ls -l
          cd hdf5-hdf5-1.14.6
          mkdir build && cd build
          cmake -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/hdf5-install -DBUILD_SHARED_LIBS=ON -DBUILD_TESTING=OFF ..
          make -j$(nproc)
          make install

            # Cache g2c install
      - name: Cache g2c install
        id: cache-g2c
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/g2c-install
          key: g2c-latest-${{ runner.os }}-2

      - name: Download and build g2c (latest release)
        if: steps.cache-g2c.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/NOAA-EMC/NCEPLIBS-g2c/archive/refs/tags/v2.1.0.tar.gz -O g2c.tar.gz &> /dev/null
          tar -xzf g2c.tar.gz
          cd NCEPLIBS-g2c-2.1.0
          mkdir build && cd build
          echo $JASPER_INSTALL_PREFIX
          ls -l $JASPER_INSTALL_PREFIX
          cmake .. -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/g2c-install -DBUILD_SHARED_LIBS=ON -DCMAKE_PREFIX_PATH="$JASPER_INSTALL_PREFIX" -DBUILD_TESTING=OFF 
          make -j$(nproc)
          make install

      # Cache NASA CDF install
      - name: Cache NASA CDF install
        id: cache-cdf
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/cdf-install
          key: cdf-39_1-${{ runner.os }}-1

      - name: Download and build NASA CDF
        if: steps.cache-cdf.outputs.cache-hit != 'true'
        run: |
          wget https://spdf.gsfc.nasa.gov/pub/software/cdf/dist/latest/cdf39_1-dist-all.tar.gz -O cdf.tar.gz &> /dev/null
          tar -xzf cdf.tar.gz
          cd cdf39_1-dist
          make OS=linux ENV=gnu CURSES=yes FORTRAN=no UCOPTIONS=-O2 SHARED=yes all
          make INSTALLDIR=$GITHUB_WORKSPACE/cdf-install install

      # Cache NetCDF-C install
      - name: Cache NetCDF-C install
        id: cache-netcdf-c
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/netcdf-c-install
          key: netcdf-c-4.9.3-${{ runner.os }}-1

      - name: Download and build NetCDF-C
        if: steps.cache-netcdf-c.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/Unidata/netcdf-c/archive/v4.9.3.tar.gz &> /dev/null
          tar -xzf v4.9.3.tar.gz
          cd netcdf-c-4.9.3
          export PATH="$GITHUB_WORKSPACE/hdf5-install/bin:$PATH"
          export CPPFLAGS="-I$GITHUB_WORKSPACE/hdf5-install/include"
          export LDFLAGS="-L$GITHUB_WORKSPACE/hdf5-install/lib"
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$LD_LIBRARY_PATH"
          ./configure --prefix=$GITHUB_WORKSPACE/netcdf-c-install --enable-netcdf-4 --enable-shared
          make -j$(nproc)
          make install

      - name: Download and build hdf5_plugins
        if: steps.cache-netcdf-c.outputs.cache-hit != 'true'
        run: |
          export HDF5_PLUGIN_PATH=$GITHUB_WORKSPACE/netcdf-c-install/hdf5/lib/plugin
          export PATH="$GITHUB_WORKSPACE/hdf5-install/bin:$PATH"
          export CPPFLAGS="-I$GITHUB_WORKSPACE/hdf5-install/include -I/usr/include/liblzf"
          export LDFLAGS="-L$GITHUB_WORKSPACE/hdf5-install/lib"
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$LD_LIBRARY_PATH"
          # Clone and build hdf5_plugins
          rm -rf hdf5_plugins
          git clone https://github.com/captainkirk99/hdf5_plugins hdf5_plugins
          pushd hdf5_plugins
          git checkout e1
          autoreconf -i
          ./configure --with-hdf5-plugin-path=$HDF5_PLUGIN_PATH --prefix=$GITHUB_WORKSPACE/netcdf-c-install 
          make 
          make install
          ls -l $GITHUB_WORKSPACE/netcdf-c-install
          ls -l $HDF5_PLUGIN_PATH
          popd

      # Cache NetCDF-Fortran install
      - name: Cache NetCDF-Fortran install
        id: cache-netcdf-fortran
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/netcdf-fortran-install
          key: netcdf-fortran-4.5.4-${{ runner.os }}-1

      - name: Download and build NetCDF-Fortran
        if: steps.cache-netcdf-fortran.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/Unidata/netcdf-fortran/archive/v4.5.4.tar.gz &> /dev/null
          tar -xzf v4.5.4.tar.gz
          cd netcdf-fortran-4.5.4
          export PATH="$GITHUB_WORKSPACE/hdf5-install/bin:$GITHUB_WORKSPACE/netcdf-c-install/bin:$PATH"
          export CPPFLAGS="-I$GITHUB_WORKSPACE/hdf5-install/include -I$GITHUB_WORKSPACE/netcdf-c-install/include"
          export LDFLAGS="-L$GITHUB_WORKSPACE/hdf5-install/lib -L$GITHUB_WORKSPACE/netcdf-c-install/lib"
          export LD_LIBRARY_PATH="$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$LD_LIBRARY_PATH"
          ./configure --prefix=$GITHUB_WORKSPACE/netcdf-fortran-install
          make -j$(nproc)
          make install

            # --- CMake build ---------------------------------------------------
      - name: Create build directory (CMake)
        if: matrix.build_system == 'cmake'
        run: mkdir -p build

      - name: Configure with CMake and custom HDF5
        if: matrix.build_system == 'cmake'
        working-directory: build
        env:
          JASPER_INSTALL_PREFIX: $GITHUB_WORKSPACE/jasper-install
        run: |
          echo "Building with VOL configuration: ${{ matrix.vol_config.name }}"
          DOC_FLAG=""
          if [ "${{ matrix.doc_build }}" = "enabled" ]; then
            DOC_FLAG="-DBUILD_DOCUMENTATION=ON"
          else
            DOC_FLAG="-DBUILD_DOCUMENTATION=OFF"
          fi
          cmake .. -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/hdf5-install;$GITHUB_WORKSPACE/g2c-install;$GITHUB_WORKSPACE/cdf-install;$GITHUB_WORKSPACE/netcdf-c-install;$GITHUB_WORKSPACE/netcdf-fortran-install;$JASPER_INSTALL_PREFIX;/usr/include/geotiff;/usr/include/liblzf" ${{ matrix.vol_config.cmake_flags }} $DOC_FLAG

      - name: Build (CMake)
        if: matrix.build_system == 'cmake'
        working-directory: build
        run: |
          set -x
          pwd
          ls -l
          echo "Building with CMake..."
          export PATH=$GITHUB_WORKSPACE/hdf5-install/bin:$PATH
          export HDF5_PLUGIN_PATH=$GITHUB_WORKSPACE/netcdf-c-install/hdf5/lib/plugin
          export LD_LIBRARY_PATH=$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$GITHUB_WORKSPACE/netcdf-fortran-install/lib:$LD_LIBRARY_PATH
          make -j$(nproc)

      - name: Build Documentation (CMake)
        if: matrix.build_system == 'cmake' && matrix.doc_build == 'enabled'
        working-directory: build
        run: |
          set -x
          pwd
          ls -l
          echo "Building documentation with CMake..."
          make docs 2>&1 | tee doc_build.log
          # Check for warnings in documentation build
          if grep -i "warning" doc_build.log; then
            echo "Documentation build contains warnings - failing build"
            exit 1
          fi
          echo "Documentation built successfully without warnings"

      - name: Test (CTest)
        if: matrix.build_system == 'cmake'
        working-directory: build
        run: |
          export PATH="$GITHUB_WORKSPACE/hdf5-install/bin:$PATH"
          export HDF5_PLUGIN_PATH="$GITHUB_WORKSPACE/netcdf-c-install/hdf5/lib/plugin"
          export CPPFLAGS="-I$GITHUB_WORKSPACE/hdf5-install/include -I$GITHUB_WORKSPACE/g2c-install/include -I$GITHUB_WORKSPACE/cdf-install/include -I$GITHUB_WORKSPACE/netcdf-c-install/include -I$GITHUB_WORKSPACE/netcdf-fortran-install/include -I/usr/include/geotiff -I/usr/include/liblzf""
          export LDFLAGS="-L$GITHUB_WORKSPACE/hdf5-install/lib -L$GITHUB_WORKSPACE/g2c-install/lib -L$GITHUB_WORKSPACE/cdf-install/lib -L$GITHUB_WORKSPACE/netcdf-c-install/lib -L$GITHUB_WORKSPACE/netcdf-fortran-install/lib -L$JASPER_INSTALL_PREFIX/lib"
          export LD_LIBRARY_PATH="$JASPER_INSTALL_PREFIX/lib:$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/g2c-install/lib:$GITHUB_WORKSPACE/cdf-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$GITHUB_WORKSPACE/netcdf-fortran-install/lib:$LD_LIBRARY_PATH"
          ctest --verbose
          sudo make install

      - name: Upload Documentation Artifacts (CMake)
        if: matrix.build_system == 'cmake' && matrix.doc_build == 'enabled'
        uses: actions/upload-artifact@v4
        with:
          name: documentation-cmake-${{ matrix.vol_config.name }}
          path: build/docs/html/
          retention-days: 30

      # --- Autotools build ---------------------------------------------
      - name: Bootstrap (Autotools)
        if: matrix.build_system == 'autotools'
        run: |
          ./bootstrap || true

      - name: Configure (Autotools)
        if: matrix.build_system == 'autotools'
        run: |
          set -x
          echo "Building with VOL configuration: ${{ matrix.vol_config.name }}"
          find /usr -name '*geotiff*'
          autoreconf -i
          export PATH="$GITHUB_WORKSPACE/hdf5-install/bin:$PATH"
          export HDF5_PLUGIN_PATH="$GITHUB_WORKSPACE/netcdf-c-install/hdf5/lib/plugin"
          export CPPFLAGS="-I$GITHUB_WORKSPACE/hdf5-install/include -I$GITHUB_WORKSPACE/g2c-install/include -I$GITHUB_WORKSPACE/cdf-install/include -I$GITHUB_WORKSPACE/netcdf-c-install/include -I$GITHUB_WORKSPACE/netcdf-fortran-install/include -I/usr/include/geotiff"
          export LDFLAGS="-L$GITHUB_WORKSPACE/hdf5-install/lib -L$GITHUB_WORKSPACE/g2c-install/lib -L$GITHUB_WORKSPACE/cdf-install/lib -L$GITHUB_WORKSPACE/netcdf-c-install/lib -L$GITHUB_WORKSPACE/netcdf-fortran-install/lib -L$JASPER_INSTALL_PREFIX/lib"
          export LD_LIBRARY_PATH="$JASPER_INSTALL_PREFIX/lib:$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/g2c-install/lib:$GITHUB_WORKSPACE/cdf-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$GITHUB_WORKSPACE/netcdf-fortran-install/lib:$LD_LIBRARY_PATH"
          ls -l $GITHUB_WORKSPACE/hdf5-install/lib
          DOC_FLAG=""
          if [ "${{ matrix.doc_build }}" = "enabled" ]; then
            DOC_FLAG="--enable-docs"
          else
            DOC_FLAG="--disable-docs"
          fi
          ./configure --with-hdf5=$GITHUB_WORKSPACE/hdf5-install/bin/h5cc ${{ matrix.vol_config.autotools_flags }} $DOC_FLAG || (echo "Configure failed. Printing config.log:"; cat config.log; echo "hdf5_plugins/config.log:"; cat hdf5_plugins/config.log; exit 1)

      - name: Build (Autotools)
        if: matrix.build_system == 'autotools'
        run: make -j$(nproc)

      - name: Build Documentation (Autotools)
        if: matrix.build_system == 'autotools' && matrix.doc_build == 'enabled'
        run: |
          set -x
          echo "Building documentation with Autotools..."
          pwd
          make docs 2>&1 | tee doc_build.log
          # Check for warnings in documentation build
          if grep -i "warning" doc_build.log; then
            echo "Documentation build contains warnings - failing build"
            exit 1
          fi
          echo "Documentation built successfully without warnings"

      - name: Test (Autotools)
        if: matrix.build_system == 'autotools'
        run: |
          set -x
          export PATH="$GITHUB_WORKSPACE/hdf5-install/bin:$PATH"
          export HDF5_PLUGIN_PATH="$GITHUB_WORKSPACE/netcdf-c-install/hdf5/lib/plugin"
          export CPPFLAGS="-I$GITHUB_WORKSPACE/hdf5-install/include -I$GITHUB_WORKSPACE/g2c-install/include -I$GITHUB_WORKSPACE/cdf-install/include -I$GITHUB_WORKSPACE/netcdf-c-install/include -I$GITHUB_WORKSPACE/netcdf-fortran-install/include -I/usr/include/geotiff -I/usr/include/liblzf""
          export LDFLAGS="-L$GITHUB_WORKSPACE/hdf5-install/lib -L$GITHUB_WORKSPACE/g2c-install/lib -L$GITHUB_WORKSPACE/cdf-install/lib -L$GITHUB_WORKSPACE/netcdf-c-install/lib -L$GITHUB_WORKSPACE/netcdf-fortran-install/lib -L$JASPER_INSTALL_PREFIX/lib"
          export LD_LIBRARY_PATH="$JASPER_INSTALL_PREFIX/lib:$GITHUB_WORKSPACE/hdf5-install/lib:$GITHUB_WORKSPACE/g2c-install/lib:$GITHUB_WORKSPACE/cdf-install/lib:$GITHUB_WORKSPACE/netcdf-c-install/lib:$GITHUB_WORKSPACE/netcdf-fortran-install/lib:$LD_LIBRARY_PATH"
          ls -l "${HDF5_PLUGIN_PATH}"
          make VERBOSE=1 check
          sudo make install

      - name: Upload Documentation Artifacts (Autotools)
        if: matrix.build_system == 'autotools' && matrix.doc_build == 'enabled'
        uses: actions/upload-artifact@v4
        with:
          name: documentation-autotools-${{ matrix.vol_config.name }}
          path: docs/html/
          retention-days: 30

